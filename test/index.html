<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tabulator Starter - Vanilla JS</title>
  <!-- Tabulator CSS/JS（CDN）-->
  <link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>

  <style>
    :root{
      --ink:#1f2937;         /* 文字色 */
      --bg:#ffffff;          /* 背景 */
      --grid:#e5e7eb;        /* 罫線 */
      --accent:#3b82f6;      /* 選択などのアクセント */
      --hover:#f3f4f6;       /* hover背景 */
      --danger:#ef4444;      /* 削除系 */
      --ok:#10b981;          /* 追加系 */
    }
    html{ -webkit-text-size-adjust:100%; }
    body{ margin:0; font-family:system-ui, -apple-system, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; color:var(--ink); background:#f6f7f9; }

    .wrap{ max-width:1200px; margin:24px auto; padding:16px; background:var(--bg); border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); }

    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .toolbar .sp{ flex:1 1 auto; }
    .toolbar button, .toolbar select{
      border:1px solid var(--grid); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .toolbar button:hover{ background:var(--hover); }
    .toolbar .primary{ border-color:var(--accent); }

    /* Tabulator 全体の軽い HOT 風味 */
    .tabulator{ border:1px solid var(--grid); border-radius:12px; }
    .tabulator .tabulator-header{ border-bottom:1px solid var(--grid); }
    .tabulator-col, .tabulator-cell{ border-right:1px solid var(--grid); }
    .tabulator-row:hover{ background:var(--hover); }

    /* 範囲選択（selectableRange）を見やすく */
    .tabulator-cell.tabulator-range-selected{ outline:2px solid var(--accent); outline-offset:-2px; }

    /* IME 入力中の見た目（編集中セル） */
    .tabulator-editing{ box-shadow:inset 0 0 0 2px var(--accent); }

    /* 右クリックメニュー（簡易） */
    .ctx{
      position:fixed; inset:auto auto 0 0; /* 初期化用 */
      z-index:9999; background:#fff; border:1px solid var(--grid); border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.12); min-width:180px; display:none;
    }
    .ctx ul{ list-style:none; margin:0; padding:6px; }
    .ctx li{ padding:8px 10px; border-radius:8px; cursor:pointer; }
    .ctx li:hover{ background:var(--hover); }
    .ctx li.danger{ color:#b91c1c; }

    /* スマホでのフォーカス時のズーム抑制 */
    input, textarea, select{ font-size:16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 8px; font-size:20px;">Tabulator スターター（Vanilla JS / 範囲選択 / 右クリック / 仮想スクロール）</h1>

    <div class="toolbar">
      <button id="addRowBtn" class="primary">＋ 行追加</button>
      <button id="delSelBtn">選択行を削除</button>
      <button id="clearRangeBtn">選択範囲をクリア</button>
      <button id="copyBtn">コピー（選択範囲）</button>
      <button id="pasteBtn">貼り付け（範囲）</button>
      <div class="sp"></div>
      <select id="sizeSel" title="テーブル高さ">
        <option value="420">高さ 420px</option>
        <option value="600" selected>高さ 600px</option>
        <option value="800">高さ 800px</option>
      </select>
      <button id="downloadCsv">CSV ダウンロード</button>
    </div>

    <div id="grid"></div>
  </div>

  <!-- 右クリック簡易メニュー（Tabulator の rowContextMenu/cellContextMenu でもOK。ここでは自作UI例） -->
  <div id="ctx" class="ctx" role="menu" aria-hidden="true">
    <ul>
      <li data-act="insert-row-above">↑ 上に行を挿入</li>
      <li data-act="insert-row-below">↓ 下に行を挿入</li>
      <li data-act="clear-cells">選択セルをクリア</li>
      <li data-act="delete-rows" class="danger">選択行を削除</li>
    </ul>
  </div>

  <script>
    // -----------------------------
    // ① ダミーデータ生成（1万行）
    // -----------------------------
    function randPick(arr){ return arr[(Math.random()*arr.length)|0]; }
    const names = ["佐藤","鈴木","高橋","田中","伊藤","渡辺","山本","中村","小林","加藤"]; 
    const deps  = ["営業","工務","設計","総務","経理","CS","調達"];

    const data = Array.from({length: 10000}, (_,i)=>({
      id:i+1,
      name: randPick(names) + (i%50),
      dept: randPick(deps),
      memo: `メモ ${i+1}`,
      qty: (i*7)%100,
      price: ((i*13)%5000) + 100,
    }));

    // -----------------------------
    // ② カラム定義（編集体験重視）
    // -----------------------------
    const columns = [
      { title:"ID", field:"id", width:80, hozAlign:"right", headerSort:true },
      { title:"氏名", field:"name", editor:"input", headerSort:true },
      { title:"部署", field:"dept", editor:"list", editorParams:{ values: deps } },
      { title:"メモ", field:"memo", editor:"textarea", width:240 },
      { title:"数量", field:"qty", editor:"number", hozAlign:"right", width:100, validator:["numeric"], mutatorEdit:(value)=> Number(value) },
      { title:"単価", field:"price", editor:"number", hozAlign:"right", width:110, formatter:"money", formatterParams:{ precision:0 } },
    ];

    // -----------------------------
    // ③ Tabulator 作成（仮想DOM・範囲選択・クリップボード）
    // -----------------------------
    const gridEl = document.getElementById('grid');
    let table = new Tabulator(gridEl, {
      data,
      columns,
      index:"id",
      height: 600,               // ← 仮想DOM 有効（これ超重要）
      layout:"fitDataStretch",  // 列幅はデータに合わせて伸縮
      reactiveData:false,        // 大量データ時は false が安定
      placeholder:"データなし",

      // 編集体験
      clipboard:true,                    // Ctrl+C/Ctrl+V（単一セル/テキスト）
      clipboardPasteParser:"range",      // 範囲貼り付けを有効に
      clipboardCopyStyled:false,          // スタイルは不要
      selectable:true,                    // 行選択（行操作向け）
      selectableRange:true,               // 範囲選択（セル操作向け）
      selectableRangeColumns:true,        // 列方向の範囲
      selectableRangeRows:true,           // 行方向の範囲
      selectableRangeClearCells:true,     // Delete で範囲クリア

      // 行の見た目（隔行など）
      rowFormatter:function(row){
        if(row.getPosition(true) % 2 === 0){ row.getElement().style.background = '#fafafa'; }
      },

      // キー操作の一例（Enterで次行へ、IME配慮）
      keybindings:{
        navDown:"enter",
        scrollToSelected:true,
      },

      // 右クリック（本家APIでやる場合）：
      // cellContextMenu:[{ label:"上に行を挿入", action:(e,cell)=>{ /* ... */ } }],
    });

    // -----------------------------
    // ④ ツールバー操作
    // -----------------------------
    document.getElementById('addRowBtn').addEventListener('click',()=>{
      const maxId = table.getDataCount() ? Math.max(...table.getData().map(r=>r.id)) : 0;
      table.addRow({ id:maxId+1, name:"新規", dept:"営業", memo:"", qty:0, price:100 }, true);
    });

    document.getElementById('delSelBtn').addEventListener('click',()=>{
      const rows = table.getSelectedRows();
      if(!rows.length) return alert('削除対象の行を選択してください');
      if(!confirm(`${rows.length} 行を削除します。よろしいですか？`)) return;
      rows.forEach(r=>r.delete());
    });

    document.getElementById('clearRangeBtn').addEventListener('click',()=>{
      const ranges = table.getSelectedCells();
      if(!ranges.length) return alert('クリアするセル範囲を選択してください');
      ranges.forEach(cell => cell.setValue(""));
    });

    document.getElementById('copyBtn').addEventListener('click',()=>{
      // 選択範囲がある場合は Tabulator 内部のコピーを使用
      table.copyToClipboard();
    });

    document.getElementById('pasteBtn').addEventListener('click',()=>{
      // ブラウザの貼り付け許可が必要（ユーザー操作からのイベント内）
      table.pasteFromClipboard();
    });

    document.getElementById('sizeSel').addEventListener('change',(e)=>{
      const h = parseInt(e.target.value,10);
      table.setHeight(h);
    });

    document.getElementById('downloadCsv').addEventListener('click',()=>{
      table.download("csv", `tabulator_${new Date().toISOString().slice(0,10)}.csv`, { bom:true });
    });

    // -----------------------------
    // ⑤ 自作：右クリック簡易メニュー（セル＆行）
    // -----------------------------
    const ctx = document.getElementById('ctx');
    let lastContextCell = null;
    let lastContextRow = null;

    gridEl.addEventListener('contextmenu',(ev)=>{
      // Tabulator のセル/行ヒット判定
      const cellComp = table.getCellFromEvent(ev);
      const rowComp = table.getRowFromEvent(ev);
      if(!cellComp && !rowComp){ return; }
      ev.preventDefault();
      lastContextCell = cellComp || null;
      lastContextRow = rowComp || null;

      // 位置＆表示
      const x = ev.clientX, y = ev.clientY;
      ctx.style.left = x + 'px';
      ctx.style.top  = y + 'px';
      ctx.style.display = 'block';
    });

    window.addEventListener('click',()=>{ ctx.style.display='none'; });

    ctx.addEventListener('click',(ev)=>{
      const act = ev.target.closest('li')?.dataset?.act;
      if(!act) return;

      if(act === 'insert-row-above' || act === 'insert-row-below'){
        const base = lastContextRow || (lastContextCell ? lastContextCell.getRow() : null);
        if(!base){ return; }
        const pos = base.getPosition(true);
        const insertAt = act === 'insert-row-above' ? pos : pos+1;
        const maxId = table.getDataCount() ? Math.max(...table.getData().map(r=>r.id)) : 0;
        table.addRow({ id:maxId+1, name:"新規", dept:"営業", memo:"", qty:0, price:100 }, false, insertAt);
        ctx.style.display='none';
        return;
      }

      if(act === 'clear-cells'){
        const cells = table.getSelectedCells();
        if(!cells.length && lastContextCell){ cells.push(lastContextCell); }
        cells.forEach(c=>c.setValue(""));
        ctx.style.display='none';
        return;
      }

      if(act === 'delete-rows'){
        const rows = table.getSelectedRows();
        if(!rows.length && lastContextRow){ rows.push(lastContextRow); }
        if(!rows.length) return;
        if(confirm(`${rows.length} 行を削除します。よろしいですか？`)){
          rows.forEach(r=>r.delete());
        }
        ctx.style.display='none';
        return;
      }
    });

    // -----------------------------
    // ⑥ IME（日本語入力）で Enter が勝手に確定しないように控えめに配慮
    // -----------------------------
    gridEl.addEventListener('keydown',(ev)=>{
      if(ev.isComposing){
        // IME 変換中は Enter キーの行移動などを抑制
        if(ev.key === 'Enter'){ ev.stopPropagation(); }
      }
    }, true);

    // -----------------------------
    // ⑦ クリップボード（複数セル貼り付けサンプル）
    //    Tabulator の range parser を使う設定済み。Excel/GS からの貼り付けで行列が展開されます。
    // -----------------------------

    // 参考：手動で範囲値を書き換えるユーティリティ（必要に応じて）
    function fillSelectedCells(value){
      const cells = table.getSelectedCells();
      cells.forEach(c=>c.setValue(value));
    }
    window.fillSelectedCells = fillSelectedCells; // デバッグ用

  </script>
</body>
</html>
