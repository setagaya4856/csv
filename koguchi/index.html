<script>
window.addEventListener('message', (event) => {
  const fileList = event.data?.fileList;
  if (!Array.isArray(fileList)) return;

  console.log('ğŸ“¦ å—ä¿¡ã—ãŸCSVä¸€è¦§:', fileList);

  const list = document.getElementById('csvList');
  list.innerHTML = '';

  fileList.forEach((f, idx) => {
    const item = document.createElement('div');
    item.style.marginBottom = '10px';
    item.innerHTML = `
      <strong>${f.parsed['ä½å®…å']} ${f.parsed['å·æ£Ÿ']}-${f.parsed['å·å®¤']}</strong><br>
      ${f.parsed['ä¿®ç¹•ç™ºæ³¨äº‹é …']}<br>
      <button data-index="${idx}">åæ˜ </button>
    `;
    item.querySelector('button').onclick = () => {
      window.opener.postMessage({ csv: parseCSV(f.text) }, '*'); // openerã«è¿”ã™
      window.close(); // é–‰ã˜ã¦ã‚‚ã‚ˆã„
    };
    list.appendChild(item);
  });

  // CSVæ–‡å­—åˆ— â†’ 2æ¬¡å…ƒé…åˆ—
  function parseCSV(text) {
    const rows = [];
    let currentRow = [], currentCell = '', insideQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const char = text[i], next = text[i + 1];
      if (char === '"' && insideQuotes && next === '"') { currentCell += '"'; i++; }
      else if (char === '"') { insideQuotes = !insideQuotes; }
      else if (char === ',' && !insideQuotes) { currentRow.push(currentCell); currentCell = ''; }
      else if ((char === '\n' || (char === '\r' && next !== '\n')) && !insideQuotes) {
        currentRow.push(currentCell); rows.push(currentRow); currentCell = ''; currentRow = [];
      } else { currentCell += char; }
    }
    if (currentCell || currentRow.length) { currentRow.push(currentCell); rows.push(currentRow); }
    return rows;
  }
});
</script>

<body>
  <h2>CSVä¸€è¦§</h2>
  <div id="csvList"></div>
</body>
