<script>
window.addEventListener('message', (event) => {
  const fileList = event.data?.fileList;
  if (!Array.isArray(fileList)) return;

  console.log('📦 受信したCSV一覧:', fileList);

  const list = document.getElementById('csvList');
  list.innerHTML = '';

  fileList.forEach((f, idx) => {
    const item = document.createElement('div');
    item.style.marginBottom = '10px';
    item.innerHTML = `
      <strong>${f.parsed['住宅名']} ${f.parsed['号棟']}-${f.parsed['号室']}</strong><br>
      ${f.parsed['修繕発注事項']}<br>
      <button data-index="${idx}">反映</button>
    `;
    item.querySelector('button').onclick = () => {
      window.opener.postMessage({ csv: parseCSV(f.text) }, '*'); // openerに返す
      window.close(); // 閉じてもよい
    };
    list.appendChild(item);
  });

  // CSV文字列 → 2次元配列
  function parseCSV(text) {
    const rows = [];
    let currentRow = [], currentCell = '', insideQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const char = text[i], next = text[i + 1];
      if (char === '"' && insideQuotes && next === '"') { currentCell += '"'; i++; }
      else if (char === '"') { insideQuotes = !insideQuotes; }
      else if (char === ',' && !insideQuotes) { currentRow.push(currentCell); currentCell = ''; }
      else if ((char === '\n' || (char === '\r' && next !== '\n')) && !insideQuotes) {
        currentRow.push(currentCell); rows.push(currentRow); currentCell = ''; currentRow = [];
      } else { currentCell += char; }
    }
    if (currentCell || currentRow.length) { currentRow.push(currentCell); rows.push(currentRow); }
    return rows;
  }
});
</script>

<body>
  <h2>CSV一覧</h2>
  <div id="csvList"></div>
</body>
