<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‡ãƒ¼ã‚¿ç·¨é›†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; background: #f8f9fa; }
    textarea { width: 100%; height: 80px; }
    table td input { width: 100%; }
    .btn + .btn { margin-left: 0.5rem; }
    .list-group-item:hover {
      background-color: #e9ecef;
      cursor: pointer;
    }
    .row-flash td {
      background-color: #dff3fb !important;
      transition: none !important;
    }
  /* è¿½åŠ : èª­ã¿è¾¼ã¿ä¸­ã¯æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç„¡åŠ¹åŒ– */
  #detailTable.is-loading {
    pointer-events: none;
    opacity: .6;
  }
  </style>
</head>
<body>
  <!-- è¿½åŠ : ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
  <div id="loading" class="d-flex align-items-center text-muted mb-3" style="gap:.5rem;">
    <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
    <span>èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</span>
  </div>
  <!-- è¿½åŠ : ç·¨é›†UIï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
  <div id="editor" style="display:none;">
  <h3>ğŸ“ ç·¨é›†</h3>
  <div class="mb-3">
    <label class="form-label fw-bold">ä¿®ç¹•ç™ºæ³¨äº‹é …(ãƒ•ã‚¡ã‚¤ãƒ«å)</label>
    <input type="text" class="form-control" id="txNaiyo">
  </div>
  <div class="mb-3">
    <label class="form-label fw-bold">å®Ÿæ–½äº‹é …</label>
    <textarea id="txJisshiJiko"></textarea>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">ç”£å»ƒç­‰å‡¦åˆ†çŠ¶æ³</label>
    <select id="kbSanpaitoJokyo" class="form-select">
      <option value="">--é¸æŠ--</option>
      <option value="ä¸€æ¬¡ä¿ç®¡">ä¸€æ¬¡ä¿ç®¡</option>
      <option value="å‡¦åˆ†æ¸ˆ">å‡¦åˆ†æ¸ˆ</option>
      <option value="ãªã—">ãªã—</option>
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">æ·»ä»˜è³‡æ–™</label><br>
    <span class="me-2">å†™çœŸ</span>
    <label><input type="radio" name="fgShashinUmu" value="1"> æœ‰</label>
    <label><input type="radio" name="fgShashinUmu" value="0"> ç„¡</label>

    <span class="me-2">ã€€å›³é¢</span>
    <label><input type="radio" name="fgZumenUmu" value="1"> æœ‰</label>
    <label><input type="radio" name="fgZumenUmu" value="0"> ç„¡</label>

    <span class="me-2">ã€€å˜ä¾¡æ ¹æ‹ è³‡æ–™</span>
    <label><input type="radio" name="fgKonkyoshiryoUmu" value="1"> æœ‰</label>
    <label><input type="radio" name="fgKonkyoshiryoUmu" value="0"> ç„¡</label>

    <span class="me-2">ã€€ãã®ä»–è³‡æ–™</span>
    <label><input type="radio" name="fgSonotatenpuUmu" value="1"> æœ‰</label>
    <label><input type="radio" name="fgSonotatenpuUmu" value="0"> ç„¡</label>
  </div>

  <div class="mb-3">
    <button class="btn btn-outline-secondary btn-sm" onclick="addRow()">ï¼‹ è¡Œè¿½åŠ </button>
    <!-- æ˜ç´°ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <table class="table table-sm table-bordered bg-white" id="detailTable">
        <thead class="table-light">
          <tr>
            <th>å˜ä¾¡ã‚³ãƒ¼ãƒ‰</th>
            <th>åç§°</th>
            <th>å˜ä¾¡ç¨®åˆ¥</th>
            <th>æ•°é‡</th>
            <th>å˜ä½</th>
            <th>å˜ä¾¡</th>
            <th>é‡‘é¡</th>
            <th>æ‘˜è¦</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    <button class="btn btn-primary" onclick="reflectToParent()">åæ˜ </button>
    <button class="btn btn-success" onclick="saveAsFile()">ä¿å­˜</button>
  </div>
  </div>
</body>
  <div class="mt-4">
  </div>

  <script>
    // åˆæœŸåŒ–ï¼ˆæœªå—ä¿¡ã§ã‚‚å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ï¼‰
    window.tankaLookup = new Map();
    // èª­ã¿è¾¼ã¿å®Œäº†ãƒ•ãƒ©ã‚°
    let dataReady = false;
    let receivedData;
// è¿½åŠ : åˆå›ã ã‘åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
let initialized = false;
    
    // èµ·å‹•ç›´å¾Œã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç„¡åŠ¹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('detailTable')?.classList.add('is-loading');
    });

window.addEventListener('message', e => {
  // â˜… é‡è¦ï¼šäºŒé‡postMessageå¯¾ç­–ï¼ˆæœ€åˆã®1å›ã ã‘å—ã‘ä»˜ã‘ã‚‹ï¼‰
  if (initialized) return;
  initialized = true;
  
  const file = e.data;
  const rows = parseCSV(file.text);
  const { headers, values, details } = splitCsvSections(rows);

  receivedData = {
    fileName: file.fileName,
    parsed: Object.fromEntries(headers.map((h, i) => [h, values[i]])),
    details
  };

  // å˜ä¾¡ä¸€è¦§ï¼ˆä¸Šæ›¸ãï¼‰
  if (Array.isArray(file.tankaList)) {
    window.tankaLookup.clear();
    for (const row of file.tankaList) {
      const code = row[0]?.trim();
      if (code && !window.tankaLookup.has(code)) window.tankaLookup.set(code, row);
    }
  }

  // ç”»é¢ã¸åæ˜ 
  const map = receivedData.parsed;
  document.getElementById('txNaiyo').value = map['ä¿®ç¹•ç™ºæ³¨äº‹é …'] || '';
  document.getElementById('txJisshiJiko').value = map['å®Ÿæ–½äº‹é …'] || '';
  document.getElementById('kbSanpaitoJokyo').value = map['ç”£å»ƒç­‰å‡¦åˆ†çŠ¶æ³'] || '';
  setRadio('fgShashinUmu', map['å†™çœŸ']);
  setRadio('fgZumenUmu', map['å›³é¢']);
  setRadio('fgKonkyoshiryoUmu', map['å˜ä¾¡æ ¹æ‹ è³‡æ–™']);
  setRadio('fgSonotatenpuUmu', map['ãã®ä»–è³‡æ–™']);
  // â˜… ã“ã®æç”»ãŒåˆå›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’é£›ã°ã—ã¦ã„ãŸ
  populateDetailRows(receivedData.details || []);
  // èª­ã¿è¾¼ã¿å®Œäº† â†’ ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œã‚’æœ‰åŠ¹åŒ–ï¼†UIã‚’è¡¨ç¤º
  dataReady = true;
  document.getElementById('detailTable')?.classList.remove('is-loading');
  const loading = document.getElementById('loading');
  if (loading) loading.style.display = 'none';
  const editor = document.getElementById('editor');
  if (editor) editor.style.display = '';
});

function splitCsvSections(rows) {
  const clean = r => r.map(c => c?.replace(/^"(.*)"$/, '$1')?.trim() ?? '');

  const headers = clean(rows[0] || []);
  const values = clean(rows[1] || []);
  const detailStart = rows.findIndex(r => r[0]?.includes('å˜ä¾¡ã‚³ãƒ¼ãƒ‰'));
  const details = detailStart >= 0 ? rows.slice(detailStart + 1).map(clean) : [];

  return { headers, values, details };
}
    
function parseCSV(text) {
  const rows = [];
  let currentRow = [], currentCell = '', inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i], nextChar = text[i + 1];
    if (char === '"' && inQuotes && nextChar === '"') {
      currentCell += '"'; i++;
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      currentRow.push(currentCell); currentCell = '';
    } else if ((char === '\n' || (char === '\r' && nextChar !== '\n')) && !inQuotes) {
      currentRow.push(currentCell); rows.push(currentRow);
      currentCell = ''; currentRow = [];
    } else {
      currentCell += char;
    }
  }
  if (currentCell || currentRow.length) {
    currentRow.push(currentCell); rows.push(currentRow);
  }
  return rows;
}
    function setRadio(name, value) {
      const v = value === 'æœ‰' ? '1' : '0';
      const radios = document.querySelectorAll(`input[name="${name}"]`);
      radios.forEach(r => { r.checked = r.value === v });
    }

    function populateDetailRows(rows) {
      const tbody = document.getElementById('detailBody');
      tbody.innerHTML = '';
      rows.forEach(row => addRow(row));
    }
    
function addRow(data = []) {
  const tr = document.createElement('tr');

  for (let i = 0; i < 8; i++) {
    const td = document.createElement('td');

    if ([0, 1, 3, 7].includes(i)) {
      // ç·¨é›†å¯èƒ½åˆ—ï¼ˆå˜ä¾¡ã‚³ãƒ¼ãƒ‰ã€åç§°ã€æ•°é‡ã€æ‘˜è¦ï¼‰
      const type = (i === 3) ? 'number' : 'text';
      td.innerHTML = `<input type="${type}" class="form-control form-control-sm" value="${data[i] ?? ''}">`;
    } else {
      // ç·¨é›†ä¸å¯åˆ—ã¯è¡¨ç¤ºã ã‘ + hidden ã§ä¿æŒ
      td.innerHTML = `
        <span>${data[i] ?? ''}</span>
        <input type="hidden" value="${data[i] ?? ''}">
      `;
    }
    
    if (i === 0 || i === 3) td.style.width = '6em';
    
    tr.appendChild(td);
  }

  const tdOp = document.createElement('td');
  tdOp.innerHTML = `
    <button class="btn btn-sm btn-outline-secondary me-1" onclick="moveRow(this, -1)">â†‘</button>
    <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">å‰Šé™¤</button>
    <button class="btn btn-sm btn-outline-secondary me-1" onclick="moveRow(this, 1)">â†“</button>
  `;
  tr.appendChild(tdOp);

  document.getElementById('detailBody').appendChild(tr);
}

function moveRow(button, direction) {
  const row = button.closest('tr');
  const tbody = row.parentNode;
  const rows = Array.from(tbody.children);
  const index = rows.indexOf(row);
  const targetIndex = index + direction;

  if (targetIndex < 0 || targetIndex >= rows.length) return;

  const targetRow = rows[targetIndex];
  if (direction === -1) {
    tbody.insertBefore(row, targetRow); // ä¸Šã¸
  } else {
    tbody.insertBefore(targetRow, row); // ä¸‹ã¸
  }

  // ğŸ”„ ç§»å‹•å¾Œã®è¡Œã‚’ä¸€æ™‚çš„ã«æ°´è‰²ã§å¼·èª¿
  row.classList.add('row-flash');
  setTimeout(() => row.classList.remove('row-flash'), 800);
}

function reflectToParent() {
  if (!dataReady) { alert('èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«æ“ä½œã—ã¦ãã ã•ã„'); return; }
  // â–¼ ç·¨é›†å†…å®¹ã‚’å–å¾—ã—ã¦ map ã«åæ˜ 
  const map = receivedData.parsed;
  map['ä¿®ç¹•ç™ºæ³¨äº‹é …'] = document.getElementById('txNaiyo').value;
  map['å‚™è€ƒ'] = '';
  map['ä½å®…å'] = '';
  map['å·æ£Ÿ'] = '';
  map['å·å®¤'] = '';
  map['ç™ºæ³¨ç•ªå·'] = '';  // ç™ºæ³¨ç•ªå·ã‚’ç©ºã«ã™ã‚‹

  // ç™ºæ³¨æ—¥ã‚’ã€ŒYYYY/MM/DDã€å½¢å¼ã«æ›´æ–°
  const today = new Date();
  map['ç™ºæ³¨æ—¥'] =
    today.getFullYear() + '/' +
    String(today.getMonth() + 1).padStart(2, '0') + '/' +
    String(today.getDate()).padStart(2, '0');
  map['å®Œäº†å ±å‘Šæ—¥'] =
    today.getFullYear() + '/' +
    String(today.getMonth() + 1).padStart(2, '0') + '/' +
    String(today.getDate()).padStart(2, '0');
  map['å®Ÿæ–½äº‹é …'] = document.getElementById('txJisshiJiko').value;
  const select = document.getElementById('kbSanpaitoJokyo');
  map['ç”£å»ƒç­‰å‡¦åˆ†çŠ¶æ³'] = select?.options[select.selectedIndex]?.text || '';
  map['å†™çœŸ'] = getRadio('fgShashinUmu');
  map['å›³é¢'] = getRadio('fgZumenUmu');
  map['å˜ä¾¡æ ¹æ‹ è³‡æ–™'] = getRadio('fgKonkyoshiryoUmu');
  map['ãã®ä»–è³‡æ–™'] = getRadio('fgSonotatenpuUmu');

  const details = Array.from(document.querySelectorAll('#detailBody tr')).map(tr =>
    Array.from(tr.querySelectorAll('input')).map(input => input.value.trim())
  );

  const message = {
    fileName: receivedData.fileName,
    parsed: map,
    details
  };

  // â–¼ é€ä¿¡ç¢ºèªï¼ˆYES ã®ã¨ãã®ã¿é€ä¿¡ï¼‰
  const sendChoice = confirm('ä¸€è¦§ã«åæ˜ ã—ã¾ã™ã‹ï¼Ÿ');
  if (!sendChoice) return;

  const targetUrl = 'https://setagaya4856.github.io/csv/koguchi/';
  const target = window.opener;

  if (target && !target.closed) {
    try {
      const href = target.location.href;
      if (href === targetUrl) {
        target.postMessage({
          type: 'edit',
          ...message
        }, '*');

        window.close();
        return;
      }
    } catch (e) {
      // ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ãªã©ã§ location.href ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã‹ã£ãŸå ´åˆ
      console.warn('window.opener.location.href ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ:', e);
    }
  }
  
  alert('ä¸€è¦§ç”»é¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚¿ãƒ–ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‹ã€URLãŒä¸€è‡´ã—ã¦ã„ãªã„å¯èƒ½æ€§ï¼‰');

  // â–¼ è‡ªåˆ†ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ï¼‰ã‚’é–‰ã˜ã‚‹
  window.close();
}
    function getRadio(name) {
      const val = document.querySelector(`input[name="${name}"]:checked`)?.value;
      return val === '1' ? 'æœ‰' : 'ç„¡';
    }
    
function saveAsFile() {
  if (!dataReady) { alert('èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«æ“ä½œã—ã¦ãã ã•ã„'); return; }
  const bom = '\uFEFF'; // UTF-8 BOM

  const map = receivedData.parsed;

  // ğŸ”„ å…¥åŠ›å†…å®¹ã‚’ map ã«åæ˜ ï¼ˆreflectToParent()ã¨åŒã˜å†…å®¹ã‚’ã“ã“ã«ã‚‚è¿½åŠ ï¼‰
  map['å®Ÿæ–½äº‹é …'] = document.getElementById('txJisshiJiko').value;
  map['ä¿®ç¹•ç™ºæ³¨äº‹é …'] = document.getElementById('txNaiyo').value;
  map['å‚™è€ƒ'] = '';
  map['ä½å®…å'] = '';
  map['å·æ£Ÿ'] = '';
  map['å·å®¤'] = '';
  map['ç™ºæ³¨ç•ªå·'] = '';  // ç™ºæ³¨ç•ªå·ã‚’ç©ºã«ã™ã‚‹

  // ç™ºæ³¨æ—¥ã‚’ã€ŒYYYY/MM/DDã€å½¢å¼ã«æ›´æ–°
  const today = new Date();
  map['ç™ºæ³¨æ—¥'] =
    today.getFullYear() + '/' +
    String(today.getMonth() + 1).padStart(2, '0') + '/' +
    String(today.getDate()).padStart(2, '0');
  map['å®Œäº†å ±å‘Šæ—¥'] =
    today.getFullYear() + '/' +
    String(today.getMonth() + 1).padStart(2, '0') + '/' +
    String(today.getDate()).padStart(2, '0');

  map['ç”£å»ƒç­‰å‡¦åˆ†çŠ¶æ³'] = document.getElementById('kbSanpaitoJokyo')?.value || '';
  map['å†™çœŸ'] = getRadio('fgShashinUmu');
  map['å›³é¢'] = getRadio('fgZumenUmu');
  map['å˜ä¾¡æ ¹æ‹ è³‡æ–™'] = getRadio('fgKonkyoshiryoUmu');
  map['ãã®ä»–è³‡æ–™'] = getRadio('fgSonotatenpuUmu');

  const headerLine = Object.keys(map).map(h => `"${h}"`).join(',');
  const valueLine = Object.values(map).map(v => `"${v}"`).join(',');

  const detailHeader = '"å˜ä¾¡ã‚³ãƒ¼ãƒ‰","åç§°","å˜ä¾¡ç¨®åˆ¥","æ•°é‡","å˜ä½","å˜ä¾¡","é‡‘é¡","æ‘˜è¦"';
  const detailLines = Array.from(document.querySelectorAll('#detailBody tr')).map(tr =>
    Array.from(tr.querySelectorAll('input')).map(td => `"${td.value}"`).join(',')
  );

  const csvText = [
    headerLine,
    valueLine,
    '',
    detailHeader,
    ...detailLines
  ].join('\n');

  const blob = new Blob([bom + csvText], { type: 'text/csv;charset=utf-8;' });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;

  const filename = (map['ä¿®ç¹•ç™ºæ³¨äº‹é …'] || 'edited').replace(/[\\/:*?"<>|]/g, '_') + '.csv';
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// â–¼ ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ï¼šå‹•çš„ã‚µã‚¸ã‚§ã‚¹ãƒˆ & è‡ªå‹•è£œå®Œ
document.addEventListener('input', e => {
  const input = e.target;
  const cellIndex = input.closest('td')?.cellIndex;

  // ã¾ã èª­ã¿è¾¼ã¿å‰ã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã ã‘ä¿ã¤ï¼‰
  if (!dataReady) return;

  if (cellIndex === 0) {
    const rowData = window.tankaLookup.get(input.value);
    if (rowData) fillRowFromData(input.closest('tr'), rowData);
  }
  if (cellIndex === 1) {
    showNameSuggestions(input);
  }
});

// â–¼ å€™è£œè¡¨ç¤ºï¼šåç§°éƒ¨åˆ†ä¸€è‡´
function showNameSuggestions(input) {
  closeSuggestions();

  const keyword = input.value.trim();
  if (!keyword) return;

  // åç§°ï¼ˆ1åˆ—ç›®ï¼‰ã¾ãŸã¯ æ‘˜è¦ï¼ˆ7åˆ—ç›®ï¼‰ã«éƒ¨åˆ†ä¸€è‡´ã™ã‚‹å€™è£œã‚’æŠ½å‡º
  const suggestions = Array.from(tankaLookup.values()).filter(row =>
    (row[1] && row[1].includes(keyword)) ||   // åç§°
    (row[7] && row[7].includes(keyword))      // æ‘˜è¦
  );

  if (suggestions.length === 0) return;

  const list = document.createElement('ul');
  list.className = 'list-group position-absolute bg-white border shadow-sm';
  list.style.zIndex = 1000;
  list.style.maxHeight = '200px';
  list.style.overflowY = 'auto';
  list.style.width = input.offsetWidth + 'px';
  list.style.marginTop = '2px';

  suggestions.forEach(row => {
    const name = row[1] ?? '';
    const type = row[2] ?? '';
    const note = row[7] ?? '';
    const item = document.createElement('li');
    item.className = 'list-group-item list-group-item-action';

    // â–¼ è¡¨ç¤ºä¾‹: ã€Œæ‰‰èª¿æ•´ï¼ˆæå·¥Aï¼‰ - URJKKPM-J.CYåŒç­‰å“ã€éŒ èª¿æ•´å«ã€
    item.innerHTML = `
      <strong>${name}</strong>
      <small class="text-muted">ï¼ˆ${type}ï¼‰ - ${note}</small>
    `.trim();

    item.addEventListener('click', () => {
      input.value = name;
      fillRowFromData(input.closest('tr'), row); // ä»–ã®åˆ—ã‚’è‡ªå‹•å…¥åŠ›
      closeSuggestions();
    });

    list.appendChild(item);
  });

  input.parentNode.appendChild(list);
}

// â–¼ å€™è£œã‚’é–‰ã˜ã‚‹
function closeSuggestions() {
  document.querySelectorAll('.list-group').forEach(e => e.remove());
}

// â–¼ ãƒ‡ãƒ¼ã‚¿ã§è©²å½“è¡Œã‚’åŸ‹ã‚ã‚‹
function fillRowFromData(tr, data) {
  const cells = tr.querySelectorAll('td');
  for (let i = 0; i < 8; i++) {
    if ([0, 1, 7].includes(i)) {
      const input = cells[i].querySelector('input');
      if (input) input.value = data[i];
    } else if (i === 3) {
    } else {
      const span = cells[i].querySelector('span');
      const hidden = cells[i].querySelector('input[type="hidden"]');
      if (span) span.textContent = data[i];
      if (hidden) hidden.value = data[i];
    }
  }
}

// â–¼ ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’é–‰ã˜ã‚‹å‡¦ç†ï¼ˆç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼‰
document.addEventListener('click', e => {
  if (!e.target.closest('.list-group')) closeSuggestions();
});
  </script>
</body>
</html>
