<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CSVã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; background: #f8f9fa; }
    textarea { width: 100%; height: 80px; }
    table td input { width: 100%; }
    .btn + .btn { margin-left: 0.5rem; }
  </style>
</head>
<body>
  <h3>ğŸ“ CSVãƒ‡ãƒ¼ã‚¿ç·¨é›†</h3>

  <div class="mb-3">
    <label class="form-label fw-bold">å®Ÿæ–½äº‹é …</label>
    <textarea id="txJisshiJiko"></textarea>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">ç”£å»ƒç­‰å‡¦åˆ†çŠ¶æ³</label>
    <select id="kbSanpaitoJokyo" class="form-select">
      <option value="">--é¸æŠ--</option>
      <option value="ä¸€æ¬¡ä¿ç®¡">ä¸€æ¬¡ä¿ç®¡</option>
      <option value="å‡¦åˆ†æ¸ˆ">å‡¦åˆ†æ¸ˆ</option>
      <option value="ãªã—">ãªã—</option>
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">æ·»ä»˜è³‡æ–™</label><br>
    <span class="me-2">å†™çœŸ</span>
    <label><input type="radio" name="fgShashinUmu" value="1"> æœ‰</label>
    <label><input type="radio" name="fgShashinUmu" value="0"> ç„¡</label>

    <span class="me-2">ã€€å›³é¢</span>
    <label><input type="radio" name="fgZumenUmu" value="1"> æœ‰</label>
    <label><input type="radio" name="fgZumenUmu" value="0"> ç„¡</label>

    <span class="me-2">ã€€å˜ä¾¡æ ¹æ‹ è³‡æ–™</span>
    <label><input type="radio" name="fgKonkyoshiryoUmu" value="1"> æœ‰</label>
    <label><input type="radio" name="fgKonkyoshiryoUmu" value="0"> ç„¡</label>

    <span class="me-2">ã€€ãã®ä»–è³‡æ–™</span>
    <label><input type="radio" name="fgSonotatenpuUmu" value="1"> æœ‰</label>
    <label><input type="radio" name="fgSonotatenpuUmu" value="0"> ç„¡</label>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">æ˜ç´°ç·¨é›†</label>
    <!-- æ˜ç´°ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <table class="table table-sm table-bordered bg-white" id="detailTable">
        <thead class="table-light">
          <tr>
            <th>å˜ä¾¡ã‚³ãƒ¼ãƒ‰</th>
            <th>åç§°</th>
            <th>å˜ä¾¡ç¨®åˆ¥</th>
            <th>æ•°é‡</th>
            <th>å˜ä½</th>
            <th>å˜ä¾¡</th>
            <th>é‡‘é¡</th>
            <th>æ‘˜è¦</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    <button class="btn btn-outline-secondary btn-sm" onclick="addRow()">ï¼‹ è¡Œè¿½åŠ </button>
  </div>

  <div class="mt-4">
    <button class="btn btn-primary" onclick="reflectToParent()">å…ƒã‚¿ãƒ–ã«åæ˜ </button>
    <button class="btn btn-secondary" onclick="window.close()">é–‰ã˜ã‚‹</button>
    <button class="btn btn-success" onclick="saveAsFile()">ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜</button>
  </div>

  <script>
    let receivedData;
    
    window.addEventListener('message', e => {
      receivedData = e.data;
      const map = receivedData.parsed;
      document.getElementById('txJisshiJiko').value = map['å®Ÿæ–½äº‹é …'] || '';
      document.getElementById('kbSanpaitoJokyo').value = map['ç”£å»ƒç­‰å‡¦åˆ†çŠ¶æ³'] || '';
      setRadio('fgShashinUmu', map['å†™çœŸ']);
      setRadio('fgZumenUmu', map['å›³é¢']);
      setRadio('fgKonkyoshiryoUmu', map['å˜ä¾¡æ ¹æ‹ è³‡æ–™']);
      setRadio('fgSonotatenpuUmu', map['ãã®ä»–è³‡æ–™']);
      populateDetailRows(receivedData.details || []);
    });

    function setRadio(name, value) {
      const v = value === 'æœ‰' ? '1' : '0';
      const radios = document.querySelectorAll(`input[name="${name}"]`);
      radios.forEach(r => { r.checked = r.value === v });
    }

    function populateDetailRows(rows) {
      const tbody = document.getElementById('detailBody');
      tbody.innerHTML = '';
      rows.forEach(row => addRow(row));
    }
    
function addRow(data = []) {
  const tr = document.createElement('tr');

  for (let i = 0; i < 8; i++) {
    const td = document.createElement('td');

    if ([0, 1, 3, 7].includes(i)) {
      // ç·¨é›†å¯èƒ½åˆ—ï¼ˆå˜ä¾¡ã‚³ãƒ¼ãƒ‰ã€åç§°ã€æ•°é‡ã€æ‘˜è¦ï¼‰
      const type = (i === 3) ? 'number' : 'text';
      td.innerHTML = `<input type="${type}" class="form-control form-control-sm" value="${data[i] ?? ''}">`;
    } else {
      // ç·¨é›†ä¸å¯åˆ—ã¯è¡¨ç¤ºã ã‘ + hidden ã§ä¿æŒ
      td.innerHTML = `
        <span>${data[i] ?? ''}</span>
        <input type="hidden" value="${data[i] ?? ''}">
      `;
    }

    tr.appendChild(td);
  }

  const tdOp = document.createElement('td');
  tdOp.innerHTML = `<button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">å‰Šé™¤</button>`;
  tr.appendChild(tdOp);

  document.getElementById('detailBody').appendChild(tr);
}

function reflectToParent() {
  // â–¼ ç·¨é›†å†…å®¹ã‚’å–å¾—ã—ã¦ map ã«åæ˜ 
  const map = receivedData.parsed;
  map['å®Ÿæ–½äº‹é …'] = document.getElementById('txJisshiJiko').value;
  const select = document.getElementById('kbSanpaitoJokyo');
  map['ç”£å»ƒç­‰å‡¦åˆ†çŠ¶æ³'] = select?.options[select.selectedIndex]?.text || '';
  map['å†™çœŸ'] = getRadio('fgShashinUmu');
  map['å›³é¢'] = getRadio('fgZumenUmu');
  map['å˜ä¾¡æ ¹æ‹ è³‡æ–™'] = getRadio('fgKonkyoshiryoUmu');
  map['ãã®ä»–è³‡æ–™'] = getRadio('fgSonotatenpuUmu');

  const details = Array.from(document.querySelectorAll('#detailBody tr')).map(tr =>
    Array.from(tr.querySelectorAll('input')).map(input => input.value.trim())
  );

  const message = {
    fileName: receivedData.fileName,
    parsed: map,
    details
  };

  // â–¼ ä¿å­˜ç¢ºèªï¼ˆã©ã¡ã‚‰ã§ã‚‚ç¶šè¡Œï¼‰
  const saveChoice = confirm('ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ');
  if (saveChoice) {
    console.log('ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆå¿…è¦ã§ã‚ã‚Œã°å®Ÿè£…ï¼‰');
    saveAsFile();
  }

  // â–¼ é€ä¿¡ç¢ºèªï¼ˆYES ã®ã¨ãã®ã¿é€ä¿¡ï¼‰
  const sendChoice = confirm('å…ƒã‚¿ãƒ–ã«åæ˜ ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
  if (!sendChoice) return;

  const ujscPattern = /SCL00012_re/i;
  const listExactUrl = 'https://setagaya4856.github.io/csv/koguchi/';
  let sent = false;

  // â–¼ ã‚¿ãƒ–æ¢ç´¢ã¨å‡¦ç†
  const targets = [window.opener];
  for (const win of targets) {
    try {
      if (!win || win.closed) continue;
      const href = win.location.href;

      if (ujscPattern.test(href)) {
        win.postMessage(message, '*');
        sent = true;
      } else if (href === listExactUrl) {
        win.close(); // ä¸€è¦§ç”»é¢ã‚’é–‰ã˜ã‚‹
      }
    } catch (e) {
      console.warn('ã‚¿ãƒ–ã®URLå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆåˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å¯èƒ½æ€§ï¼‰', e);
    }
  }

  if (!sent) alert('UJSCç”»é¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

  // â–¼ è‡ªåˆ†ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ï¼‰ã‚’é–‰ã˜ã‚‹
  window.close();
}
    function getRadio(name) {
      const val = document.querySelector(`input[name="${name}"]:checked`)?.value;
      return val === '1' ? 'æœ‰' : 'ç„¡';
    }
    
function saveAsFile() {
  const bom = '\uFEFF'; // UTF-8 BOM

  const headerLine = Object.keys(receivedData.parsed).map(h => `"${h}"`).join(',');
  const valueLine = Object.values(receivedData.parsed).map(v => `"${v}"`).join(',');
  const detailHeader = '"å˜ä¾¡ã‚³ãƒ¼ãƒ‰","åç§°","å˜ä¾¡ç¨®åˆ¥","æ•°é‡","å˜ä½","å˜ä¾¡","é‡‘é¡","æ‘˜è¦"';
  const detailLines = Array.from(document.querySelectorAll('#detailBody tr')).map(tr =>
    Array.from(tr.querySelectorAll('input')).map(td => `"${td.value}"`).join(',')
  );

  const csvText = [
    headerLine,
    valueLine,
    '',
    detailHeader,
    ...detailLines
  ].join('\n');

  const blob = new Blob([bom + csvText], { type: 'text/csv;charset=utf-8;' });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = receivedData.fileName || 'edited.csv';
  a.click();
  URL.revokeObjectURL(url);
}
  </script>
</body>
</html>
