<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>データ編集</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; background: #f8f9fa; }
    textarea { width: 100%; height: 80px; }
    table td input { width: 100%; }
    .btn + .btn { margin-left: 0.5rem; }
  .list-group-item:hover {
    background-color: #e9ecef;
    cursor: pointer;
  }
  </style>
</head>
<body>
  <h3>📝 編集</h3>

  <div class="mb-3">
    <label class="form-label fw-bold">実施事項</label>
    <textarea id="txJisshiJiko"></textarea>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">産廃等処分状況</label>
    <select id="kbSanpaitoJokyo" class="form-select">
      <option value="">--選択--</option>
      <option value="一次保管">一次保管</option>
      <option value="処分済">処分済</option>
      <option value="なし">なし</option>
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">添付資料</label><br>
    <span class="me-2">写真</span>
    <label><input type="radio" name="fgShashinUmu" value="1"> 有</label>
    <label><input type="radio" name="fgShashinUmu" value="0"> 無</label>

    <span class="me-2">　図面</span>
    <label><input type="radio" name="fgZumenUmu" value="1"> 有</label>
    <label><input type="radio" name="fgZumenUmu" value="0"> 無</label>

    <span class="me-2">　単価根拠資料</span>
    <label><input type="radio" name="fgKonkyoshiryoUmu" value="1"> 有</label>
    <label><input type="radio" name="fgKonkyoshiryoUmu" value="0"> 無</label>

    <span class="me-2">　その他資料</span>
    <label><input type="radio" name="fgSonotatenpuUmu" value="1"> 有</label>
    <label><input type="radio" name="fgSonotatenpuUmu" value="0"> 無</label>
  </div>

  <div class="mb-3">
    <label class="form-label fw-bold">明細編集</label>
    <!-- 明細編集テーブル -->
      <table class="table table-sm table-bordered bg-white" id="detailTable">
        <thead class="table-light">
          <tr>
            <th>単価コード</th>
            <th>名称</th>
            <th>単価種別</th>
            <th>数量</th>
            <th>単位</th>
            <th>単価</th>
            <th>金額</th>
            <th>摘要</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    <button class="btn btn-outline-secondary btn-sm" onclick="addRow()">＋ 行追加</button>
  </div>

  <div class="mt-4">
    <button class="btn btn-primary" onclick="reflectToParent()">保存</button>
  </div>

  <script>
    let receivedData;
    
window.addEventListener('message', e => {
  const file = e.data;
  const rows = parseCSV(file.text);
  const { headers, values, details } = splitCsvSections(rows);

  receivedData = {
    fileName: file.fileName,
    parsed: Object.fromEntries(headers.map((h, i) => [h, values[i]])),
    details
  };

  // 単価一覧を格納（ある場合のみ）
  if (Array.isArray(file.tankaList)) {
    window.tankaLookup = new Map();
    for (const row of file.tankaList) {
      const code = row[0]?.trim();
      if (code && !window.tankaLookup.has(code)) {
        window.tankaLookup.set(code, row);
      }
    }
    console.log('単価一覧を受信:', window.tankaLookup);
  }

  // 画面へ反映
  const map = receivedData.parsed;
  document.getElementById('txJisshiJiko').value = map['実施事項'] || '';
  document.getElementById('kbSanpaitoJokyo').value = map['産廃等処分状況'] || '';
  setRadio('fgShashinUmu', map['写真']);
  setRadio('fgZumenUmu', map['図面']);
  setRadio('fgKonkyoshiryoUmu', map['単価根拠資料']);
  setRadio('fgSonotatenpuUmu', map['その他資料']);
  populateDetailRows(receivedData.details || []);
});

function splitCsvSections(rows) {
  const clean = r => r.map(c => c?.replace(/^"(.*)"$/, '$1')?.trim() ?? '');

  const headers = clean(rows[0] || []);
  const values = clean(rows[1] || []);
  const detailStart = rows.findIndex(r => r[0]?.includes('単価コード'));
  const details = detailStart >= 0 ? rows.slice(detailStart + 1).map(clean) : [];

  return { headers, values, details };
}
    
function parseCSV(text) {
  const rows = [];
  let currentRow = [], currentCell = '', inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i], nextChar = text[i + 1];
    if (char === '"' && inQuotes && nextChar === '"') {
      currentCell += '"'; i++;
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      currentRow.push(currentCell); currentCell = '';
    } else if ((char === '\n' || (char === '\r' && nextChar !== '\n')) && !inQuotes) {
      currentRow.push(currentCell); rows.push(currentRow);
      currentCell = ''; currentRow = [];
    } else {
      currentCell += char;
    }
  }
  if (currentCell || currentRow.length) {
    currentRow.push(currentCell); rows.push(currentRow);
  }
  return rows;
}
    function setRadio(name, value) {
      const v = value === '有' ? '1' : '0';
      const radios = document.querySelectorAll(`input[name="${name}"]`);
      radios.forEach(r => { r.checked = r.value === v });
    }

    function populateDetailRows(rows) {
      const tbody = document.getElementById('detailBody');
      tbody.innerHTML = '';
      rows.forEach(row => addRow(row));
    }
    
function addRow(data = []) {
  const tr = document.createElement('tr');

  for (let i = 0; i < 8; i++) {
    const td = document.createElement('td');

    if ([0, 1, 3, 7].includes(i)) {
      // 編集可能列（単価コード、名称、数量、摘要）
      const type = (i === 3) ? 'number' : 'text';
      td.innerHTML = `<input type="${type}" class="form-control form-control-sm" value="${data[i] ?? ''}">`;
    } else {
      // 編集不可列は表示だけ + hidden で保持
      td.innerHTML = `
        <span>${data[i] ?? ''}</span>
        <input type="hidden" value="${data[i] ?? ''}">
      `;
    }
    
    if (i === 0 || i === 3) td.style.width = '6em';
    
    tr.appendChild(td);
  }

  const tdOp = document.createElement('td');
  tdOp.innerHTML = `<button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">削除</button>`;
  tr.appendChild(tdOp);

  document.getElementById('detailBody').appendChild(tr);
}

function reflectToParent() {
  // ▼ 編集内容を取得して map に反映
  const map = receivedData.parsed;
  map['実施事項'] = document.getElementById('txJisshiJiko').value;
  const select = document.getElementById('kbSanpaitoJokyo');
  map['産廃等処分状況'] = select?.options[select.selectedIndex]?.text || '';
  map['写真'] = getRadio('fgShashinUmu');
  map['図面'] = getRadio('fgZumenUmu');
  map['単価根拠資料'] = getRadio('fgKonkyoshiryoUmu');
  map['その他資料'] = getRadio('fgSonotatenpuUmu');

  const details = Array.from(document.querySelectorAll('#detailBody tr')).map(tr =>
    Array.from(tr.querySelectorAll('input')).map(input => input.value.trim())
  );

  const message = {
    fileName: receivedData.fileName,
    parsed: map,
    details
  };

  // ▼ 保存確認（どちらでも続行）
  const saveChoice = confirm('ファイル保存しますか？');
  if (saveChoice) {
    console.log('保存処理を実行（必要であれば実装）');
    saveAsFile();
  }

  // ▼ 送信確認（YES のときのみ送信）
  const sendChoice = confirm('一覧に反映しますか？');
  if (!sendChoice) return;

  const targetUrl = 'https://setagaya4856.github.io/csv/koguchi/';
  const target = window.opener;

  if (target && !target.closed) {
    try {
      const href = target.location.href;
      if (href === targetUrl) {
        target.postMessage({
          type: 'edit',
          ...message
        }, '*');

        window.close();
        return;
      }
    } catch (e) {
      // クロスオリジンなどで location.href にアクセスできなかった場合
      console.warn('window.opener.location.href にアクセスできませんでした:', e);
    }
  }
  
  alert('一覧画面が見つかりませんでした（タブが閉じられたか、URLが一致していない可能性）');

  // ▼ 自分（エディタ）を閉じる
  window.close();
}
    function getRadio(name) {
      const val = document.querySelector(`input[name="${name}"]:checked`)?.value;
      return val === '1' ? '有' : '無';
    }
    
function saveAsFile() {
  const bom = '\uFEFF'; // UTF-8 BOM

  const headerLine = Object.keys(receivedData.parsed).map(h => `"${h}"`).join(',');
  const valueLine = Object.values(receivedData.parsed).map(v => `"${v}"`).join(',');
  const detailHeader = '"単価コード","名称","単価種別","数量","単位","単価","金額","摘要"';
  const detailLines = Array.from(document.querySelectorAll('#detailBody tr')).map(tr =>
    Array.from(tr.querySelectorAll('input')).map(td => `"${td.value}"`).join(',')
  );

  const csvText = [
    headerLine,
    valueLine,
    '',
    detailHeader,
    ...detailLines
  ].join('\n');

  const blob = new Blob([bom + csvText], { type: 'text/csv;charset=utf-8;' });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = receivedData.fileName || 'edited.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// ▼ イベントバインド：動的サジェスト & 自動補完
document.addEventListener('input', e => {
  const input = e.target;
  const cellIndex = input.closest('td')?.cellIndex;
  const row = input.closest('tr');

  // 「単価コード」入力時：完全一致で補完
  if (cellIndex === 0) {
    const rowData = tankaLookup.get(input.value);
    if (rowData) fillRowFromData(row, rowData);
  }

  // 「名称」入力時：部分一致候補を動的表示
  if (cellIndex === 1) {
    showNameSuggestions(input);
  }
});

// ▼ 候補表示：名称部分一致
function showNameSuggestions(input) {
  closeSuggestions();

  const keyword = input.value.trim();
  if (!keyword) return;

  const suggestions = Array.from(tankaLookup.values()).filter(row =>
    (row[1] && row[1].includes(keyword)) || // 名称
    (row[7] && row[7].includes(keyword))    // 摘要
  );

  if (suggestions.length === 0) return;

  const list = document.createElement('ul');
  list.className = 'list-group position-absolute bg-white border shadow-sm';
  list.style.zIndex = 1000;
  list.style.maxHeight = '200px';
  list.style.overflowY = 'auto';
  list.style.width = input.offsetWidth + 'px';
  list.style.marginTop = '2px';

  suggestions.forEach(row => {
    const item = document.createElement('li');
    item.className = 'list-group-item list-group-item-action';
    item.innerHTML = `<strong>${row[1] ?? ''}</strong><br><small class="text-muted">${row[7] ?? ''}</small>`;
    item.addEventListener('click', () => {
      input.value = row[1];
      fillRowFromData(input.closest('tr'), row);
      closeSuggestions();
    });
    list.appendChild(item);
  });

  input.parentNode.appendChild(list);
}

// ▼ 候補を閉じる
function closeSuggestions() {
  document.querySelectorAll('.list-group').forEach(e => e.remove());
}

// ▼ データで該当行を埋める
function fillRowFromData(tr, data) {
  const cells = tr.querySelectorAll('td');
  for (let i = 0; i < 8; i++) {
    if ([0, 1, 7].includes(i)) {
      const input = cells[i].querySelector('input');
      if (input) input.value = data[i];
    } else if (i === 3) {
    } else {
      const span = cells[i].querySelector('span');
      const hidden = cells[i].querySelector('input[type="hidden"]');
      if (span) span.textContent = data[i];
      if (hidden) hidden.value = data[i];
    }
  }
}

// ▼ サジェストを閉じる処理（画面外クリック時）
document.addEventListener('click', e => {
  if (!e.target.closest('.list-group')) closeSuggestions();
});
  </script>
</body>
</html>
