<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CSV ã²ã‚‰ãŒãªå¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
  <script src="https://unpkg.com/kuroshiro" defer></script>
  <script src="https://unpkg.com/kuroshiro-analyzer-kuromoji" defer></script>
</head>
<body>
  <h2>CSVã‚’ã²ã‚‰ãŒãªå¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
  <input type="file" id="csvFileInput" accept=".csv" />
  <button id="convertBtn">å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <p id="status">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const fileInput = document.getElementById("csvFileInput");
      const convertBtn = document.getElementById("convertBtn");
      const status = document.getElementById("status");

      let kuroshiro;

      async function initKuroshiro() {
        if (!kuroshiro) {
          kuroshiro = new Kuroshiro();
          await kuroshiro.init(new KuromojiAnalyzer());
        }
      }

      function safePreprocess(line) {
        return line
          .replace(/[0-9ï¼-ï¼™\.ï¼]+/g, "") // æ•°å­—é™¤å»
          .replace(/[ã€€\s]+/g, " ")
          .trim();
      }

      async function processCSV() {
        if (!fileInput.files.length) {
          status.textContent = "âš  ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
          try {
            status.innerHTML = "â³ å¤‰æ›ä¸­...";
            const lines = e.target.result.split(/\r?\n/);

            await initKuroshiro();

            const convertedLines = [];
            let errorLog = "";

            for (let i = 0; i < lines.length; i++) {
              const originalLine = lines[i].trim();
              try {
                if (originalLine) {
                  const preprocessed = safePreprocess(originalLine);
                  const hira = await kuroshiro.convert(preprocessed, { to: "hiragana" });
                  convertedLines.push(hira);
                } else {
                  convertedLines.push("");
                }
              } catch (err) {
                const msg = `âš ï¸ è¡Œ ${i + 1} ã®å¤‰æ›ã«å¤±æ•—: ${originalLine}`;
                console.error(msg, err);
                errorLog += msg + "<br>";
                convertedLines.push(`ã€å¤‰æ›å¤±æ•—: ${originalLine}ã€‘`);
              }
            }

            const outputCSV = convertedLines.join("\r\n");
            downloadCSV(outputCSV, "converted.csv");

            status.innerHTML = "âœ… å®Œäº†ï¼<br>" + (errorLog || "ã™ã¹ã¦æ­£å¸¸ã«å¤‰æ›ã•ã‚Œã¾ã—ãŸã€‚");
          } catch (err) {
            console.error("å…¨ä½“ã‚¨ãƒ©ãƒ¼:", err);
            status.textContent = "ğŸš¨ ã‚¨ãƒ©ãƒ¼: " + err.message;
          }
        };

        reader.onerror = (err) => {
          console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
          status.textContent = "ğŸš¨ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
        };

        reader.readAsText(file, "utf-8");
      }

      function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }

      convertBtn.addEventListener("click", processCSV);
    });
  </script>
</body>
</html>
