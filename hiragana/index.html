<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CSV å˜èªã²ã‚‰ãŒãªå¤‰æ›</title>
</head>
<body>
  <h2>CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ å˜èªã®ã¿ ã²ã‚‰ãŒãªå¤‰æ› â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
  <input type="file" id="csvFileInput" accept=".csv" />
  <button onclick="processCSV()">å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <p id="status">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>

  <!-- âœ… å¿…ãš </body> ã®ç›´å‰ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é…ç½®ï¼ -->
  <script src="https://unpkg.com/kuroshiro"></script>
  <script src="https://unpkg.com/kuroshiro-analyzer-kuromoji"></script>
  <script>
    let kuroshiro;

    async function initKuroshiro() {
      kuroshiro = new Kuroshiro();
      await kuroshiro.init(new KuromojiAnalyzer());
    }

    function safePreprocess(line) {
      let cleaned = line
        .replace(/[0-9ï¼-ï¼™\.ï¼]+/g, "") // æ•°å­—ãƒ»å°æ•°ç‚¹é™¤å»
        .replace(/[ã€€\s]+/g, " ")       // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ãƒ»ã‚¿ãƒ– â†’ åŠè§’ã‚¹ãƒšãƒ¼ã‚¹
        .trim();
      return cleaned;
    }

    async function processCSV() {
      const fileInput = document.getElementById('csvFileInput');
      const status = document.getElementById('status');

      if (!fileInput.files.length) {
        status.textContent = 'âš  ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function(e) {
        try {
          status.innerHTML = 'â³ å¤‰æ›ä¸­...';
          const lines = e.target.result.split(/\r?\n/);
          await initKuroshiro();

          const convertedLines = [];
          let errorLog = "";

          for (let i = 0; i < lines.length; i++) {
            const originalLine = lines[i].trim();
            try {
              if (originalLine) {
                const safeLine = safePreprocess(originalLine);
                const hira = await kuroshiro.convert(safeLine, { to: "hiragana" });
                convertedLines.push(hira);
              } else {
                convertedLines.push("");
              }
            } catch (lineError) {
              const errorText = `âš ï¸ è¡Œ ${i + 1} ã§å¤‰æ›å¤±æ•— â†’ ã€Œ${originalLine}ã€`;
              console.error(errorText, lineError);
              convertedLines.push(`ã€å¤‰æ›å¤±æ•—: ${originalLine}ã€‘`);
              errorLog += errorText + "<br>";
            }
          }

          const outputCSV = convertedLines.join("\r\n");
          downloadCSV(outputCSV, "converted.csv");

          status.innerHTML = 'âœ… å¤‰æ›å®Œäº†ï¼<br>' + (errorLog || 'ã™ã¹ã¦æ­£å¸¸ã«å¤‰æ›ã•ã‚Œã¾ã—ãŸã€‚');

        } catch (globalError) {
          console.error("å…¨ä½“ã‚¨ãƒ©ãƒ¼:", globalError);
          status.innerHTML = 'ğŸš¨ å…¨ä½“ã‚¨ãƒ©ãƒ¼: ' + globalError.message;
        }
      };

      reader.onerror = function(err) {
        console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
        status.textContent = 'ğŸš¨ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
      };

      reader.readAsText(file, 'utf-8');
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }
  </script>
</body
