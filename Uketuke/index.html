<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>受付表（夜間緊急当番用）- スマホ直編集→A4 PDF</title>
  <!-- 依存ライブラリ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.6.0/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{
      --a4-w: 210mm; /* A4 幅 */
      --a4-h: 297mm; /* A4 高さ */
      --pad: 10mm;   /* 余白（紙内側） */
      --ink: #111;   /* 罫線色 */
      --font: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    }
    html, body { height: 100%; }
    body{
      margin: 0; padding: env(safe-area-inset-top) 8px calc(72px + env(safe-area-inset-bottom)) 8px;
      background: #f6f7f9; color:#111; font-family: var(--font);
      -webkit-text-size-adjust: 100%;
    }
    header{
      position: sticky; top: 0; z-index: 10; background: #fff;
      margin: 8px 0; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 12px;
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
    }
    header h1{ font-size: clamp(15px, 4.5vw, 18px); margin:0; }

    /* フッターツールバー（親指操作） */
    .toolbar {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 11;
      display:flex; gap:8px; padding: 10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
      background: #fff; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 14px rgba(0,0,0,.06);
    }
    .btn{
      flex:1; min-width: 0; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;
      appearance:none; -webkit-appearance:none; cursor:pointer; user-select:none; touch-action: manipulation;
      font: 700 16px/1 var(--font); /* 16px以上でiOSズーム抑止 */
      padding: 12px; border-radius: 12px; border:1px solid #d1d5db; background:#fff; transition:.15s;
    }
    .btn:hover{ background:#f3f4f6 }
    .btn.primary{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .btn.warn{ background:#fee2e2; border-color:#fecaca; }

    /* A4 シート（スマホ幅にフィット、縦横比維持） */
    .stage{ display:flex; justify-content:center; margin: 8px 0 100px; }
    .sheet{
      position: relative; width: min(100%, 94vw); aspect-ratio: 210 / 297; background: #fff;
      border: 1px solid #e5e7eb; box-shadow: 0 5px 20px rgba(0,0,0,.08); border-radius: 2px;
    }
    .sheet-inner{ position:absolute; inset: var(--pad); display:flex; flex-direction:column; gap: 6mm; }

    /* ヘッダ */
    .sheet-head{ display:flex; justify-content:space-between; align-items:flex-start; gap: 4mm; }
    .title{ font-weight: 800; font-size: clamp(16px, 4vw, 22px); letter-spacing: 0.04em; }
    .meta{ display:grid; grid-template-columns: auto 1fr; gap: 2mm 4mm; font-size: 12px; }
    .meta label{ opacity:.75; }

    /* 表ブロック */
    .box{ border:1px solid var(--ink); }
    .box + .box{ margin-top: 4mm; }
    .row{ display:grid; grid-template-columns: 22mm 1fr; }
    .row > .cap{ border-right: 1px solid var(--ink); background:#f8fafc; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .row + .row{ border-top:1px solid var(--ink); }

    /* 内容はさらに内側で分割可能 */
    .cell{ padding: 2.2mm 2mm; min-height: 8mm; display:flex; align-items:center; gap: 2mm; flex-wrap: wrap; }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 2mm; width: 100%; }
    .grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 2mm; width: 100%; }

    /* 直接編集する要素 */
    .e{ min-width: 8mm; min-height: 6mm; padding: 1mm 1.6mm; border: 1px dashed transparent; border-radius: 6px; line-height:1.2; }
    .e[contenteditable="true"]:focus{ outline: none; border-color: #60a5fa; background: #eff6ff; }
    .e.placeholder:empty::before{ content: attr(data-ph); opacity: .45; }

    /* 大きめメモ欄 */
    .multiline{ min-height: 26mm; align-items: flex-start; }
    .e.block{ display:block; width: 100%; min-height: 18mm; }

    /* チェック群 */
    .checks{ display:flex; flex-wrap: wrap; gap: 3mm 5mm; align-items:center; }
    .checks label{ display:inline-flex; align-items:center; gap: 1.6mm; font-size: 12px; padding: 1mm 2mm; border-radius: 6px; }
    .checks input{ width: 16px; height: 16px; }

    .small{ font-size: 11px; opacity:.75; }

    @media print{
      body{ background:#fff; padding:0; }
      header, .toolbar{ display:none; }
      .stage{ margin:0; }
      .sheet{ width:auto; height:auto; aspect-ratio:auto; box-shadow:none; border:none; }
      .sheet-inner{ inset: 12mm; }
      @page{ size: A4 portrait; margin: 0; }
    }
  </style>
</head>
<body>
  <header>
    <h1>受付表（夜間緊急当番用）— スマホ直編集 → PDF</h1>
    <div class="small">フィールドをタップして直接編集・チェックできます</div>
  </header>

  <main class="stage">
    <!-- ★ A4をそのまま編集してPDF化する単一シート ★ -->
    <section id="sheet" class="sheet" aria-label="A4 sheet">
      <div class="sheet-inner">

        <!-- タイトル＋メタ情報 -->
        <div class="sheet-head">
          <div class="title">受　付　表</div>
          <div class="meta">
            <label>受付日</label>
            <div class="e" contenteditable data-key="uketsuke-bi" data-ph="例）令和7年8月23日（日）"></div>
            <label>受付者</label>
            <div class="e" contenteditable data-key="uketsuke-sha" data-ph="受付者名"></div>
          </div>
        </div>

        <!-- 基本情報ブロック -->
        <div class="box">
          <div class="row">
            <div class="cap">区　分</div>
            <div class="cell checks">
              <label><input type="checkbox" data-key="kbn-hoshu">補修伝票発行済（整理№ <span class="e" contenteditable data-key="kbn-seiri-no" data-ph="番号"></span>）</label>
              <label><input type="checkbox" data-key="kbn-mihakkou">未発行</label>
              <label><input type="checkbox" data-key="kbn-kyoeki">共益費</label>
              <label><input type="checkbox" data-key="kbn-kojin">個人負担</label>
              <label><input type="checkbox" data-key="kbn-claim">クレーム</label>
            </div>
          </div>
          <div class="row">
            <div class="cap">日　時</div>
            <div class="cell grid-3">
              <div class="e" contenteditable data-key="nichi" data-ph="日付"></div>
              <div class="e" contenteditable data-key="jikan" data-ph="時刻（例：AM 6:00）"></div>
              <div class="e" contenteditable data-key="js-no" data-ph="JS時間外受付番号（例：№30）"></div>
            </div>
          </div>
          <div class="row">
            <div class="cap">団地名</div>
            <div class="cell grid-2">
              <div class="e" contenteditable data-key="danchi" data-ph="滝山団地など"></div>
              <div class="e" contenteditable data-key="banchi" data-ph="棟・号室（例：8号棟 208号室）"></div>
            </div>
          </div>
          <div class="row">
            <div class="cap">居住者</div>
            <div class="cell grid-3">
              <div class="e" contenteditable data-key="kyojyu-shubetsu" data-ph="自宅／JS時間外 など"></div>
              <div class="e" contenteditable data-key="shimei" data-ph="氏名（様）"></div>
              <div class="e" contenteditable data-key="tel" data-ph="携帯 090-XXXX-XXXX"></div>
            </div>
          </div>
          <div class="row">
            <div class="cap">連絡先</div>
            <div class="cell grid-2">
              <div class="e" contenteditable data-key="kaisha" data-ph="（会社名）"></div>
              <div class="e" contenteditable data-key="kinmusaki" data-ph="勤務先"></div>
            </div>
          </div>
        </div>

        <!-- 内容／対応 -->
        <div class="box">
          <div class="row">
            <div class="cap">内　容</div>
            <div class="cell multiline">
              <div class="e block" contenteditable data-key="naiyo" data-ph="上階より漏水 など（複数行可）"></div>
            </div>
          </div>
          <div class="row">
            <div class="cap">対　応</div>
            <div class="cell checks">
              <label><input type="checkbox" data-key="syutsudo-honnin">※出動者 本人</label>
              <label><input type="checkbox" data-key="sagyo-oug">※作業対応 → 応急処置</label>
              <label><input type="checkbox" data-key="shukin-nashi">集金の必要 → 無</label>
              <label><input type="checkbox" data-key="js-mihokoku">JS時間外完了報告 → 未報告</label>
            </div>
          </div>
          <div class="row">
            <div class="cap">経　過<br>処　理</div>
            <div class="cell multiline">
              <div class="e block" contenteditable data-key="keika" data-ph="例）7時30 現着 一次対応／8時30 福重氏に引き継ぎ"></div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- 親指操作のフッターツールバー -->
  <nav class="toolbar">
    <button class="btn" id="btnLoad">読込</button>
    <button class="btn" id="btnSave">保存</button>
    <button class="btn warn" id="btnClear">全消去</button>
    <button class="btn" id="btnPrint">印刷</button>
    <button class="btn primary" id="btnPdf">PDF保存</button>
  </nav>

  <script>
    // ========= 直編集フィールドのプレースホルダー制御 =========
    function refreshPlaceholders(){
      document.querySelectorAll('[contenteditable][data-ph]').forEach(el => {
        el.classList.toggle('placeholder', el.innerText.trim() === '');
      });
    }
    const observer = new MutationObserver(refreshPlaceholders);
    observer.observe(document.body, { subtree:true, childList:true, characterData:true });
    document.addEventListener('input', e=>{
      if(e.target.matches('[contenteditable]')) refreshPlaceholders();
    });

    // ========= 保存・読込（localStorage） =========
    const STORE_KEY = 'uketsuke-mobile-v1';
    function exportState(){
      const state = {};
      document.querySelectorAll('[contenteditable][data-key]').forEach(el => {
        state[el.dataset.key] = el.innerHTML; // 改行保持
      });
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(ch => {
        state[ch.dataset.key] = ch.checked;
      });
      return state;
    }
    function importState(state){
      if(!state) return;
      document.querySelectorAll('[contenteditable][data-key]').forEach(el => {
        if(state.hasOwnProperty(el.dataset.key)) el.innerHTML = state[el.dataset.key] || '';
      });
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(ch => {
        if(state.hasOwnProperty(ch.dataset.key)) ch.checked = !!state[ch.dataset.key];
      });
      refreshPlaceholders();
    }
    function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(exportState())); }
    function load(){ const s = localStorage.getItem(STORE_KEY); if(s){ importState(JSON.parse(s)); } }
    function clearAll(){
      document.querySelectorAll('[contenteditable][data-key]').forEach(el => el.innerHTML = '');
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(ch => ch.checked = false);
      refreshPlaceholders();
    }

    // 初期化：受付日に今日を入れておく（和暦は手入力想定）
    (function init(){
      const d = new Date();
      const w = ['日','月','火','水','木','金','土'][d.getDay()];
      const iso = `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日（${w}）`;
      const el = document.querySelector('[data-key="uketsuke-bi"]');
      if(el && !el.innerText.trim()) el.innerText = iso;
      refreshPlaceholders();
    })();

    // ========= PDF/印刷 =========
    async function exportPdf(){
      const node = document.getElementById('sheet');
      const canvas = await html2canvas(node, { backgroundColor:'#ffffff', scale: 2, windowWidth: node.offsetWidth, windowHeight: node.offsetHeight });
      const img = canvas.toDataURL('image/jpeg', 0.98);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
      const pageW = 210, pageH = 297; // A4
      const imgW = pageW, imgH = imgW * (canvas.height / canvas.width);
      const y = Math.max(0, (pageH - imgH) / 2);
      pdf.addImage(img, 'JPEG', 0, y, imgW, imgH, undefined, 'FAST');
      pdf.save(`受付表_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    // ========= イベント =========
    document.getElementById('btnSave').addEventListener('click', () => { save(); alert('ローカルに保存しました'); });
    document.getElementById('btnLoad').addEventListener('click', () => { load(); alert('保存データを読み込みました'); });
    document.getElementById('btnClear').addEventListener('click', () => { if(confirm('全項目を消去します。よろしいですか？')) clearAll(); });
    document.getElementById('btnPdf').addEventListener('click', exportPdf);
    document.getElementById('btnPrint').addEventListener('click', () => { window.print(); });

    // iOS Safari のズーム抑止（ダブルタップ無効化）
    let lastTouch = 0;
    document.addEventListener('touchend', e => {
      const now = Date.now();
      if(now - lastTouch <= 350){ e.preventDefault(); }
      lastTouch = now;
    }, { passive:false });
  </script>
</body>
</html>
