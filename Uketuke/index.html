<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>受付表 → PDF</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{
      --ink:#1f2937;
      --grid:#d1d5db;
      --bg:#ffffff;
      --pad:12px;
      --font: system-ui, -apple-system, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      --toolbar-h: 64px;
    }
    html{ -webkit-text-size-adjust: 100%; }
    body { margin:0; font-family: var(--font); background:#f6f7f9; font-size:19px; line-height:1.65; }

    .toolbar { position: fixed; bottom:0; left:0; right:0; display:flex; gap:8px; padding:10px calc(10px + env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left)); background:#fff; border-top:1px solid #ddd; height: var(--toolbar-h); box-sizing: border-box; }
    .btn { flex:1; padding:12px; font-size:17px; font-weight:700; border-radius:10px; border:1px solid #ccc; background:#fff; }
    .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }

    main { display:flex; justify-content:center; padding:12px; padding-bottom: calc(var(--toolbar-h) + 24px + env(safe-area-inset-bottom)); }

    .sheet { background:var(--bg); width: min(100%, 100vw - 16px); max-width: 820px; padding: var(--pad); border:1px solid #e5e7eb; box-shadow:0 2px 8px rgba(0,0,0,.05); margin: 0 auto; }

    .title { text-align:center; font-weight:900; letter-spacing:0.06em; margin: 2px 0 10px; font-size: clamp(26px, 6.2vw, 36px); }
    .subtitle { text-align:center; font-size:16px; opacity:.7; margin-bottom:8px; }

    .grid-table { display:grid; grid-template-columns: minmax(110px, 30%) 1fr; border:1px solid var(--ink); }
    .th, .td { border-right:1px solid var(--ink); border-bottom:1px solid var(--ink); min-height:58px; padding:12px; box-sizing:border-box; }
    .th { background:#f3f4f6; font-weight:800; display:flex; align-items:center; justify-content:center; text-align:center; }
    .td { display:block; white-space: normal; word-break: break-word; overflow-wrap: anywhere; }

    input, textarea, select { width:100%; font-size:19px; padding:12px; border:1px solid var(--grid); border-radius:4px; background:#fff; box-sizing:border-box; line-height:1.65; }
    textarea { resize: vertical; box-sizing:border-box; }
    /* 10行ぶんの高さを確保（画面表示時） */
    textarea.short { min-height: 260px; }
    textarea.tall  { min-height: 300px; }

    .inline { display:flex; gap:8px; flex-wrap:wrap; }
    .inline input, .inline select { flex:1 1 150px; min-width:0; }

    /* 号棟号室：全体を半幅、左寄せ */
    .inline.half { max-width:50%; justify-content:flex-start; }
    .with-suffix { position:relative; flex:1 1 120px; min-width:0; }
    .with-suffix input { padding-right:44px; }
    .suffix { position:absolute; right:10px; top:50%; transform:translateY(-50%); opacity:.7; font-size:16px; pointer-events:none; }

    .checks { display:flex; flex-wrap:wrap; gap:8px 16px; align-items:center; }
    .checks label { display:inline-flex; align-items:center; gap:6px; white-space:normal; writing-mode: horizontal-tb; }
    .checks input[type="checkbox"]{ width:18px; height:18px; }

    @media (max-width: 380px){
      .grid-table{ grid-template-columns: 100px 1fr; }
      .th, .td{ min-height: 60px; padding: 12px 10px; }
      .inline{ gap:6px; }
      .inline.half{ max-width:100%; } /* 端末が狭い時は自動で全幅に戻す */
    }

    @media (max-width: 340px){
      .th{ padding: 12px 6px; word-break: keep-all; line-height:1.35; }
    }

@media print{
  .toolbar { display:none; }
  body{
    background:#fff;
    font-size:40px;           /* 本文を大きく */
    line-height:1.9;          /* 縦ゆったり */
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }

  /* 左列見出しが大きくても収まるよう幅を拡張 */
  .grid-table{ grid-template-columns: minmax(240px, 36%) 1fr; }

  /* 左ラベル（受付区分/受付日時/団地/居住者…）を約3倍 */
  .grid-table .th{ font-size:3em !important; font-weight:900 !important; }

  /* タイトル＆サブタイトルは今の約3倍 */
  .title{ font-size:3em !important; }
  .subtitle{ font-size:3em !important; }

  .sheet{ border:none; box-shadow:none; padding: 14mm; width:auto; max-width:none; }
  input::placeholder, textarea::placeholder { color: transparent !important; }

  /* テキストエリア：枠は“少し薄く”、はみ出し防止、10行相当の高さ */
  textarea.short, textarea.tall{
    border:1px solid #888 !important;   /* ← 少し薄く */
    width:100% !important;
    box-sizing:border-box !important;
    overflow-wrap:anywhere !important;
  }
  textarea.short { min-height:340px !important; }
  textarea.tall  { min-height:400px !important; }

  /* 「※作業対応」は1列表示（ラベルとセレクトを横並び） */
  .td .inline label{ display:inline-flex; align-items:center; gap:12px; }
  .td .inline label select{ display:inline-block; min-width:260px; }

  /* 居住者の電話3つ：上の名前欄に近い感覚で3等分 */
  .td .inline{ display:flex; gap:14px; }
  .td .inline > input.tel{ flex:1 1 0; min-width:0; }

  /* 出勤者の「その他」の横の入力欄を広く（元:220px → 倍） */
  input[placeholder*="直接入力可"][style*="width:220px"]{
    min-width:440px !important;
    display:inline-block !important;
  }

  /* 「補修伝票発行済」の前で改行＋No.欄を倍幅→その後も改行 */
  .checks span input[style*="width:70px"]{
    width:180px !important;               /* ← 倍幅 */
    display:inline-block !important;
    margin-top:6px;
  }

  /* ※対応内容の太字は削除（印刷時のみ） */
  .td label{ font-weight:400 !important; }

  /* 「集金の必要性 有 無」の後で改行（= 次の「※JS時間外報告」を新行へ） */
  .td.tall .checks:last-of-type span:nth-of-type(2){
    display:block !important;
    width:100% !important;
    margin-top:10px;
  }

  @page{ size: A4 portrait; margin: 0; }
}
  </style>
</head>
<body>
  <main>
    <section class="sheet" id="sheet">
      <div class="title">受　付　表</div>
      <div class="subtitle">（夜間緊急当番用）</div>

      <div class="grid-table">
        <div class="th">受付区分</div>
        <div class="td">
          <div class="inline">
            <select><option>JS時間外</option><option>電話本人</option><option>住まいセンター</option><option>管理事務所</option><option>その他</option></select>
            <input type="text" placeholder="名前（直接入力可）"/>
          </div>
        </div>

        <div class="th">受付日時</div>
        <div class="td">
          <div class="inline">
            <input type="date">
            <input type="time">
            <input type="text" placeholder="受付者（直接入力）">
          </div>
        </div>

        <div class="th">団地名</div>
        <div class="td">
          <div class="inline">
            <select><option>ひばりが丘PH</option><option>GPひばりが丘南</option><option>新柳沢団地</option><option>PS田無向台</option><option>GH東久留米</option><option>滝山団地</option><option>滝山東団地</option>
              <option>フレール西経堂</option><option>経堂赤堤通り団地</option><option>スクエアー世田谷桜丘</option><option>世田谷通りシティハイツ若林</option><option>CC二子玉川</option><option>CC上馬</option><option>上馬二丁目</option><option>その他</option></select>
            <input type="text" placeholder="直接入力可（任意）">
          </div>
        </div>

        <div class="th">号棟号室</div>
        <div class="td">
          <!-- 半幅＆左寄せに -->
          <div class="inline half">
            <div class="with-suffix"><input type="text"><span class="suffix">号棟</span></div>
            <div class="with-suffix"><input type="text"><span class="suffix">号室</span></div>
          </div>
        </div>

        <div class="th">居住者</div>
        <div class="td">
          <div class="inline"><input type="text" placeholder="名前（様）"></div>
          <div class="inline" style="margin-top:8px">
            <input type="tel" class="tel" placeholder="電話番号1">
            <input type="tel" class="tel" placeholder="電話番号2">
            <input type="tel" class="tel" placeholder="電話番号3">
          </div>
        </div>

        <div class="th">内　容</div>
        <div class="td"><textarea class="short" placeholder="内部改行可（10行程度の高さを確保）"></textarea></div>

        <div class="th">情　報</div>
        <div class="td">
          <div class="checks">
            <label><input type="checkbox">ＪＳ時間外受付番号</label>
            <span>No.<input type="text" style="width:90px"></span>
            <label><input type="checkbox">補修伝票発行済</label>
            <span>No.<input type="text" style="width:90px"></span>
            <label><input type="checkbox">未発行</label>
            <label><input type="checkbox">共益費</label>
            <label><input type="checkbox">個人負担</label>
            <label><input type="checkbox">クレーム</label>
          </div>
        </div>

        <div class="th">経過及び処理</div>
        <div class="td tall">
          <div class="checks" style="margin-bottom:8px">
            <span>※出勤者</span>
            <label><input type="checkbox">本人</label>
            <label><input type="checkbox">業者</label>
            <label><input type="checkbox">その他</label>
            <span><input type="text" placeholder="（直接入力可）" style="width:220px"></span>
          </div>
          <div class="inline" style="margin-top:8px">
            <label style="display:inline-flex; align-items:center; gap:6px">※作業対応
              <select>
                <option>未対応</option>
                <option>応急処置</option>
                <option>修理済み</option>
                <option>調査のみ</option>
                <option>その他</option>
              </select>
            </label>
          </div>
          <div style="margin-top:8px">
            <label style="display:block; font-weight:700; margin-bottom:6px">※対応内容</label>
            <textarea class="short" placeholder="対応内容を記入"></textarea>
          </div>
          <div class="checks" style="margin-top:8px">
            <span>※集金の必要性</span>
            <label><input type="checkbox">有</label>
            <label><input type="checkbox">無</label>
            <span style="margin-left:12px">※JS時間外報告</span>
            <label><input type="checkbox">済</label>
            <label><input type="checkbox">未報告</label>
          </div>
        </div>
      </div>
    </section>
  </main>

  <nav class="toolbar">
    <button class="btn" id="btnPrint">印刷</button>
    <button class="btn primary" id="btnPdf">PDF保存</button>
  </nav>

  <script>
    // PCと同じ見た目でA4フルサイズPDF化（枠線＆高さを保持）
    async function exportPdf(){
      const src = document.getElementById('sheet');

      // 画面外にA4相当のクローンを作って固定幅で描画
      const printRoot = document.createElement('div');
      printRoot.style.position = 'fixed';
      printRoot.style.left = '-10000px';
      printRoot.style.top = '0';
      printRoot.style.width = '1240px'; // ≒A4幅(150dpi目安)
      const clone = src.cloneNode(true);
      clone.id = 'sheetPrint';
      clone.style.width = '1240px';
      clone.style.maxWidth = '1240px';
      clone.style.minWidth = '1240px';
      clone.style.boxShadow = 'none';
      /* 外枠は不要 */
      clone.style.padding = '48px';
      clone.style.fontSize = '32px';   // ← 2倍相当
      clone.style.lineHeight = '1.8';  // ← 縦を広く

      // 入力UIを「枠付きの表示ボックス」に置換して枠/高さ/折返しを安定化
      normalizeForPrint(clone);

      printRoot.appendChild(clone);
      document.body.appendChild(printRoot);

      const widthPx = clone.offsetWidth;
      const heightPx = clone.scrollHeight;
      const canvas = await html2canvas(clone, {
        backgroundColor:'#ffffff',
        scale: 2,
        width: widthPx,
        height: heightPx,
        windowWidth: widthPx,
        windowHeight: heightPx
      });

      const img = canvas.toDataURL('image/jpeg', 0.98);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
      const pageW = 210, pageH = 297;
      const imgWmm = pageW;
      const imgHmm = imgWmm * (canvas.height / canvas.width);
      const scaleToFit = Math.min(pageH / imgHmm, 1);
      const finalW = imgWmm * scaleToFit;
      const finalH = imgHmm * scaleToFit;
      const offsetX = (pageW - finalW) / 2;
      const offsetY = (pageH - finalH) / 2;
      pdf.addImage(img, 'JPEG', offsetX, offsetY, finalW, finalH, undefined, 'FAST');
      // ---- ファイル名を動的作成 ----
const complexName = (()=>{
  // クローンじゃなく画面上の値から採る（未入力でもOKなようにフォールバック）
  const danchiSel = document.querySelector('div.th + .td select'); // 最初のselectは受付区分なので、団地のselectを厳密に取る
  // より確実に：団地名の th をキーに探す
  const ths = [...document.querySelectorAll('.th')];
  const danchiTh = ths.find(t=>t.textContent.includes('団地名'));
  const danchiTd = danchiTh ? danchiTh.nextElementSibling : null;
  const danchiSelect = danchiTd ? danchiTd.querySelector('select') : null;
  const danchi = danchiSelect ? (danchiSelect.options[danchiSelect.selectedIndex]?.text || '') : '';

  const gtTd = (ths.find(t=>t.textContent.includes('号棟号室'))||{}).nextElementSibling;
  const gt = gtTd ? (gtTd.querySelector('.with-suffix input[placeholder="8"]')?.value || gtTd.querySelector('.with-suffix input')?.value || '') : '';
  const gs = gtTd ? (gtTd.querySelector('.with-suffix + .with-suffix input[placeholder="208"]')?.value || gtTd.querySelector('.with-suffix + .with-suffix input')?.value || '') : '';

  const parts = [];
  if(danchi) parts.push(danchi);
  if(gt) parts.push(`${gt}号棟`);
  if(gs) parts.push(`${gs}号室`);
  parts.push('受付表');
  return parts.join('_') + '.pdf';
})();

pdf.save(complexName);
      
      document.body.removeChild(printRoot);
    }
function normalizeForPrint(root){
  // 枠付きボックス（印刷時に幅が縮まず、常に枠と余白を持つ）
  const makeBox = (text, {block=true, minH=48, minW=null, width=null, pad=12, border='#000', flexGrow=null, inline=false}={}) => {
    const div = document.createElement('div');
    div.textContent = text || '';
    div.style.whiteSpace = 'pre-wrap';
    div.style.border = `1px solid ${border}`;  // ← 枠線（少し薄くしたい場合は #888 でもOK）
    div.style.borderRadius = '4px';
    div.style.padding = pad + 'px';
    div.style.lineHeight = '1.8';
    div.style.boxSizing = 'border-box';
    if(width){ div.style.width = width; }
    if(minH){ div.style.minHeight = (typeof minH==='number'? minH+'px' : minH); }
    if(minW){ div.style.minWidth  = (typeof minW==='number'? minW+'px' : minW); }
    if(flexGrow !== null){ div.style.flex = `${flexGrow} 1 0`; }
    if(inline){ div.style.display = 'inline-block'; }
    else if(block){ div.style.display = 'block'; div.style.width = div.style.width || '100%'; }
    return div;
  };

  // ーーー 「情報」ブロックの体裁：補修伝票の前で改行させる準備 ーーー
  const infoTh = [...root.querySelectorAll('.th')].find(th => th.textContent.includes('情'));
  const infoTd = infoTh ? infoTh.nextElementSibling : null;
  if(infoTd){
    const labels = [...infoTd.querySelectorAll('label')];
    const hoshuLabel = labels.find(l => l.textContent.includes('補修伝票発行済'));
    if(hoshuLabel){
      // ラベルの直前に改行ブロックを入れる
      const br1 = document.createElement('div');
      br1.style.width = '100%';
      br1.style.height = '0';
      hoshuLabel.parentNode.insertBefore(br1, hoshuLabel);
    }
  }

  // input（checkbox以外）→ ボックス化
  root.querySelectorAll('input').forEach(el => {
    const type = (el.getAttribute('type')||'text').toLowerCase();
    if(type === 'checkbox') return;

    const inSuffix = !!el.closest('.with-suffix');   // 号棟/号室
    const isTel    = el.classList.contains('tel');   // 電話
    const isNo     = el.parentElement && /No\./.test(el.parentElement.textContent); // No.
    const inInfo   = !!el.closest('.td') && infoTd && infoTd.contains(el);
    const isEtcOut = el.getAttribute('placeholder')?.includes('直接入力可') && el.style.width === '220px'; // 出勤者「その他」

    if(inSuffix){
      // 号棟/号室：小さめ並列（半幅領域内）
      el.replaceWith(makeBox(el.value, {inline:true, minH:48, minW:140}));
    } else if(isTel){
      // 電話：3つ均等（親flex等分）→ ボックスはflex:1
      const box = makeBox(el.value, {inline:false, minH:48});
      box.style.flex = '1 1 0';
      el.replaceWith(box);
    } else if(isNo && inInfo){
      // 情報欄の No. → 倍幅 & 直後で改行
      const box = makeBox(el.value, {inline:true, minH:48, minW:180});
      const parentSpan = el.parentElement;
      el.replaceWith(box);
      if(parentSpan){
        parentSpan.style.display = 'block';
        parentSpan.style.width = '100%';
        parentSpan.style.marginTop = '6px';
      }
    } else if(isNo){
      // その他の No.
      el.replaceWith(makeBox(el.value, {inline:true, minH:48, minW:110}));
    } else if(isEtcOut){
      // 出勤者「その他」入力欄を広く
      el.replaceWith(makeBox(el.value, {block:false, minH:48, minW:440}));
    } else {
      // 受付区分 / 受付者 / 団地 / 居住者 など：幅いっぱい
      el.replaceWith(makeBox(el.value, {block:true, minH:56}));
    }
  });

  // select → 「※作業対応」は1列表示（ラベル内でインライン）
  root.querySelectorAll('select').forEach(sel => {
    const inWorkLabel = !!sel.closest('label') && sel.closest('label')?.textContent.includes('※作業対応');
    if(inWorkLabel){
      sel.replaceWith(makeBox(sel.options[sel.selectedIndex]?.text || '', {inline:true, minH:48, minW:260}));
    } else {
      sel.replaceWith(makeBox(sel.options[sel.selectedIndex]?.text || '', {block:true, minH:56}));
    }
  });

  // textarea → 内容/対応内容は常に10行相当の高さ、幅100%
  root.querySelectorAll('textarea').forEach(ta => {
    const minH = ta.classList.contains('tall') ? 400 : 340; // 印刷時拡大
    const box = makeBox(ta.value, {block:true, minH, border:'#888'}); // ← 少し薄い枠
    box.style.width = '100%';
    ta.replaceWith(box);
  });

  // ※対応内容の見出しは太字を削除
  root.querySelectorAll('label').forEach(lab=>{
    if(lab.textContent.trim().includes('※対応内容')) lab.style.fontWeight='400';
  });

  // checkbox → □/☑︎ + 文言
  root.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    const label = cb.closest('label');
    const sym = cb.checked ? '☑︎' : '☐';
    if(label){
      const text = label.textContent.replace(/[\s\u2610\u2611\u2705]*/g, '').trim();
      const span = document.createElement('span');
      span.textContent = `${sym} ${text}`;
      label.replaceWith(span);
    } else {
      const span = document.createElement('span');
      span.textContent = sym;
      cb.replaceWith(span);
    }
  });

  // 「集金の必要性 有 無」の後で改行（= 次の「※JS時間外報告」を新行へ）
  const lastChecks = root.querySelector('.td.tall .checks:last-of-type');
  if(lastChecks){
    const spans = lastChecks.querySelectorAll('span');
    if(spans[1]){ spans[1].style.display='block'; spans[1].style.width='100%'; spans[1].style.marginTop='10px'; }
  }
}


    document.getElementById('btnPdf').addEventListener('click', exportPdf);
    document.getElementById('btnPrint').addEventListener('click', () => window.print());

    // 電話番号フォーマット
    function formatTel(v){
      const d = v.replace(/[^0-9]/g, '');
      if(d.startsWith('0120')){
        if(d.length <= 4) return d;
        if(d.length <= 7) return d.slice(0,4)+'-'+d.slice(4);
        return d.slice(0,4)+'-'+d.slice(4,7)+'-'+d.slice(7,11);
      }
      if(d.length <= 3) return d;
      if(d.length <= 7) return d.slice(0,3)+'-'+d.slice(3);
      return d.slice(0,3)+'-'+d.slice(3,7)+'-'+d.slice(7,11);
    }
    document.querySelectorAll('.tel').forEach(input=>{
      input.addEventListener('input',e=>{ e.target.value=formatTel(e.target.value); });
    });
  </script>
</body>
</html>
