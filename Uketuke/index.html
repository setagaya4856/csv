<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>受付表（夜間緊急当番用）- スマホ直編集 → PDF</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{
      --ink:#1f2937;
      --grid:#d1d5db;
      --bg:#ffffff;
      --pad:12px;
      --font: system-ui, -apple-system, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      --toolbar-h: 64px;
    }
    html{ -webkit-text-size-adjust: 100%; }
    body { margin:0; font-family: var(--font); background:#f6f7f9; font-size:19px; line-height:1.65; }

    .toolbar { position: fixed; bottom:0; left:0; right:0; display:flex; gap:8px; padding:10px calc(10px + env(safe-area-inset-right)) calc(10px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left)); background:#fff; border-top:1px solid #ddd; height: var(--toolbar-h); box-sizing: border-box; }
    .btn { flex:1; padding:12px; font-size:17px; font-weight:700; border-radius:10px; border:1px solid #ccc; background:#fff; }
    .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }

    main { display:flex; justify-content:center; padding:12px; padding-bottom: calc(var(--toolbar-h) + 24px + env(safe-area-inset-bottom)); }

    .sheet { background:var(--bg); width: min(100%, 100vw - 16px); max-width: 820px; padding: var(--pad); border:1px solid #e5e7eb; box-shadow:0 2px 8px rgba(0,0,0,.05); margin: 0 auto; }

    .title { text-align:center; font-weight:900; letter-spacing:0.06em; margin: 2px 0 10px; font-size: clamp(26px, 6.2vw, 36px); }
    .subtitle { text-align:center; font-size:16px; opacity:.7; margin-bottom:8px; }

    .grid-table { display:grid; grid-template-columns: minmax(110px, 30%) 1fr; border:1px solid var(--ink); }
    .th, .td { border-right:1px solid var(--ink); border-bottom:1px solid var(--ink); min-height:58px; padding:12px; box-sizing:border-box; }
    .th { background:#f3f4f6; font-weight:800; display:flex; align-items:center; justify-content:center; text-align:center; }
    .td { display:block; white-space: normal; word-break: break-word; overflow-wrap: anywhere; }

    input, textarea, select { width:100%; font-size:19px; padding:12px; border:1px solid var(--grid); border-radius:4px; background:#fff; box-sizing:border-box; line-height:1.65; }
    textarea { resize: vertical; box-sizing:border-box; }
    /* 10行ぶんの高さを確保（画面表示時） */
    textarea.short { min-height: 260px; }
    textarea.tall  { min-height: 300px; }

    .inline { display:flex; gap:8px; flex-wrap:wrap; }
    .inline input, .inline select { flex:1 1 150px; min-width:0; }

    /* 号棟号室：全体を半幅、左寄せ */
    .inline.half { max-width:50%; justify-content:flex-start; }
    .with-suffix { position:relative; flex:1 1 120px; min-width:0; }
    .with-suffix input { padding-right:44px; }
    .suffix { position:absolute; right:10px; top:50%; transform:translateY(-50%); opacity:.7; font-size:16px; pointer-events:none; }

    .checks { display:flex; flex-wrap:wrap; gap:8px 16px; align-items:center; }
    .checks label { display:inline-flex; align-items:center; gap:6px; white-space:normal; writing-mode: horizontal-tb; }
    .checks input[type="checkbox"]{ width:18px; height:18px; }

    @media (max-width: 380px){
      .grid-table{ grid-template-columns: 100px 1fr; }
      .th, .td{ min-height: 60px; padding: 12px 10px; }
      .inline{ gap:6px; }
      .inline.half{ max-width:100%; } /* 端末が狭い時は自動で全幅に戻す */
    }

    @media (max-width: 340px){
      .th{ padding: 12px 6px; word-break: keep-all; line-height:1.35; }
    }

@media print{
  .toolbar { display:none; }
  body{
    background:#fff;
    font-size:19px;           /* ← 印刷時の本文サイズUP */
    line-height:1.7;          /* ← 縦方向にゆったり */
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }
  .sheet{ border:none; box-shadow:none; padding: 12mm; width:auto; max-width:none; }
  input::placeholder, textarea::placeholder { color: transparent !important; }

  /* 印刷時も内容/対応内容は常に10行相当以上を確保し、枠を明示 */
  textarea.short, textarea.tall { border:1px solid #000 !important; }
  textarea.short { min-height:300px !important; }
  textarea.tall  { min-height:360px !important; }

  @page{ size: A4 portrait; margin: 0; }
}
  </style>
</head>
<body>
  <main>
    <section class="sheet" id="sheet">
      <div class="title">受　付　表</div>
      <div class="subtitle">（夜間緊急当番用）</div>

      <div class="grid-table">
        <div class="th">受付区分</div>
        <div class="td">
          <div class="inline">
            <select><option>JS時間外</option><option>日常受付</option><option>その他</option></select>
            <input type="text" placeholder="名前（直接入力可）" value="イイノ" />
          </div>
        </div>

        <div class="th">受付日時</div>
        <div class="td">
          <div class="inline">
            <input type="date">
            <input type="time">
            <input type="text" placeholder="受付者（直接入力）">
          </div>
        </div>

        <div class="th">団地名</div>
        <div class="td">
          <div class="inline">
            <select><option>滝山団地</option><option>ひばりが丘</option><option>その他</option></select>
            <input type="text" placeholder="直接入力可（任意）">
          </div>
        </div>

        <div class="th">号棟号室</div>
        <div class="td">
          <!-- 半幅＆左寄せに -->
          <div class="inline half">
            <div class="with-suffix"><input type="text" placeholder="8"><span class="suffix">号棟</span></div>
            <div class="with-suffix"><input type="text" placeholder="208"><span class="suffix">号室</span></div>
          </div>
        </div>

        <div class="th">居住者</div>
        <div class="td">
          <div class="inline"><input type="text" placeholder="名前（様）"></div>
          <div class="inline" style="margin-top:8px">
            <input type="tel" class="tel" placeholder="電話番号1">
            <input type="tel" class="tel" placeholder="電話番号2">
            <input type="tel" class="tel" placeholder="電話番号3">
          </div>
        </div>

        <div class="th">内　容</div>
        <div class="td"><textarea class="short" placeholder="内部改行可（10行程度の高さを確保）"></textarea></div>

        <div class="th">情　報</div>
        <div class="td">
          <div class="checks">
            <label><input type="checkbox">ＪＳ時間外受付番号</label>
            <span>No.<input type="text" style="width:90px"></span>
            <label><input type="checkbox">補修伝票発行済</label>
            <span>No.<input type="text" style="width:90px"></span>
            <label><input type="checkbox">未発行</label>
            <label><input type="checkbox">共益費</label>
            <label><input type="checkbox">個人負担</label>
            <label><input type="checkbox">クレーム</label>
          </div>
        </div>

        <div class="th">経過及び処理</div>
        <div class="td tall">
          <div class="checks" style="margin-bottom:8px">
            <span>※出勤者</span>
            <label><input type="checkbox">本人</label>
            <label><input type="checkbox">業者</label>
            <label><input type="checkbox">その他</label>
            <span><input type="text" placeholder="（直接入力可）" style="width:220px"></span>
          </div>
          <div class="inline" style="margin-top:8px">
            <label style="display:inline-flex; align-items:center; gap:6px">※作業対応
              <select>
                <option>応急処置</option>
                <option>本修理</option>
                <option>調査のみ</option>
                <option>その他</option>
              </select>
            </label>
          </div>
          <div style="margin-top:8px">
            <label style="display:block; font-weight:700; margin-bottom:6px">※対応内容</label>
            <textarea class="short" placeholder="対応内容を記入"></textarea>
          </div>
          <div class="checks" style="margin-top:8px">
            <span>※集金の必要性</span>
            <label><input type="checkbox">有</label>
            <label><input type="checkbox">無</label>
            <span style="margin-left:12px">※JS時間外報告</span>
            <label><input type="checkbox">済</label>
            <label><input type="checkbox">未報告</label>
          </div>
        </div>
      </div>
    </section>
  </main>

  <nav class="toolbar">
    <button class="btn" id="btnPrint">印刷</button>
    <button class="btn primary" id="btnPdf">PDF保存</button>
  </nav>

  <script>
    // PCと同じ見た目でA4フルサイズPDF化（枠線＆高さを保持）
    async function exportPdf(){
      const src = document.getElementById('sheet');

      // 画面外にA4相当のクローンを作って固定幅で描画
      const printRoot = document.createElement('div');
      printRoot.style.position = 'fixed';
      printRoot.style.left = '-10000px';
      printRoot.style.top = '0';
      printRoot.style.width = '1240px'; // ≒A4幅(150dpi目安)
      const clone = src.cloneNode(true);
      clone.id = 'sheetPrint';
      clone.style.width = '1240px';
      clone.style.maxWidth = '1240px';
      clone.style.minWidth = '1240px';
      clone.style.boxShadow = 'none';
      /* 外枠は不要 */
      clone.style.padding = '48px';
      clone.style.fontSize = '19px';   /* 印刷時も本文大きめ */
      clone.style.lineHeight = '1.7';

      // 入力UIを「枠付きの表示ボックス」に置換して枠/高さ/折返しを安定化
      normalizeForPrint(clone);

      printRoot.appendChild(clone);
      document.body.appendChild(printRoot);

      const widthPx = clone.offsetWidth;
      const heightPx = clone.scrollHeight;
      const canvas = await html2canvas(clone, {
        backgroundColor:'#ffffff',
        scale: 2,
        width: widthPx,
        height: heightPx,
        windowWidth: widthPx,
        windowHeight: heightPx
      });

      const img = canvas.toDataURL('image/jpeg', 0.98);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
      const pageW = 210, pageH = 297;
      const imgWmm = pageW;
      const imgHmm = imgWmm * (canvas.height / canvas.width);
      const scaleToFit = Math.min(pageH / imgHmm, 1);
      const finalW = imgWmm * scaleToFit;
      const finalH = imgHmm * scaleToFit;
      const offsetX = (pageW - finalW) / 2;
      const offsetY = (pageH - finalH) / 2;
      pdf.addImage(img, 'JPEG', offsetX, offsetY, finalW, finalH, undefined, 'FAST');
      pdf.save('受付表.pdf');

      document.body.removeChild(printRoot);
    }

function normalizeForPrint(root){
  // 表示用ボックス（印刷時に幅が縮まず、常に枠と余白を持つ）
  const makeBox = (text, {block=true, minH=44, minW=null, pad=12, border='#000'}={}) => {
    const div = document.createElement('div');
    div.textContent = text || '';
    div.style.whiteSpace = 'pre-wrap';
    div.style.border = `1px solid ${border}`;
    div.style.borderRadius = '4px';
    div.style.padding = pad + 'px';
    div.style.lineHeight = '1.7';
    if(block){ div.style.display = 'block'; div.style.width = '100%'; }
    else { div.style.display = 'inline-block'; }
    if(minH){ div.style.minHeight = (typeof minH==='number'? minH+'px' : minH); }
    if(minW){ div.style.minWidth  = (typeof minW==='number'? minW+'px' : minW); }
    return div;
  };

  // input（checkbox以外）→ ボックス化
  root.querySelectorAll('input').forEach(el => {
    const type = (el.getAttribute('type')||'text').toLowerCase();
    if(type === 'checkbox') return;

    const parent = el.closest('.with-suffix');
    const isTel  = el.classList.contains('tel');
    const isNo   = el.parentElement && /No\./.test(el.parentElement.textContent);

    // 号棟/号室・電話・No. は横並びの小さめボックスを維持
    if(parent){
      el.replaceWith(makeBox(el.value, {block:false, minH:44, minW:140}));
    } else if(isTel){
      el.replaceWith(makeBox(el.value, {block:false, minH:44, minW:160}));
    } else if(isNo){
      el.replaceWith(makeBox(el.value, {block:false, minH:44, minW:90}));
    } else {
      // 受付区分 / 受付日時 / 団地 / 居住者 などは幅いっぱいの大きめボックス
      el.replaceWith(makeBox(el.value, {block:true, minH:48}));
    }
  });

  // select → 幅いっぱい
  root.querySelectorAll('select').forEach(sel => {
    sel.replaceWith(makeBox(sel.options[sel.selectedIndex]?.text || '', {block:true, minH:48}));
  });

  // textarea → 内容 / 対応内容 は常に10行ぶん以上の高さ
  root.querySelectorAll('textarea').forEach(ta => {
    const minH = ta.classList.contains('tall') ? 360 : 300; // 印刷時拡大
    ta.replaceWith(makeBox(ta.value, {block:true, minH}));
  });

  // checkbox → □/☑︎ + 文言（インライン）
  root.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    const label = cb.closest('label');
    const sym = cb.checked ? '☑︎' : '☐';
    if(label){
      const text = label.textContent.replace(/[\s\u2610\u2611\u2705]*/g, '').trim();
      const span = document.createElement('span');
      span.textContent = `${sym} ${text}`;
      label.replaceWith(span);
    } else {
      const span = document.createElement('span');
      span.textContent = sym;
      cb.replaceWith(span);
    }
  });
}


    document.getElementById('btnPdf').addEventListener('click', exportPdf);
    document.getElementById('btnPrint').addEventListener('click', () => window.print());

    // 電話番号フォーマット
    function formatTel(v){
      const d = v.replace(/[^0-9]/g, '');
      if(d.startsWith('0120')){
        if(d.length <= 4) return d;
        if(d.length <= 7) return d.slice(0,4)+'-'+d.slice(4);
        return d.slice(0,4)+'-'+d.slice(4,7)+'-'+d.slice(7,11);
      }
      if(d.length <= 3) return d;
      if(d.length <= 7) return d.slice(0,3)+'-'+d.slice(3);
      return d.slice(0,3)+'-'+d.slice(3,7)+'-'+d.slice(7,11);
    }
    document.querySelectorAll('.tel').forEach(input=>{
      input.addEventListener('input',e=>{ e.target.value=formatTel(e.target.value); });
    });
  </script>
</body>
</html>
