
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>音声入力（iOS対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/wanakana"></script>
  <style>
    #voiceControlBar {
      position: fixed;
      bottom: 15vh;
      width: 100vw;
      background: #e0ffff;
      padding: 20px;
      font-size: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 999;
    }
    #voiceLogPanel {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      max-height: 15vh;
      overflow-y: auto;
      background: #f0f0f0;
      padding: 10px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h2>iOS対応 音声入力</h2>

  <div id="voiceControlBar">
    <input id="voiceInputText" type="text" placeholder="ここに音声入力してください" style="flex: 1; font-size: 20px; margin-right: 10px;">
    <button onclick="processVoiceInput()" style="font-size: 20px;">✅ 確定</button>
  </div>

  <div id="voiceLogPanel">
    <h4>📝 入力ログ</h4>
    <ul id="voiceLogList"></ul>
  </div>

  <script>
    function toHiragana(inputText) {
      return wanakana.toHiragana(inputText, { passRomaji: true });
    }

    function processVoiceInput() {
      const input = document.getElementById("voiceInputText").value;
      if (!input.trim()) return;
      addToVoiceLog(input);
      const parsed = parseSpecialInput(input);
      if (parsed) {
        alert("解析成功:\n" + JSON.stringify(parsed, null, 2));
      } else {
        alert("認識できませんでした");
      }
      document.getElementById("voiceInputText").value = "";
    }

    function addToVoiceLog(text) {
      const li = document.createElement("li");
      li.textContent = text;
      document.getElementById("voiceLogList").appendChild(li);
    }

    function parseSpecialInput(inputText) {
      const hiragana = toHiragana(inputText);
      const modeWords = {
        "めも": "overwrite",
        "メモ": "overwrite",
        "こうしんご": "content_overwrite",
        "ちぇんじ": "content_overwrite",
        "チェンジ": "content_overwrite",
        "くりあ": "clear",
        "クリア": "clear"
      };

      const delimiters = ["ばしょ", "場所", "バショ"];
      let delimiterUsed = null;
      for (const d of delimiters) {
        if (hiragana.includes(d)) {
          delimiterUsed = d;
          break;
        }
      }
      if (!delimiterUsed) return null;

      const [parentPart, rest] = hiragana.split(delimiterUsed);
      const pattern = /(.*?)(めも|メモ|こうしんご|ちぇんじ|チェンジ|くりあ|クリア)([0-9一二三四五六七八九〇]*)$/;
      const modeMatch = rest.match(pattern);
      if (!modeMatch) return null;

      const childText = modeMatch[1];
      const modeRaw = modeMatch[2];
      const numberRaw = modeMatch[3];

      const mode = modeWords[modeRaw];
      const amount = mode === "clear" || mode === "content_overwrite" ? 0 : convertToNumber(numberRaw);

      return {
        parent: parentPart,
        child: childText,
        mode: mode,
        amount: amount
      };
    }

    function convertToNumber(raw) {
      const str = raw
        .replace(/〇/g, "0")
        .replace(/一/g, "1")
        .replace(/二/g, "2")
        .replace(/三/g, "3")
        .replace(/四/g, "4")
        .replace(/五/g, "5")
        .replace(/六/g, "6")
        .replace(/七/g, "7")
        .replace(/八/g, "8")
        .replace(/九/g, "9")
        .replace(/[^\d.]/g, "");
      const num = parseFloat(str);
      return isNaN(num) ? 0 : num;
    }
  </script>
</body>
</html>
