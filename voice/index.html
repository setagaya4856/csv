<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>éŸ³å£°ã§æ•°é‡åŠ ç®—</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 8px;
    }
    #resultDisplay, #errorDisplay, #historyLog {
      margin-top: 20px;
      padding: 10px;
      border: 1px dashed #666;
      background-color: #f8f8f8;
      font-size: 1.1em;
    }
    button {
      margin-right: 10px;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«</h2>
<table id="itemTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>å•†å“å</th>
      <th>æ•°é‡</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>ã‚Šã‚“ã”</td><td>3</td></tr>
    <tr><td>2</td><td>ã¿ã‹ã‚“</td><td>2</td></tr>
    <tr><td></td><td></td><td></td></tr> <!-- ç©ºè¡Œ -->
    <tr><td></td><td></td><td></td></tr> <!-- ç©ºè¡Œ -->
  </tbody>
</table>

<br>
<button onclick="startRecognition()">ğŸ¤ éŸ³å£°å…¥åŠ›é–‹å§‹</button>
<button onclick="stopRecognition()">â¹ï¸ åœæ­¢</button>
<button id="retryBtn" onclick="startRecognition()" style="display:none;">ğŸ” å†è©¦è¡Œ</button>

<div id="resultDisplay">ğŸ§ éŸ³å£°å…¥åŠ›ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
<div id="errorDisplay" class="error"></div>
<div id="historyLog">
  <h3>ğŸ“ éŸ³å£°å±¥æ­´ãƒ­ã‚°</h3>
  <ul id="historyList"></ul>
</div>

<script>
let recognition;

function startRecognition() {
  if (recognition) recognition.abort();

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'ja-JP';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  document.getElementById("resultDisplay").textContent = "ğŸ™ï¸ éŸ³å£°èªè­˜ä¸­...";
  document.getElementById("errorDisplay").textContent = "";
  document.getElementById("retryBtn").style.display = "none";

  recognition.start();

  recognition.onresult = function(event) {
    const result = event.results[0][0].transcript;
    document.getElementById("resultDisplay").textContent = `âœ… éŸ³å£°å…¥åŠ›: ${result}`;
    addToHistory(result);
    processInput(result);
  };

  recognition.onerror = function(event) {
    document.getElementById("errorDisplay").textContent = "âš ï¸ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: " + event.error;
    document.getElementById("retryBtn").style.display = "inline";
  };

  recognition.onend = function() {
    console.log("éŸ³å£°èªè­˜çµ‚äº†");
  };
}

function stopRecognition() {
  if (recognition) {
    recognition.abort();
    document.getElementById("resultDisplay").textContent = "â¹ï¸ éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚";
  }
}

function addToHistory(text) {
  const li = document.createElement("li");
  li.textContent = text;
  document.getElementById("historyList").appendChild(li);
}

function convertToNumber(raw) {
  let str = raw
    .replace(/ã¦ã‚“|ãƒ†ãƒ³|ç‚¹/g, ".")
    .replace(/ã€‡|é›¶/g, "0")
    .replace(/ä¸€/g, "1")
    .replace(/äºŒ/g, "2")
    .replace(/ä¸‰/g, "3")
    .replace(/å››/g, "4")
    .replace(/äº”/g, "5")
    .replace(/å…­/g, "6")
    .replace(/ä¸ƒ/g, "7")
    .replace(/å…«/g, "8")
    .replace(/ä¹/g, "9")
    .replace(/å/g, "10")
    .replace(/ç™¾/g, "100")
    .replace(/[^\d.]/g, "");

  const num = parseFloat(str);
  return isNaN(num) ? null : num;
}

function generateId(rows) {
  let maxId = 0;
  for (let row of rows) {
    const id = parseInt(row.cells[0].textContent);
    if (!isNaN(id)) maxId = Math.max(maxId, id);
  }
  return maxId + 1;
}

function processInput(input) {
  const parts = input.trim().split(/\s+/);
  if (parts.length !== 3) {
    alert("å½¢å¼ã¯ã€Œå•†å“å åˆ‡ã‚Šåˆ†ã‘ãƒ¯ãƒ¼ãƒ‰ æ•°é‡ã€ã§è©±ã—ã¦ãã ã•ã„");
    return;
  }

  const [searchWord, columnWord, rawNumber] = parts;

  const isQuantity = ["ã™ã†ã‚Šã‚‡ã†", "æ•°é‡", "ã‚ã‚‚", "ãƒ¡ãƒ¢"].includes(columnWord.toLowerCase());
  if (!isQuantity) {
    alert(`ã€Œ${columnWord}ã€ã¯èªè­˜ã§ãã¾ã›ã‚“ã€‚æ•°é‡æ‰±ã„ã§ãã‚‹ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œã™ã†ã‚Šã‚‡ã†ã€ã€Œæ•°é‡ã€ã€Œã‚ã‚‚ã€ã€Œãƒ¡ãƒ¢ã€ã§ã™`);
    return;
  }

  const number = convertToNumber(rawNumber);
  if (number === null) {
    alert("æ•°é‡ãŒæ­£ã—ãèªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ•°å­—ã‚„æ¼¢æ•°å­—ã§è©±ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const table = document.getElementById("itemTable");
  const rows = table.getElementsByTagName("tbody")[0].rows;
  let matched = false;

  for (let row of rows) {
    const nameCell = row.cells[1];
    const quantityCell = row.cells[2];

    if (nameCell.textContent.includes(searchWord)) {
      const current = parseFloat(quantityCell.textContent) || 0;
      quantityCell.textContent = (current + number).toFixed(2).replace(/\.00$/, "");
      matched = true;
      break;
    }
  }

  if (!matched) {
    const confirmed = confirm(`ã€Œ${searchWord}ã€ã«ä¸€è‡´ã™ã‚‹è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nç©ºç™½è¡Œã«è¿½åŠ ã—ã¦ã‚‚ã‚ˆã„ã§ã™ã‹ï¼Ÿ`);
    if (confirmed) {
      for (let row of rows) {
        if (row.cells[0].textContent.trim() === "") {
          row.cells[0].textContent = generateId(rows);
          row.cells[1].textContent = searchWord;
          row.cells[2].textContent = number;
          break;
        }
      }
    }
  }
}
</script>

</body>
</html>
