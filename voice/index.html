<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>音声テーブル編集（PWA対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;音声テーブル編集&quot;,
    &quot;short_name&quot;:&quot;音声編集&quot;,
    &quot;start_url&quot;:&quot;./index.html&quot;,
    &quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#ffffff&quot;,
    &quot;theme_color&quot;:&quot;#ffffff&quot;,
    &quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFklEQVQoU2NkYGBg+M+ABhgFowEAAb0B+ROHkYgAAAAASUVORK5CYII=&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/png&quot;}]
  }">
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 8px;
    }
    #resultDisplay, #errorDisplay, #historyLog {
      margin-top: 20px;
      padding: 10px;
      border: 1px dashed #666;
      background-color: #f8f8f8;
      font-size: 1.1em;
    }
    .error { color: red; font-weight: bold; }
    button { margin-right: 10px; padding: 5px 10px; }
  </style>
</head>
<body>

<h2>🎤 音声で数量を加算・追加</h2>
<table id="itemTable">
  <thead>
    <tr><th>ID</th><th>商品名</th><th>数量</th></tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>りんご</td><td>3</td></tr>
    <tr><td>2</td><td>みかん</td><td>2</td></tr>
    <tr><td></td><td></td><td></td></tr>
    <tr><td></td><td></td><td></td></tr>
  </tbody>
</table>

<br>
<button onclick="startRecognition()">🎙️ 音声入力開始</button>
<button onclick="stopRecognition()">⏹️ 停止</button>
<button id="retryBtn" onclick="startRecognition()" style="display:none;">🔁 再試行</button>

<div id="resultDisplay">🎧 音声入力の内容がここに表示されます</div>
<div id="errorDisplay" class="error"></div>
<div id="historyLog">
  <h3>📝 音声履歴ログ</h3>
  <ul id="historyList"></ul>
</div>

<script>
let recognition;

if ('serviceWorker' in navigator) {
  const swScript = `
    self.addEventListener('fetch', function(event) {
      return; // no cache logic
    });
  `;
  const blob = new Blob([swScript], { type: 'application/javascript' });
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL).then(() => {
    console.log('✅ Service Worker registered');
  }).catch(err => {
    console.error('❌ Service Worker registration failed:', err);
  });
}

function startRecognition() {
  if (recognition) recognition.abort();
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'ja-JP';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  document.getElementById("resultDisplay").textContent = "🎙️ 音声認識中...";
  document.getElementById("errorDisplay").textContent = "";
  document.getElementById("retryBtn").style.display = "none";

  recognition.start();

  recognition.onresult = function(event) {
    const result = event.results[0][0].transcript;
    document.getElementById("resultDisplay").textContent = `✅ 音声入力: ${result}`;
    addToHistory(result);
    processInput(result);
  };

  recognition.onerror = function(event) {
    document.getElementById("errorDisplay").textContent = "⚠️ 音声認識エラー: " + event.error;
    document.getElementById("retryBtn").style.display = "inline";
  };

  recognition.onend = function() {
    console.log("音声認識終了");
  };
}

function stopRecognition() {
  if (recognition) {
    recognition.abort();
    document.getElementById("resultDisplay").textContent = "⏹️ 音声認識を停止しました。";
  }
}

function addToHistory(text) {
  const li = document.createElement("li");
  li.textContent = text;
  document.getElementById("historyList").appendChild(li);
}

function convertToNumber(raw) {
  let str = raw
    .replace(/てん|テン|点/g, ".")
    .replace(/〇|零/g, "0")
    .replace(/一/g, "1")
    .replace(/二/g, "2")
    .replace(/三/g, "3")
    .replace(/四/g, "4")
    .replace(/五/g, "5")
    .replace(/六/g, "6")
    .replace(/七/g, "7")
    .replace(/八/g, "8")
    .replace(/九/g, "9")
    .replace(/十/g, "10")
    .replace(/百/g, "100")
    .replace(/[^\d.]/g, "");

  const num = parseFloat(str);
  return isNaN(num) ? null : num;
}

function generateId(rows) {
  let maxId = 0;
  for (let row of rows) {
    const id = parseInt(row.cells[0].textContent);
    if (!isNaN(id)) maxId = Math.max(maxId, id);
  }
  return maxId + 1;
}

function processInput(input) {
  const cleanedInput = input.trim().replace(/\s/g, "");
  const match = cleanedInput.match(/(.+?)(めも|メモ|すうりょう|数量)(.+)/i);

  if (!match) {
    alert("形式は「商品名 メモ 数量」のように話してください");
    return;
  }

  const searchWord = match[1];
  const columnWord = match[2];
  const rawNumber = match[3];

  const number = convertToNumber(rawNumber);
  if (number === null) {
    alert("数量が正しく認識できませんでした。数字や漢数字で話してください。");
    return;
  }

  const table = document.getElementById("itemTable");
  const rows = table.getElementsByTagName("tbody")[0].rows;
  let matched = false;

  for (let row of rows) {
    const nameCell = row.cells[1];
    const quantityCell = row.cells[2];

    if (nameCell.textContent.includes(searchWord)) {
      const current = parseFloat(quantityCell.textContent) || 0;
      quantityCell.textContent = (current + number).toFixed(2).replace(/\.00$/, "");
      matched = true;
      break;
    }
  }

  if (!matched) {
    const confirmed = confirm(`「${searchWord}」に一致する行が見つかりませんでした。\n空白行に追加してもよいですか？`);
    if (confirmed) {
      for (let row of rows) {
        if (row.cells[0].textContent.trim() === "") {
          row.cells[0].textContent = generateId(rows);
          row.cells[1].textContent = searchWord;
          row.cells[2].textContent = number;
          break;
        }
      }
    }
  }
}
</script>

</body>
</html>
