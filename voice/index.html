<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>éŸ³å£°ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†ï¼ˆPWAå¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="data:application/manifest+json,{
    &quot;name&quot;:&quot;éŸ³å£°ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†&quot;,
    &quot;short_name&quot;:&quot;éŸ³å£°ç·¨é›†&quot;,
    &quot;start_url&quot;:&quot;./index.html&quot;,
    &quot;display&quot;:&quot;standalone&quot;,
    &quot;background_color&quot;:&quot;#ffffff&quot;,
    &quot;theme_color&quot;:&quot;#ffffff&quot;,
    &quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFklEQVQoU2NkYGBg+M+ABhgFowEAAb0B+ROHkYgAAAAASUVORK5CYII=&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/png&quot;}]
  }">
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 8px;
    }
    #resultDisplay, #errorDisplay, #historyLog {
      margin-top: 20px;
      padding: 10px;
      border: 1px dashed #666;
      background-color: #f8f8f8;
      font-size: 1.1em;
    }
    .error { color: red; font-weight: bold; }
    button { margin-right: 10px; padding: 5px 10px; }
  </style>
</head>
<body>

<h2>ğŸ¤ éŸ³å£°ã§æ•°é‡ã‚’åŠ ç®—ãƒ»è¿½åŠ </h2>
<table id="itemTable">
  <thead>
    <tr><th>ID</th><th>å•†å“å</th><th>æ•°é‡</th></tr>
  </thead>
  <tbody>
    <tr><td>1</td><td>ã‚Šã‚“ã”</td><td>3</td></tr>
    <tr><td>2</td><td>ã¿ã‹ã‚“</td><td>2</td></tr>
    <tr><td></td><td></td><td></td></tr>
    <tr><td></td><td></td><td></td></tr>
  </tbody>
</table>

<br>
<button onclick="startRecognition()">ğŸ™ï¸ éŸ³å£°å…¥åŠ›é–‹å§‹</button>
<button onclick="stopRecognition()">â¹ï¸ åœæ­¢</button>
<button id="retryBtn" onclick="startRecognition()" style="display:none;">ğŸ” å†è©¦è¡Œ</button>

<div id="resultDisplay">ğŸ§ éŸ³å£°å…¥åŠ›ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
<div id="errorDisplay" class="error"></div>
<div id="historyLog">
  <h3>ğŸ“ éŸ³å£°å±¥æ­´ãƒ­ã‚°</h3>
  <ul id="historyList"></ul>
</div>

<script>
let recognition;

if ('serviceWorker' in navigator) {
  const swScript = `
    self.addEventListener('fetch', function(event) {
      return; // no cache logic
    });
  `;
  const blob = new Blob([swScript], { type: 'application/javascript' });
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL).then(() => {
    console.log('âœ… Service Worker registered');
  }).catch(err => {
    console.error('âŒ Service Worker registration failed:', err);
  });
}

function startRecognition() {
  if (recognition) recognition.abort();
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'ja-JP';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  document.getElementById("resultDisplay").textContent = "ğŸ™ï¸ éŸ³å£°èªè­˜ä¸­...";
  document.getElementById("errorDisplay").textContent = "";
  document.getElementById("retryBtn").style.display = "none";

  recognition.start();

  recognition.onresult = function(event) {
    const result = event.results[0][0].transcript;
    document.getElementById("resultDisplay").textContent = `âœ… éŸ³å£°å…¥åŠ›: ${result}`;
    addToHistory(result);
    processInput(result);
  };

  recognition.onerror = function(event) {
    document.getElementById("errorDisplay").textContent = "âš ï¸ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: " + event.error;
    document.getElementById("retryBtn").style.display = "inline";
  };

  recognition.onend = function() {
    console.log("éŸ³å£°èªè­˜çµ‚äº†");
  };
}

function stopRecognition() {
  if (recognition) {
    recognition.abort();
    document.getElementById("resultDisplay").textContent = "â¹ï¸ éŸ³å£°èªè­˜ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚";
  }
}

function addToHistory(text) {
  const li = document.createElement("li");
  li.textContent = text;
  document.getElementById("historyList").appendChild(li);
}

function convertToNumber(raw) {
  let str = raw
    .replace(/ã¦ã‚“|ãƒ†ãƒ³|ç‚¹/g, ".")
    .replace(/ã€‡|é›¶/g, "0")
    .replace(/ä¸€/g, "1")
    .replace(/äºŒ/g, "2")
    .replace(/ä¸‰/g, "3")
    .replace(/å››/g, "4")
    .replace(/äº”/g, "5")
    .replace(/å…­/g, "6")
    .replace(/ä¸ƒ/g, "7")
    .replace(/å…«/g, "8")
    .replace(/ä¹/g, "9")
    .replace(/å/g, "10")
    .replace(/ç™¾/g, "100")
    .replace(/[^\d.]/g, "");

  const num = parseFloat(str);
  return isNaN(num) ? null : num;
}

function generateId(rows) {
  let maxId = 0;
  for (let row of rows) {
    const id = parseInt(row.cells[0].textContent);
    if (!isNaN(id)) maxId = Math.max(maxId, id);
  }
  return maxId + 1;
}

function processInput(input) {
  const cleanedInput = input.trim().replace(/\s/g, "");
  const match = cleanedInput.match(/(.+?)(ã‚ã‚‚|ãƒ¡ãƒ¢|ã™ã†ã‚Šã‚‡ã†|æ•°é‡)(.+)/i);

  if (!match) {
    alert("å½¢å¼ã¯ã€Œå•†å“å ãƒ¡ãƒ¢ æ•°é‡ã€ã®ã‚ˆã†ã«è©±ã—ã¦ãã ã•ã„");
    return;
  }

  const searchWord = match[1];
  const columnWord = match[2];
  const rawNumber = match[3];

  const number = convertToNumber(rawNumber);
  if (number === null) {
    alert("æ•°é‡ãŒæ­£ã—ãèªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ•°å­—ã‚„æ¼¢æ•°å­—ã§è©±ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const table = document.getElementById("itemTable");
  const rows = table.getElementsByTagName("tbody")[0].rows;
  let matched = false;

  for (let row of rows) {
    const nameCell = row.cells[1];
    const quantityCell = row.cells[2];

    if (nameCell.textContent.includes(searchWord)) {
      const current = parseFloat(quantityCell.textContent) || 0;
      quantityCell.textContent = (current + number).toFixed(2).replace(/\.00$/, "");
      matched = true;
      break;
    }
  }

  if (!matched) {
    const confirmed = confirm(`ã€Œ${searchWord}ã€ã«ä¸€è‡´ã™ã‚‹è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nç©ºç™½è¡Œã«è¿½åŠ ã—ã¦ã‚‚ã‚ˆã„ã§ã™ã‹ï¼Ÿ`);
    if (confirmed) {
      for (let row of rows) {
        if (row.cells[0].textContent.trim() === "") {
          row.cells[0].textContent = generateId(rows);
          row.cells[1].textContent = searchWord;
          row.cells[2].textContent = number;
          break;
        }
      }
    }
  }
}
</script>

</body>
</html>
