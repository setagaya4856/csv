<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>行動予定表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Handsontable（CDN） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

  <style>
    /* ====== 基本 ====== */
    body{ font-family:system-ui, sans-serif; width:95vw; margin:24px auto; padding:0 12px; }
    fieldset{ margin:12px 0; padding:12px; }
    label{ display:block; margin:6px 0 2px; }
    input{ padding:6px; width:100%; max-width:360px; }
    button{ margin:6px 6px 0 0; padding:6px 12px; cursor:pointer; }
    pre{ background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    /* Handsontable: 折返し禁止＋省略＋縦中央 */
    .htCore td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2; vertical-align:middle; }

    /* タブ風ボタン */
    .tabs{ display:flex; gap:6px; margin:8px 0 12px; }
    .tabs button{ padding:6px 10px; border:1px solid #ccc; background:#f6f6f6; border-radius:6px; }
    .tabs button.active{ background:#fff; border-color:#999; font-weight:600; box-shadow:0 1px 0 #ddd; }

    /* 部署色（8色バケット） */
    .dep-1{ background:#fff7e6 !important; }
    .dep-2{ background:#e6f7ff !important; }
    .dep-3{ background:#f9f0ff !important; }
    .dep-4{ background:#e6fffb !important; }
    .dep-5{ background:#f6ffed !important; }
    .dep-6{ background:#fff1f0 !important; }
    .dep-7{ background:#f0f5ff !important; }
    .dep-8{ background:#fefefe !important; }
    
    /* 部署ブロックの先頭行にだけ薄めの太線（自分の行 <-> 通常の中間） */
    .dep-head{
      box-shadow: inset 0 2px #888;   /* 自分の行(#333)より薄く、通常より濃く */
    }
    
    /* 自分の行の強調（太枠） */
    .my-row{
      background-color: rgba(33,150,243,0.1) !important; /* 薄いブルー */
    }
    
    /* 祝土日＆今日の強調 */
    .ht-today  { background:#fff9db !important; }
    .ht-sat    { background:#e6ffed !important; }
    .ht-sun    { background:#ffe5e5 !important; }
    .ht-holiday{ background:#ffe5e5 !important; }
    
    /* 休日 or 土日 + 自分の行：
       背景は休日色を優先、線で自分の行を残す */
    .my-row.ht-holiday,
    .my-row.ht-today,
    .my-row.ht-sun,
    .my-row.ht-sat {
      box-shadow: inset 0 2px rgba(33,150,243,0.4),
                  inset 0 -2px rgba(33,150,243,0.4);
    }
    
    .name-note{ font-size:.85em; color:#666; white-space:pre-wrap; }
    .hot-btn{ padding:4px 10px; border:1px solid #bbb; border-radius:6px; background:#fff; }
    .hot-btn:hover{ background:#f6f6f6; }

    /* 会社予定一覧ラッパ */
    #sched-list-wrap{ max-height:420px; overflow:auto; border:1px solid #ddd; border-radius:6px; padding:6px 8px; background:#fff; }
    #sched-list h3{ margin:6px 0; font-size:14px; }
    #sched-list li{ margin:2px 0; line-height:1.2; }

    /* 変更中セルの赤枠 */
    .dirty-cell{ outline:2px solid #e53935 !important; outline-offset:-2px; }

    /* イベント削除ボタン（管理者のみ可視） */
    .ev-item{ display:flex; align-items:flex-start; gap:8px; margin:4px 0; }
    .ev-main{ flex:1 1 auto; }
    .ev-del{ appearance:none; background:transparent; border:none; color:#e53935; font:inherit; padding:2px 6px; cursor:pointer; }
    .ev-del:hover{ text-decoration:underline; }

    /* 上部ツールバー */
    .tabsbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:space-between; margin:8px 0 12px; }
    .tabs-ctrl{ display:flex; align-items:center; gap:8px; }

    /* 入力エリア（クイック＋会社） */
    #quickRow{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; margin:6px 0 8px; }
    #quickEntry, #companyEntry{ flex:1 1 360px; min-width:320px; }

    .panel{ border:1px solid #ddd; border-radius:8px; padding:10px; height:auto; overflow:visible; background:#fff; }

    /* 汎用の＋／−ボタン */
    .icon-btn{ appearance:none; border:1px solid #bbb; background:#fff; border-radius:6px; padding:2px 8px; line-height:1.2; }
    .icon-btn:hover{ background:#f6f6f6; }

    /* 折り畳み用 */
    .is-hidden{ display:none !important; }

    /* 管理者専用可視領域 */
    .admin-only{ display:none; }
    .admin-visible .admin-only{ display:inline-block; }
    
    /* 未保存バッジは赤＆太め */
    #dirtyBadge { color:#d32f2f; font-weight:700; }
  </style>
</head>
<body>
  <!-- ログインモーダル（未ログイン時のみ表示） -->
  <div id="loginModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:9999;">
    <div style="max-width:500px;margin:10vh auto;padding:16px;background:#fff;border-radius:8px; box-shadow:0 8px 30px rgba(0,0,0,.12);">
      <h3 style="margin:0 0 8px">ログイン</h3>
      <form id="loginForm" autocomplete="on">
        <label for="email">メール</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" autocomplete="username" inputmode="email" required>
        <label for="password" style="margin-top:8px;">パスワード</label>
        <input id="password" name="password" type="password" placeholder="8文字以上" autocomplete="current-password" required>
        <div class="row" style="margin-top:8px">
          <button type="submit">ログイン</button>
        </div>
      </form>
    </div>
  </div>

  <h1 style="display:flex;align-items:center;gap:8px;">
    行動予定表
    <button id="run">更新</button>
    <button id="logoutBtn">ログアウト</button>
    <!-- ▼ クイック登録の開閉トグル（常時表示） -->
    <button id="toggleQuickEntryBtn" class="icon-btn" aria-expanded="false">＋</button>
    <button id="quickSaveBtn">クイック登録</button>
    <!-- ▼ 会社スケジュール追加のトグル＆追加ボタン（HTMLに常設, 管理者のみ可視） -->
    <button id="toggleCompanyAddBtn" class="icon-btn admin-only" aria-expanded="false">＋</button>
    <button id="companySaveBtn" class="admin-only" title="全体スケジュールを追加">全体表示登録</button>
    <p style="color:#666; font-size:.20em; margin:4px 0 0;">
  　　備考/内容で改行するときは <kbd>Alt</kbd>+<kbd>Enter</kbd> を使ってください
　　</p>
  </h1>

  <!-- ログイン後エリア -->
  <div id="appRoot" style="display:none">
    <div id="mainPanel" class="panel">
      <div id="quickRow">
        <div id="quickEntry"></div>
        <div id="companyEntry" class="is-hidden"></div>
      </div>

       <div class="tabsbar">
         <div id="matrixCtrl" class="tabs-ctrl">
           <button id="toggleCompanyListBtn" class="icon-btn" aria-expanded="true">−</button>
           <button id="saveMatrixBtn">保存</button>
           <span id="dirtyBadge">未保存の変更あり</span>
           <div id="month-tabs" class="tabs"></div>
         </div>
       </div>

      <div id="sched-list-wrap">
        <div id="sched-list"></div>
      </div>

      <div id="matrixGrid" style="width:100%;"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    /* ================================
       設定
    =================================*/
    const SUPABASE_URL = 'https://rqrgsytkxbhbrnrhqlca.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxcmdzeXRreGJoYnJucmhxbGNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2ODIyODMsImV4cCI6MjA3MTI1ODI4M30.LWeiva7gpFf9lHGuOKqzyr-tZihHuX9KdlHUjuqYDU0';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ================================
       DOM ショートカット
    =================================*/
    const $ = (q) => document.querySelector(q);

    /* ================================
       ローカルストレージラッパ
    =================================*/
    const _LS = { get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; }}, set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} } };
    
    /* ================================
       汎用ユーティリティ
    =================================*/
    function fnUrl(name){ return `${SUPABASE_URL}/functions/v1/${name}`; }
    async function fetchJsonStrict(fnName, opts){
      const res = await fetch(fnUrl(fnName), { cache:'no-store', ...opts });
      const text = await res.text();
      let json=null; try{ json = JSON.parse(text); }catch{}
      if(!res.ok || (json && json.ok===false)) throw new Error(json?.error || text || `HTTP ${res.status}`);
      return json ?? {};
    }

    function todayJST(){ const now = new Date(); return new Date(now.getTime() + (9*60 + now.getTimezoneOffset())*60000); }
    function ymOf(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function todayStrJST(){ const dt = new Date(); const f = new Intl.DateTimeFormat('ja-JP',{timeZone:'Asia/Tokyo',year:'numeric',month:'2-digit',day:'2-digit'}); const parts = Object.fromEntries(f.formatToParts(dt).map(p=>[p.type,p.value])); return `${parts.year}-${parts.month}-${parts.day}`; }

    /* ================================
       権限表示切り替え（★新設）
       - .admin-only を一括で可視/不可視
       - 会社追加欄の開閉状態を保持
    =================================*/
    function setAdminVisibility(isAdmin){
      document.body.classList.toggle('admin-visible', !!isAdmin);
      // 管理者でなければ会社追加欄は常に閉
      const entry = $('#companyEntry');
      if(!isAdmin && entry) entry.classList.add('is-hidden');
      const tgl = $('#toggleCompanyAddBtn');
      if(tgl){ tgl.setAttribute('aria-expanded', entry && !entry.classList.contains('is-hidden') ? 'true':'false'); }
    }

    /* ================================
       ログイン状態で UI 切替
    =================================*/
    function toggleUIBySession(isLoggedIn){
      $('#appRoot').style.display = isLoggedIn ? '' : 'none';
      $('#loginModal').style.display = isLoggedIn ? 'none' : '';
    }

    /* ================================
       従業員＆権限
    =================================*/
    let currentUser = { email:null, employee_id:null, is_admin:false };
    let employeesAll = [];
    let employeesVisible = []; // 表示用（is_active !== false のみ）
    async function loadCurrentUserAndEmployees(){
      const { data:{ session } } = await supabase.auth.getSession();
      const email = session?.user?.email ?? null;
      const { data: emps, error } = await supabase
        .from('employees')
        .select('id,name,email,department,note,row_index,is_admin,is_active')
        .order('row_index', { ascending:true })
        .order('name', { ascending:true });
      if(error) throw error;
      employeesAll = emps ?? [];
      employeesVisible = employeesAll.filter(e => e.is_active !== false);
      const me = employeesAll.find(e => (e.email||'').toLowerCase() === (email||'').toLowerCase());
      currentUser = { email, employee_id: me?.id ?? null, is_admin: !!me?.is_admin };
      setAdminVisibility(currentUser.is_admin);
      return currentUser;
    }

    /* ================================
       クイック登録 HOT
    =================================*/
    let quickHot=null, companyHot=null, hot=null; // companyHot: 会社予定追加, hot: マトリクス本体

    function renderQuickEntryHot(){
      const container = $('#quickEntry');
      const data = [{ date: todayStrJST(), am:'', pm:'' }];
      const settings = {
        data,
        columns:[
          { data:'date', type:'date', dateFormat:'YYYY-MM-DD', correctFormat:true, datePickerConfig:{ format:'YYYY-MM-DD', firstDay:0, i18n:{ previousMonth:'前月', nextMonth:'翌月', months:['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'], weekdays:['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'], weekdaysShort:['日','月','火','水','木','金','土'] } } },
          { data:'am', type:'text' },
          { data:'pm', type:'text' },
        ],
        colHeaders:['日付','午前','午後'], colWidths:[120,200,200], stretchH:'none', height:80,
        licenseKey:'non-commercial-and-evaluation',
        enterMoves:(e)=> (e && e.shiftKey ? {row:0,col:-1}:{row:0,col:1}),
      };
      if(quickHot) quickHot.updateSettings(settings); else quickHot = new Handsontable(container, settings);
    }

    $('#quickSaveBtn').addEventListener('click', async ()=>{
      if(!quickHot) return;
      const [date, am, pm] = quickHot.getDataAtRow(0).map(v => (v??'').toString().trim());
      await handleQuickSave({ date, am, pm });
    });

    /* ================================
       会社予定 追加 HOT
    =================================*/
    function normalizeHHMM(raw){ const s=String(raw||'').trim(); if(!s) return null; if(/^\d{4}$/.test(s)){ const hh=+s.slice(0,2), mm=+s.slice(2,4); if(hh>=0&&hh<=23&&mm>=0&&mm<=59) return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; return null; } if(/^\d{1,2}:\d{2}$/.test(s)){ const [h,m]=s.split(':').map(Number); if(h>=0&&h<=23&&m>=0&&m<=59) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; return null; } return null; }
    function isValidTimeHHMM(s){ return !s || normalizeHHMM(s)!=null; }

    function renderCompanyEntryHot(){
      const container = $('#companyEntry'); if(!container) return;
      const data = [{ 
        kind: 'event',              // 'event' or 'notice'
        date: todayStrJST(), 
        date_end: '',               // kind='notice'で使用（空は単日扱い）
        start: '', 
        end: '', 
        title: '',                  // 表示名（通達タイトル）
        memo: ''                    // 既存の補足
      }];
      const settings = {
        data,
        columns:[
          { data:'kind', type:'dropdown', source:['event','notice'] },
          { data:'date', type:'date', dateFormat:'YYYY-MM-DD', correctFormat:true, datePickerConfig:{ format:'YYYY-MM-DD', firstDay:0, i18n:{ previousMonth:'前月', nextMonth:'翌月', months:['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'], weekdays:['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'], weekdaysShort:['日','月','火','水','木','金','土'] } } },
          {
            data: 'date_end',
            type: 'date',
            dateFormat: 'YYYY-MM-DD',
            correctFormat: true,
            // 空（null/''）も許容したい場合はカスタムバリデータを付ける
            validator: (v, cb) => {
              if (v == null || v === '') return cb(true); // 未入力OK
              cb(/^\d{4}-\d{2}-\d{2}$/.test(String(v)));
            },
            allowInvalid: false,
            datePickerConfig: {
                format: 'YYYY-MM-DD',
                firstDay: 0,
                i18n: {
                previousMonth: '前月',
                nextMonth: '翌月',
                months: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
                weekdays: ['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'],
                weekdaysShort: ['日','月','火','水','木','金','土'],
              },
            }
          },
          { data:'start', type:'text', validator:(v,cb)=>cb(isValidTimeHHMM(v)), allowInvalid:false },
          { data:'end',   type:'text', validator:(v,cb)=>cb(isValidTimeHHMM(v)), allowInvalid:false },
          { data:'title', type:'text' },
          { data:'memo',  type:'text' },
        ],
        colHeaders: ['種別','開始日','終了日','開始(HH:MM)','終了(HH:MM)','行事名/タイトル','備考/内容'],
        colWidths:   [ 80,   120,    120,     120,          120,         240,            1000],
      };
      if(companyHot) companyHot.updateSettings(settings); else companyHot = new Handsontable(container, settings);
    }

    async function upsertCompanyEvent(payload){
      const { data:{ session } } = await supabase.auth.getSession();
      const token = session?.access_token; if(!token) throw new Error('未ログインです');
      return await fetchJsonStrict('company-events-upsert', {
        method:'POST', headers:{ 'Authorization':`Bearer ${token}`, 'Content-Type':'application/json' }, body:JSON.stringify(payload)
      });
    }

    /* ================================
       ログイン／ログアウト
    =================================*/
    $('#loginForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault(); const email=$('#email').value.trim(); const password=$('#password').value; alert('ログイン中...');
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) return alert('エラー: '+error.message);
      toggleUIBySession(true);
      await loadCurrentUserAndEmployees();
      // 初期構築
      if(!$('#month-tabs button')){ const { todayYm } = buildMonthTabs(); renderQuickEntryHot(); renderCompanyEntryHot(); await loadMonth(todayYm, { scrollToToday:true }); }
    });

    $('#logoutBtn')?.addEventListener('click', async ()=>{ await supabase.auth.signOut(); });

    /* ================================
       起動
    =================================*/
    document.addEventListener('DOMContentLoaded', async ()=>{
      const FORCE_LOGIN = new URLSearchParams(location.search).get('forceLogin') === '1';
      if(FORCE_LOGIN) await supabase.auth.signOut();
      await bootAppIfLoggedIn();
      supabase.auth.onAuthStateChange(async (evt, session)=>{
        toggleUIBySession(!!session);
        if(evt==='SIGNED_OUT') { dirtyCells.clear(); updateDirtyBadge(); return; }
        if(session){ await loadCurrentUserAndEmployees(); if(!$('#month-tabs button')){ const { todayYm } = buildMonthTabs(); renderQuickEntryHot(); renderCompanyEntryHot(); await loadMonth(todayYm, { scrollToToday:true }); } }
      });
    });

    async function bootAppIfLoggedIn(){
      const { data:{ session } } = await supabase.auth.getSession();
      toggleUIBySession(!!session); if(!session) return;
      const { todayYm } = buildMonthTabs(); renderQuickEntryHot(); renderCompanyEntryHot(); await loadCurrentUserAndEmployees(); await loadMonth(todayYm, { scrollToToday:true });
    }

    /* ================================
       ＋／− トグル（HTML常設版）
    =================================*/
    // クイック登録
    (function(){
      const key='open.quickEntry'; const btn=$('#toggleQuickEntryBtn'); const entry=$('#quickEntry');
      let open = _LS.get(key, false); // 既定は閉
      entry.classList.toggle('is-hidden', !open); btn.textContent = open?'−':'＋'; btn.setAttribute('aria-expanded', String(open));
      btn.addEventListener('click', ()=>{
        open=!open;
        entry.classList.toggle('is-hidden', !open);
        btn.textContent=open?'−':'＋';
        btn.setAttribute('aria-expanded', String(open));
        _LS.set(key, open); 
        if (open) {  // ★ 片方を開いたら会社追加は閉じる
          const b2 = document.getElementById('toggleCompanyAddBtn');
          const e2 = document.getElementById('companyEntry');
          if (b2 && e2 && !e2.classList.contains('is-hidden')) { b2.click(); }
        }
      });
    })();

    // 会社追加（管理者のみ可視だがボタン自体は常設）
    (function(){
      const key='open.companyEntry'; const btn=$('#toggleCompanyAddBtn'); const entry=$('#companyEntry');
      let open = _LS.get(key, false);
      entry.classList.toggle('is-hidden', !open); btn.textContent=open?'−':'＋'; btn.setAttribute('aria-expanded', String(open));
      btn.addEventListener('click', ()=>{
        open=!open;
        entry.classList.toggle('is-hidden', !open);
        btn.textContent=open?'−':'＋';
        btn.setAttribute('aria-expanded', String(open));
        _LS.set(key, open);
        if(open && !companyHot) renderCompanyEntryHot();
        if (open) {  // ★ 片方を開いたらクイック登録は閉じる
          const b1 = document.getElementById('toggleQuickEntryBtn');
          const e1 = document.getElementById('quickEntry');
          if (b1 && e1 && !e1.classList.contains('is-hidden')) { b1.click(); }
        }
      });
    })();

    // 会社予定一覧の開閉（常設）
    (function(){
      const key='open.companyList'; const btn=$('#toggleCompanyListBtn'); const wrap=$('#sched-list-wrap');
      if (localStorage.getItem(key) === null) {
       try { localStorage.setItem(key, 'true'); } catch {}
      }
      let open = _LS.get(key, true);
      const sync = () => {
        wrap.classList.toggle('is-hidden', !open);
        btn.textContent = open ? '−' : '＋';
        btn.setAttribute('aria-expanded', String(open));
      };
      sync();
      btn.addEventListener('click', ()=>{ open = !open; _LS.set(key, open); sync(); });
      window.__syncCompanyListToggle = () => { open = _LS.get(key, true); sync(); };// 他所で表示状態が変わる場合に備えて公開関数に
    })();

    /* ================================
       月タブとロード
    =================================*/
    window.__monthCache = window.__monthCache || new Map();
    var monthCache = window.__monthCache; // ← var でTDZなし、再評価にも強い
    
    function monthsAround(baseDate, back=3, forward=3){ const list=[]; const d=new Date(baseDate.getFullYear(), baseDate.getMonth()-back, 1); const end=new Date(baseDate.getFullYear(), baseDate.getMonth()+forward+1, 1); while(d<end){ list.push(ymOf(d)); d.setMonth(d.getMonth()+1,1);} return list; }

    function buildMonthTabs(baseDate = todayJST()){
      const months = monthsAround(baseDate, 3, 3); const todayYm = ymOf(baseDate); const wrap = $('#month-tabs'); wrap.innerHTML='';
      for(const ym of months){ const btn=document.createElement('button'); btn.textContent=ym; btn.dataset.month=ym; if(ym===todayYm) btn.classList.add('active'); btn.addEventListener('click', ()=>onMonthTabClick(btn)); wrap.appendChild(btn); }
      return { months, todayYm };
    }

    async function onMonthTabClick(btn){
      if(hasDirty()){ const ok = confirm('未保存の変更があります。月を移動すると破棄されます。移動しますか？'); if(!ok) return; clearAllDirty(); }
      $('#month-tabs button.active')?.classList.remove('active'); btn.classList.add('active');
      const ym = btn.dataset.month; const isThisMonth = ym === ymOf(todayJST()); await loadMonth(ym, { scrollToToday:isThisMonth });
    }
    
    function normalizeSchedules(json) {
      const arr0 = Array.isArray(json)
        ? json
        : (json?.items || json?.data || json?.schedules || null);
    
      if (arr0) {
        return arr0
          .map(x => {
            const pick = (obj, keys) => {
              for (const k of keys) {
                if (obj[k] != null) return obj[k];
                const lk = Object.keys(obj).find(t => t.toLowerCase() === k.toLowerCase());
                if (lk && obj[lk] != null) return obj[lk];
              }
              return undefined;
            };
            const title = pick(x, ['title','summary','name','subject']) ?? '';
            const date  = pick(x, ['date','day','dt']);
            const start = pick(x, ['start','start_at','startAt','start_time','startTime','from']) || date;
            const end   = pick(x, ['end','end_at','endAt','end_time','endTime','to']);
            const location = pick(x, ['location','place','where']) || '';
            const note = pick(x, ['note','notes','memo','description']) || '';
    
            const toDate = v => {
              if (!v) return null;
              if (/^\d{4}-\d{2}$/.test(v)) return new Date(v + '-01T00:00:00+09:00');
              if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return new Date(v + 'T00:00:00+09:00');
              const n = Number(v);
              if (!Number.isNaN(n) && String(v).length >= 10) return new Date(n);
              const d = new Date(v);
              return Number.isNaN(d.getTime()) ? null : d;
            };
    
            const dDate  = toDate(date);
            const dStart = toDate(start) || dDate;
            const dEnd   = toDate(end);
    
            return {
              raw: x,
              title: String(title || '(無題)'),
              start: dStart,
              end: dEnd,
              baseDate: dDate || dStart || null,
              location,
              note
            };
          })
          .filter(x => x.baseDate);
      }
      // schedules-get が { rows: [...] } を返すケース（AM/PM分割）
      if (json && Array.isArray(json.rows)) {
        const normDay = (s) => (String(s || '').trim().slice(0, 10));
        const items = [];
        for (const row of json.rows) {
          const emp = row.employee_name || row.name || '（未割当）';
          const cells = row.cells || {};
          for (const k of Object.keys(cells)) {
            const d = normDay(k);
            if (!d) continue;
            const cell = cells[k] || {};
    
            const pushOne = (txt, slot, hour) => {
              const t = (txt ?? '').toString().trim();
              if (!t) return;
              items.push({
                raw: { ...row, date: d, cell },
                employee_name: emp,
                title: t,
                slot,                                   // 'am' | 'pm'
                start: new Date(`${d}T${String(hour).padStart(2,'0')}:00:00+09:00`),
                end: null,
                baseDate: new Date(`${d}T00:00:00+09:00`),
                location: '',
                note: ''
              });
            };
    
            pushOne(cell.am, 'am', 9);
            pushOne(cell.pm, 'pm', 13);
          }
        }
        return items;
      }
    
      return [];
    }

    async function fetchMonthData(ym, token){
      if(monthCache.has(ym)) return monthCache.get(ym);
      const ts = Date.now();
      const res = await fetch(`${fnUrl('schedules-get')}?month=${encodeURIComponent(ym)}&_=${ts}`, { headers:{ Authorization:`Bearer ${token}` }, cache:'no-store' });
      const json = await res.json();
      const items = normalizeSchedules(json);
      monthCache.set(ym, items); return items;
    }

    async function loadMonth(ym, { scrollToToday }={}){
      const { data:{ session } } = await supabase.auth.getSession(); if(!session){ alert('未ログインです'); return; }
      try{
        const items = await fetchMonthData(ym, session.access_token);
        await renderCompanyEventList(ym);
        renderMatrixHot(items, ym, { scrollToToday });
        clearAllDirty();
        window.__syncCompanyListToggle?.(); // ← ボタン表示（＋／−）と実際の開閉を同期
      }catch(e){ alert('Fetchエラー: '+e.message); }
    }

    $('#run').addEventListener('click', async ()=>{
      const activeYm = $('#month-tabs button.active')?.dataset.month; const ym = activeYm || buildMonthTabs().todayYm;
      await loadMonth(ym, { scrollToToday: ym===ymOf(todayJST()) });
    });

    /* ================================
       クリップボード（右クリメニュー用）
    =================================*/
    const tsvFrom2D = (arr)=> arr.map(row=>row.map(v=> (v==null?'':String(v))).join('\t')).join('\n');
    const getSelectionBounds = (hot)=>{ const rng=hot.getSelectedRangeLast?.(); if(!rng) return null; const r1=Math.min(rng.from.row, rng.to.row), r2=Math.max(rng.from.row, rng.to.row), c1=Math.min(rng.from.col, rng.to.col), c2=Math.max(rng.from.col, rng.to.col); return { r1,r2,c1,c2 }; };
    async function copySelection(h){ const b=getSelectionBounds(h); if(!b) return; const data=h.getData(b.r1,b.c1,b.r2,b.c2); await navigator.clipboard.writeText(tsvFrom2D(data)); }
    async function cutSelection(h){ const b=getSelectionBounds(h); if(!b) return; const data=h.getData(b.r1,b.c1,b.r2,b.c2); await navigator.clipboard.writeText(tsvFrom2D(data)); for(let r=b.r1;r<=b.r2;r++){ for(let c=b.c1;c<=b.c2;c++) h.setDataAtCell(r,c,''); } }
    async function pasteFromClipboard(h){ const text=await navigator.clipboard.readText(); if(!text) return; const rows=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').map(line=>line.split('\t')); const rng=h.getSelectedRangeLast?.(); if(!rng){ alert('貼り付け先のセルを選択してください'); return; } const startRow=Math.min(rng.from.row, rng.to.row), startCol=Math.min(rng.from.col, rng.to.col); const endRow=startRow+rows.length-1, endCol=startCol+(rows[0]?.length??1)-1; if(containsReadOnlyInRange(h,startRow,startCol,endRow,endCol)){ alert('貼り付け先に読み取り専用セルが含まれているため、貼り付けできません。'); return; } rows.forEach((r,i)=> r.forEach((val,j)=> h.setDataAtCell(startRow+i, startCol+j, val))); }
    function containsReadOnlyInRange(h,r1,c1,r2,c2){ for(let r=r1;r<=r2;r++){ for(let c=c1;c<=c2;c++){ if(h.getCellMeta(r,c)?.readOnly) return true; } } return false; }

    /* ================================
       マトリクス構築（従業員全員／AMPM）
    =================================*/
    function buildFullMatrixWithEmployees(items, ym){
      const [y,m] = ym.split('-').map(Number); const last=new Date(y,m,0); const days=Array.from({length:last.getDate()},(_,i)=>i+1);
      const byEmpKey = new Map();
      for(const it of items){
        const row = it.raw || {}; const empId = row.employee_id || row.id || row.emp_id || null;
        const name = it.employee_name || row.employee_name || row.name || '（未割当）';
        const email = row.email || ''; const dep = row.department || ''; const note = row.note || '';
        const key = empId ?? `name:${name}`; if(!byEmpKey.has(key)) byEmpKey.set(key,{ employee_id:empId, name, email, department:dep, note, cells:{} });
        const d = it.baseDate.getDate(); if(!byEmpKey.get(key).cells[d]) byEmpKey.get(key).cells[d] = { am:[], pm:[] };
        const hour = it.start?.getHours() ?? 0; const slot = (it.slot==='am'||it.slot==='pm')?it.slot:(hour<12?'am':'pm');
        byEmpKey.get(key).cells[d][slot].push(it.title);
      }
      const rowsMeta = employeesVisible.slice().sort(
        (a,b)=>(a.row_index??0)-(b.row_index??0) || a.name.localeCompare(b.name,'ja')
      );
      const data=[], rowEmployees=[], colHeaders=['名前','メモ'], colDates=[null,null];
      for(const d of days){ colHeaders.push(`${m}/${d} 午前`, `${m}/${d} 午後`); const ds=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; colDates.push(ds, ds); }
      for(const emp of rowsMeta){ const key = emp.id ?? `name:${emp.name}`; const agg = byEmpKey.get(key); const row=[]; row.push(emp.name); row.push(emp.note||''); for(const d of days){ const am = agg?.cells?.[d]?.am?.join('\n') ?? ''; const pm = agg?.cells?.[d]?.pm?.join('\n') ?? ''; row.push(am, pm); } data.push(row); rowEmployees.push({ id:emp.id, name:emp.name, email:emp.email, department:emp.department, note:emp.note, is_admin:!!emp.is_admin }); }
      return { colHeaders, data, colDates, rowEmployees };
    }

    /* ================================
       条件付き書式 / レンダラー
    =================================*/
    const _measureCanvas = document.createElement('canvas');
    const _ctx = _measureCanvas.getContext('2d');
    function measureTextWidth(text, font){ _ctx.font = font; return _ctx.measureText(text).width; }
    function fitTextRenderer(instance, td, row, col, prop, value){
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      td.style.whiteSpace='nowrap'; td.style.overflow='hidden'; td.style.textOverflow='ellipsis';
      const raw = (value==null?'':String(value)); const show = raw.replace(/\r?\n/g, ' / ');
      const basePx=14, minPx=10; let fontPx=basePx; const padding=14; const colWidth=(instance.getColWidth(col)||td.clientWidth||100)-padding; const fontFamily=getComputedStyle(td).fontFamily||'system-ui,sans-serif'; const fontWeight=getComputedStyle(td).fontWeight||'normal';
      while(fontPx>minPx){ const font=`${fontWeight} ${fontPx}px ${fontFamily}`; const w=measureTextWidth(show,font); if(w<=colWidth) break; fontPx-=1; }
      td.style.fontSize=`${fontPx}px`; td.textContent=show;
    }

    function weekdayOf(y,m,d){ const t=[0,3,2,5,0,3,5,1,4,6,2,4]; if(m<3) y-=1; return (y+Math.floor(y/4)-Math.floor(y/100)+Math.floor(y/400)+t[m-1]+d)%7; }
    function stripDateClasses(className){ return String(className||'').split(/\s+/).filter(c=> c && c!=='ht-today' && c!=='ht-sat' && c!=='ht-sun').join(' '); }
    function classesByDate(ds, today){ if(!ds) return []; const [y,m,d]=ds.split('-').map(Number); const wd=weekdayOf(y,m,d); const arr=[]; if(ds===today) arr.push('ht-today'); if(wd===6) arr.push('ht-sat'); if(wd===0) arr.push('ht-sun'); return arr; }
    function classesByValue(value){ return String(value??'').includes('休') ? ['ht-holiday'] : []; }
    function applyValueRule(h,row,col,value){ if(col===0) return; const meta=h.getCellMeta(row,col); const keep=(meta.className||'').split(' ').filter(Boolean).filter(c=> c!=='ht-holiday'); const add=classesByValue(value); h.setCellMeta(row,col,'className', keep.concat(add).join(' ')); }
    function mergeClass(existing, add){ const arr=Array.isArray(add)?add:[add]; const set=new Set(String(existing||'').split(' ').filter(Boolean)); for(const c of arr) if(c) set.add(c); return Array.from(set).join(' '); }
    function isMyRow(rowIdx, rowEmployees, currentUser) {
      const emp = rowEmployees[rowIdx];
      if (!emp || !currentUser?.email) return false;
      return (emp.email || '').toLowerCase() === currentUser.email.toLowerCase();
    }
    /* ================================
       ホイール横スクロール
    =================================*/
    function enableHorizontalWheel(container, h){ if(container.dataset.hwBound==='1') return; container.dataset.hwBound='1'; const holder=container.querySelector('.ht_master .wtHolder'); if(!holder) return; holder.addEventListener('wheel',(e)=>{ const hasSel=!!h?.getSelectedRangeLast?.(); if(!hasSel) return; if(Math.abs(e.deltaY)>=Math.abs(e.deltaX)){ holder.scrollLeft += e.deltaY; e.preventDefault(); } }, { passive:false }); }

    /* ================================
       行編集権限 / スクロール
    =================================*/
    function scrollColumnToLeft(h, container, colIndex){ const holder=container.querySelector('.ht_master .wtHolder'); if(!holder) return; const fixed=h.getSettings().fixedColumnsStart||0; h.scrollViewportTo(0,colIndex); requestAnimationFrame(()=>{ let offset=0; for(let c=fixed; c<colIndex; c++){ offset += h.getColWidth(c) || 0; } holder.scrollLeft=Math.max(0, offset-4); }); }

    /* ================================
       未保存管理
    =================================*/
    let dirtyCells = new Set();
    const dirtyKey=(r,c)=>`${r}:${c}`;
    function addClassMeta(h,r,c,cls){ const meta=h.getCellMeta(r,c); const now=new Set(String(meta.className||'').split(/\s+/).filter(Boolean)); if(!now.has(cls)){ now.add(cls); h.setCellMeta(r,c,'className', Array.from(now).join(' ')); } }
    function removeClassMeta(h,r,c,cls){ const meta=h.getCellMeta(r,c); const next=String(meta.className||'').split(/\s+/).filter(x=>x&&x!==cls).join(' '); h.setCellMeta(r,c,'className', next); }
    function markDirty(row,col,yes){ const key=dirtyKey(row,col); if(yes){ dirtyCells.add(key); if(hot) addClassMeta(hot,row,col,'dirty-cell'); } else { dirtyCells.delete(key); if(hot) removeClassMeta(hot,row,col,'dirty-cell'); } const td=hot?.getCell(row,col); if(td) td.classList.toggle('dirty-cell', !!yes); updateDirtyBadge(); }
    function clearAllDirty(){ for(const k of dirtyCells){ const [r,c]=k.split(':').map(Number); if(hot) removeClassMeta(hot,r,c,'dirty-cell'); const td=hot?.getCell(r,c); if(td) td.classList.remove('dirty-cell'); } dirtyCells.clear(); updateDirtyBadge(); }
    function hasDirty(){ return dirtyCells.size>0; }
    function updateDirtyBadge(){ const el=$('#dirtyBadge'); if(!el) return; el.style.display = hasDirty()? '':'none'; }

    /* ================================
       マトリクス描画
    =================================*/
    function renderMatrixHot(items, ym, opts={}){
      const { colHeaders, data, colDates, rowEmployees } = buildFullMatrixWithEmployees(items, ym);
      const container = $('#matrixGrid'); const today = todayStrJST();
      const canEditRow = (rowIdx)=> currentUser.is_admin || ((rowEmployees[rowIdx]?.email||'').toLowerCase() === (currentUser.email||'').toLowerCase());
      const settings = {
        data, colHeaders, rowHeaders:true, licenseKey:'non-commercial-and-evaluation', fixedColumnsStart:2,
        enterMoves:(e)=>(e&&e.shiftKey?{row:0,col:-1}:{row:0,col:1}),
        cells:(row,col)=>({ renderer:fitTextRenderer }),
        contextMenu:{ items:{ copyCustom:{ name:'コピー', callback:()=>copySelection(hot), disabled:()=>!hot.getSelectedRangeLast?.()||!navigator.clipboard?.writeText }, cutCustom:{ name:'切り取り', callback:()=>cutSelection(hot), disabled:()=>!hot.getSelectedRangeLast?.()||!navigator.clipboard?.writeText }, pasteCustom:{ name:'貼り付け', callback:()=>pasteFromClipboard(hot), disabled:()=>!navigator.clipboard?.readText }, '--------': Handsontable.plugins.ContextMenu.SEPARATOR, undo:{name:'元に戻す'}, redo:{name:'やり直す'} } },
        maxRows:data.length, maxCols:colHeaders.length, fillHandle:{ autoInsertRow:false }, copyPaste:true, selectionMode:'multiple',
        beforeCreateRow:()=>false, beforeRemoveRow:()=>false, beforeCreateCol:()=>false, beforeRemoveCol:()=>false,
        beforePaste:(data, coords)=>{ for(const sel of coords||[]){ const { startRow,startCol,endRow,endCol }=sel; for(let r=startRow;r<=endRow;r++){ if(!canEditRow(r)) return false; } if(containsReadOnlyInRange(hot,startRow,startCol,endRow,endCol)){ alert('貼り付け先に読み取り専用セルが含まれているため、貼り付けできません。'); return false; } }
        },
        afterGetCellMeta:(row,col,props)=>{
          const ds = colDates[col]; const emp=rowEmployees[row];
          const prevDep = row>0 ? rowEmployees[row-1]?.department : null;
          const isDeptHead = row===0 || (emp?.department !== prevDep);
          if(col===0 || col===1){
            const bucket=bucketByDepartment(emp?.department);
            props.className = mergeClass(props.className, `dep-${bucket}`);
            if(col===0) props.readOnly=true; else props.readOnly = !canEditRow(row);
            if(isMyRow(row,rowEmployees,currentUser)) props.className = mergeClass(props.className,'my-row');
            if(isDeptHead) props.className = mergeClass(props.className,'dep-head');
            return;
          }
          props.className = stripDateClasses(props.className); if(ds){ props.className = mergeClass(props.className, classesByDate(ds, today)); }
          props.readOnly = !canEditRow(row); if(isMyRow(row,rowEmployees,currentUser)) props.className = mergeClass(props.className,'my-row'); if(isDeptHead) props.className = mergeClass(props.className,'dep-head');
        },
        afterChange:(changes, source)=>{
          if(!changes) return; const userSources=new Set(['edit','CopyPaste.paste','Autofill.fill','UndoRedo.undo','UndoRedo.redo']); const isUser=userSources.has(source);
          for(const [row,col,_oldVal,newVal] of changes){ applyValueRule(hot,row,col,newVal); if(isUser && col>=2){ markDirty(row,col,true); } }
          hot.render();
        },
        stretchH:'all', height:1000,
        colWidths:(i)=> (i===0?110:(i===1?180:110)),
      };
      settings._rowEmployees=rowEmployees; settings._colDates=colDates;
      if(hot){ hot.updateSettings(settings); hot.render(); } else { hot = new Handsontable(container, settings); }
      for(let r=0;r<data.length;r++){ for(let c=1;c<colHeaders.length;c++){ applyValueRule(hot,r,c,data[r][c]); } }
      hot.render();
      // スクロール
      if(opts.scrollToToday){ const base=todayJST(); const d=base.getDate(); const amCol=1+2*(d-1); const col=Math.min(amCol, colHeaders.length-1); hot.addHookOnce('afterRender', ()=>scrollColumnToLeft(hot, container, col)); hot.render(); }
      else { hot.addHookOnce('afterRender', ()=>scrollColumnToLeft(hot, container, 1)); hot.render(); }
      enableHorizontalWheel(container, hot);
    }

    function bucketByDepartment(dep){ const s=String(dep||''); let h=0; for(let i=0;i<s.length;i++) h=(h*31 + s.charCodeAt(i))>>>0; return (h%8)+1; }

    /* ================================
       保存
    =================================*/
    $('#saveMatrixBtn')?.addEventListener('click', async ()=>{
      if(!hot) return; if(!hasDirty()) return alert('未保存の変更はありません');
      const settings=hot.getSettings(); const colDates=settings._colDates; const rowEmployees=settings._rowEmployees;
      const { data:{ session } } = await supabase.auth.getSession(); const token=session?.access_token; if(!token) return alert('未ログインです');
      const upserts=[], deletes=[]; const memoUpdates=new Map();
      for(const key of dirtyCells){ const [row,col]=key.split(':').map(Number); if(col===1){ const emp=rowEmployees[row]; if(emp?.id){ const note=(hot.getDataAtCell(row,1)??'').toString(); memoUpdates.set(emp.id, note); } continue; } if(col<2) continue; const emp=rowEmployees[row]; const ds=colDates[col]; if(!emp?.id || !ds) continue; const slot=((col-2)%2===0)?'am':'pm'; const val=(hot.getDataAtCell(row,col)??'').toString().trim(); if(val){ upserts.push({ employee_id:emp.id, date:ds, slot, place:val }); } else { deletes.push({ employee_id:emp.id, date:ds, slot }); } }
      try{
        for(const [employee_id,note] of memoUpdates){ const res=await fetch(fnUrl('employee-note-update'),{ method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body:JSON.stringify({ employee_id, note }), cache:'no-store' }); const txt=await res.text(); let j=null; try{ j=JSON.parse(txt);}catch{} if(!res.ok || (j&&j.ok===false)) throw new Error(j?.error||txt||`HTTP ${res.status}`); const emp=employeesAll.find(e=>e.id===employee_id); if(emp) emp.note=note; }
        if(deletes.length){ const r=await fetch(fnUrl('schedules-delete'),{ method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(deletes), cache:'no-store' }); const j=await r.json().catch(()=>({})); if(!r.ok || !j?.ok) throw new Error(j?.error||`delete HTTP ${r.status}`); }
        if(upserts.length){ const r=await fetch(fnUrl('schedules-upsert'),{ method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(upserts), cache:'no-store' }); const j=await r.json().catch(()=>({})); if(!r.ok || !j?.ok) throw new Error(j?.error||`upsert HTTP ${r.status}`); }
        await loadCurrentUserAndEmployees();
        const ymSet=new Set([...dirtyCells].map(k=> colDates[Number(k.split(':')[1])]?.slice(0,7)).filter(Boolean)); for(const ym of ymSet) monthCache.delete(ym);
        clearAllDirty(); const activeYm=$('#month-tabs button.active')?.dataset.month; if(activeYm) await loadMonth(activeYm,{ scrollToToday: (activeYm===ymOf(todayJST())) });
        const memoEdits = memoUpdates.size;
        alert(`保存しました：メモ ${memoEdits} / 予定 変更 ${upserts.length} / 削除 ${deletes.length}`);
      }catch(e){ console.error(e); alert('保存に失敗しました：'+e.message); }
    });

    /* ================================
       クイック登録 保存
    =================================*/
    let myEmployeeId=null, myEmail=null;
    async function ensureMyEmployeeId(){ if(myEmployeeId) return myEmployeeId; const { data:{ session } } = await supabase.auth.getSession(); if(!session) throw new Error('未ログインです'); myEmail=session.user?.email||null; if(!myEmail) throw new Error('メールが取得できません'); const { data, error } = await supabase.from('employees').select('id,email').eq('email', myEmail).maybeSingle(); if(error) throw error; if(!data) throw new Error(`employees に email=${myEmail} が見つかりません`); myEmployeeId=data.id; return myEmployeeId; }

    function ymFromYmd(ymd){ return String(ymd||'').slice(0,7); }

    async function handleQuickSave({ date, am, pm }){
      const ymd=String(date||'').trim(); if(!/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return alert('日付は YYYY-MM-DD 形式で入力してください');
      const amText=String(am??'').trim(), pmText=String(pm??'').trim(); const employee_id = await ensureMyEmployeeId();
      const upserts=[], deletes=[]; if(amText) upserts.push({ employee_id, date:ymd, slot:'am', place:amText }); else deletes.push({ employee_id, date:ymd, slot:'am' }); if(pmText) upserts.push({ employee_id, date:ymd, slot:'pm', place:pmText }); else deletes.push({ employee_id, date:ymd, slot:'pm' });
      const { data:{ session } } = await supabase.auth.getSession(); const token=session?.access_token; if(!token) return alert('アクセストークンが取得できません（未ログインの可能性）');
      try{
        if(deletes.length){ const r=await fetch(fnUrl('schedules-delete'),{ method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(deletes) }); const j=await r.json().catch(()=>({})); if(!r.ok || !j?.ok) throw new Error(`削除失敗: ${j?.error||`HTTP ${r.status}`}`); }
        if(upserts.length){ const r=await fetch(fnUrl('schedules-upsert'),{ method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body:JSON.stringify(upserts) }); const j=await r.json().catch(()=>({})); if(!r.ok || !j?.ok) throw new Error(`保存失敗: ${j?.error||`HTTP ${r.status}`}`); }
        const ym = ymFromYmd(ymd); monthCache.delete(ym); alert('更新しました'); await selectMonthAndReload(ym, { scrollToToday:false });
      }catch(e){ console.error(e); alert('保存に失敗しました：'+e.message); }
    }

    async function selectMonthAndReload(ym, { scrollToToday=false }={}){
      let btn = document.querySelector(`#month-tabs button[data-month="${ym}"]`); if(!btn){ buildMonthTabsFor(ym); btn = document.querySelector(`#month-tabs button[data-month="${ym}"]`); }
      document.querySelectorAll('#month-tabs button').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); await loadMonth(ym, { scrollToToday });
    }

    function buildMonthTabsFor(baseYm){ const [y,m]=baseYm.split('-').map(Number); const base=new Date(y,m-1,1); const months=monthsAround(base,3,3); const wrap=$('#month-tabs'); wrap.innerHTML=''; for(const ym of months){ const b=document.createElement('button'); b.textContent=ym; b.dataset.month=ym; b.addEventListener('click', ()=>onMonthTabClick(b)); wrap.appendChild(b); } return months; }

    /* ================================
       会社予定一覧（削除ボタンは常に描画→CSSで admin-only）
    =================================*/
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    async function fetchCompanyEventsForMonth(ym){
      const [y,m]=ym.split('-').map(Number); const start=new Date(y,m-1,1); const end=new Date(y,m,1);
      const d2=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const { data, error } = await supabase
        .from('company_events')
        .select('id, kind, date, date_end, timestart, timeend, event, memo')
        // 期間が当月と交差するもの（date_end NULL は単日とみなす）
        .or(`and(date.gte.${d2(start)},date.lt.${d2(end)}),and(date.lte.${d2(end)},date_end.gte.${d2(start)})`)
        .order('date', { ascending: true })
        .order('timestart', { ascending: true });
      if(error) throw error; return data||[];
    }

    async function renderCompanyEventList(ym) {
      const listEl   = $('#sched-list');
      const toggleBtn = $('#toggleCompanyListBtn');
    
      try {
        const events = await fetchCompanyEventsForMonth(ym);
    
        // トグルの状態ヒント
        if (toggleBtn) {
          toggleBtn.disabled = false;
          toggleBtn.title = events.length ? '会社予定を開閉' : 'この月は会社予定がありません（開閉可）';
        }
    
        // 0件時：該当なし＋強制的に開く（初回オン維持のため）
        if (!events.length) {
          listEl.innerHTML = '<p>該当なし</p>';
          const wrap = document.getElementById('sched-list-wrap');
          if (wrap) {
            wrap.classList.remove('is-hidden');
            try { localStorage.setItem('open.companyList', 'true'); } catch {}
          }
          window.__syncCompanyListToggle?.();
          return;
        }
    
        // ★ notice を先（優先表示）、ついでに event
        const notices = events.filter(ev => ev.kind === 'notice');
        const normals = events.filter(ev => ev.kind !== 'notice');
    
        // 日付/時間で並べ替え（安定ソート）
        notices.sort((a, b) =>
          (a.date || '').localeCompare(b.date || '') ||
          (a.date_end || '').localeCompare(b.date_end || '') ||
          (a.event || '').localeCompare(b.event || '', 'ja')
        );
        normals.sort((a, b) =>
          (a.date || '').localeCompare(b.date || '') ||
          (a.timestart || '').localeCompare(b.timestart || '') ||
          (a.event || '').localeCompare(b.event || '', 'ja')
        );
    
        let html = '';
    
        // 1) お知らせ（見出しなし、上に固めて表示）
        for (const ev of notices) {
          const memo  = ev.memo
            ? `<div style="color:#333; font-size:.9em; white-space:pre-wrap; margin-top:2px;">${escapeHtml(ev.memo)}</div>`
            : '';
          const delBtn = currentUser?.is_admin
            ? `<button class="ev-del admin-only" data-ev-id="${ev.id}">削除</button>`
            : '';
          html += `
            <div class="ev-item" style="border-left:4px solid #9c27b0; padding-left:8px; margin:6px 0;">
              ${delBtn}
              <div class="ev-main">
                <div style="font-weight:700; white-space:pre-wrap;">${escapeHtml(ev.event)}</div>
                ${memo}
              </div>
            </div>`;
        }
    
        // 2) 通常イベント：日付ごとに見出し
        const groups = new Map();
        for (const ev of normals) {
          const day = ev.date;
          if (!groups.has(day)) groups.set(day, []);
          groups.get(day).push(ev);
        }
    
        for (const [day, arr] of groups) {
          const d  = new Date(`${day}T00:00:00`);
          const wd = '日月火水木金土'[d.getDay()];
          html += `<h3>${day}（${wd}）</h3><ul style="margin:0 0 8px 16px; padding:0">`;
    
          // 同日内は時刻→タイトル
          arr.sort((a, b) =>
            (a.timestart || '').localeCompare(b.timestart || '') ||
            (a.event     || '').localeCompare(b.event     || '', 'ja')
          );
    
          for (const ev of arr) {
            const tstart = ev.timestart ? ev.timestart.slice(0, 5) : '';
            const tend   = ev.timeend   ? ev.timeend.slice(0, 5)   : '';
            const time   = tstart && tend ? `${tstart}–${tend}` : (tstart || '');
            const memo   = ev.memo
              ? `<div style="color:#666; font-size:.9em; white-space:pre-wrap">${escapeHtml(ev.memo)}</div>`
              : '';
            const delBtn = currentUser?.is_admin
              ? `<button class="ev-del admin-only" data-ev-id="${ev.id}">削除</button>`
              : '';
    
            html += `
              <li class="ev-item">
                ${delBtn}
                <div class="ev-main">
                  <strong style="white-space:pre-wrap">${escapeHtml(ev.event)}</strong> ${time}
                  ${memo}
                </div>
              </li>`;
          }
          html += `</ul>`;
        }
    
        listEl.innerHTML = html;
        window.__syncCompanyListToggle?.();
    
      } catch (e) {
        // フェイルセーフ：空にして落ちないように
        listEl.innerHTML = '';
        console.error(e);
      }
    }

    async function deleteCompanyEventById(id){ const { data:{ session } } = await supabase.auth.getSession(); const token=session?.access_token; if(!token) throw new Error('未ログインです'); const res=await fetch(fnUrl('company-events-delete'),{ method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}, body:JSON.stringify({ id }), cache:'no-store' }); const text=await res.text(); let json=null; try{ json=JSON.parse(text);}catch{} if(!res.ok || (json&&json.ok===false)) throw new Error(json?.error||text||`HTTP ${res.status}`); return json??{}; }

    $('#sched-list')?.addEventListener('click', async (e)=>{
      const btn = e.target instanceof HTMLElement ? e.target.closest('button.ev-del') : null; if(!btn) return;
      if(!currentUser?.is_admin) return alert('権限がありません');
      const id = btn.getAttribute('data-ev-id'); if(!id) return; if(!confirm('この全体スケジュールを削除します。よろしいですか？')) return;
      try{ await deleteCompanyEventById(id); const activeYm=$('#month-tabs button.active')?.dataset.month; if(activeYm) await renderCompanyEventList(activeYm); alert('削除しました'); }catch(err){ console.error(err); alert('削除に失敗しました：'+err.message); }
    });

    // 会社予定の追加ボタン（常設・管理者のみ可視）
    document.addEventListener('click', async (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      if (t.id !== 'companySaveBtn') return;
    
      if (!currentUser?.is_admin) { alert('権限がありません'); return; }
      if (!companyHot) return;
    
      try {
        const [kind, date, date_end, startRaw, endRaw, title, memo] =
          companyHot.getDataAtRow(0).map(v => (v ?? '').toString().trim());
    
        if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { alert('日付は YYYY-MM-DD で入力してください'); return; }
        if (!title) { alert('行事名を入力してください'); return; }
    
        const start = (kind === 'event') ? normalizeHHMM(startRaw) : null;
        const end   = (kind === 'event') ? normalizeHHMM(endRaw)   : null;
        if (kind === 'event') {
          if (startRaw && !start) { alert('開始は 0930 または 09:30 の形式で入力してください'); return; }
          if (endRaw   && !end)   { alert('終了は 1730 または 17:30 の形式で入力してください'); return; }
        }
        const dateEndIso = (date_end && /^\d{4}-\d{2}-\d{2}$/.test(date_end)) ? date_end : null;
    
        await upsertCompanyEvent({
          kind, date, date_end: dateEndIso,
          timestart: start, timeend: end,
          event: title, memo
        });
    
        const activeYm = document.querySelector('#month-tabs button.active')?.dataset.month;
        if (activeYm) await renderCompanyEventList(activeYm);
        alert('全体スケジュールを追加しました');
      } catch (err) {
        console.error(err);
        alert('追加に失敗しました：' + err.message);
      }
    });
  </script>
</body>
</html>
