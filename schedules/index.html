<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Supabase Edge Function テスト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ▼ Handsontable（CDN） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">

  <style>
    /* セル折返し（複数予定を改行で表示） */
    .htCore td { white-space: pre-wrap; line-height: 1.2; }
    body{font-family:system-ui, sans-serif; max-width:860px; margin:24px auto; padding:0 12px;}
    fieldset{margin:12px 0; padding:12px;}
    label{display:block; margin:6px 0 2px;}
    input{padding:6px; width:100%; max-width:360px;}
    button{margin:6px 6px 0 0; padding:6px 12px;}
    pre{background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  </style>
</head>
<body>
  <h1>Supabase Edge Function テスト</h1>

  <fieldset>
    <legend>設定</legend>
    <div class="row">
      <label>SUPABASE_URL</label>
      <input id="url" placeholder="https://rqrgsytkxbhbrnrhqlca.supabase.co" />
    </div>
    <div class="row">
      <label>ANON_KEY</label>
      <input id="anon" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxcmdzeXRreGJoYnJucmhxbGNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2ODIyODMsImV4cCI6MjA3MTI1ODI4M30.LWeiva7gpFf9lHGuOKqzyr-tZihHuX9KdlHUjuqYDU0" />
    </div>
    <button id="init">Supabase 初期化</button>
  </fieldset>

  <fieldset>
    <legend>ログイン</legend>
    <label>メールアドレス</label>
    <input id="email" type="email" placeholder="you@example.com" />
    <label>パスワード（パスワード方式で使う場合）</label>
    <input id="password" type="password" placeholder="8文字以上" />
    <div class="row">
      <button id="login-pw">メール＋パスワードでログイン</button>
      <button id="signup-pw">（初回）メール＋パスワードでサインアップ</button>
      <button id="login-otp">マジックリンク送信（メールOTP）</button>
      <button id="logout">ログアウト</button>
    </div>
    <div id="who" style="margin-top:6px;color:#333;"></div>
  </fieldset>

  <fieldset>
    <legend>関数呼び出し</legend>
    <div class="row">
      <label>month（YYYY-MM）</label>
      <input id="month" value="2025-09" />
    </div>
    <button id="run">/functions/v1/schedules-get を叩く</button>
    <pre id="output">ここに結果が出ます</pre>
    <div id="sched-summary" style="margin:12px 0;color:#555;"></div>
    <div class="row" style="gap:12px">
      <div style="flex:1 1 380px;min-width:320px">
        <h2 style="margin:8px 0">スケジュール一覧</h2>
        <div id="sched-list"></div>
      </div>
      <div style="flex:1 1 380px;min-width:320px">
        <h2 style="margin:8px 0">カレンダー</h2>
        <div id="sched-calendar"></div>
      </div>
    </div>

    <h2 style="margin:16px 0 8px">従業員 × 日付 マトリクス</h2>
    <div id="matrixGrid" style="height:520px;width:100%;"></div>
  </fieldset>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import Handsontable from 'https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js';

    let supabase = null;

    const $ = (q) => document.querySelector(q);
    const out = $('#output');
    const who = $('#who');

    function log(msg){ out.textContent += (out.textContent ? "\n" : "") + msg; }
    function setUser(u){
      who.textContent = u ? `ログイン中: ${u.email}` : '未ログイン';
    }

    // 初期化
    $('#init').addEventListener('click', () => {
      const url = $('#url').value.trim();
      const anon = $('#anon').value.trim();
      if (!url || !anon) { alert('SUPABASE_URL と ANON_KEY を入れてください'); return; }
      supabase = createClient(url, anon);
      out.textContent = 'Supabase 初期化完了';
      supabase.auth.getSession().then(({ data: { session }}) => setUser(session?.user ?? null));
      supabase.auth.onAuthStateChange((evt, session) => setUser(session?.user ?? null));
    });

    // パスワードでログイン
    $('#login-pw').addEventListener('click', async () => {
      if (!supabase) return alert('先に「Supabase 初期化」を押してください');
      const email = $('#email').value.trim();
      const password = $('#password').value;
      out.textContent = 'ログイン中...';
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) out.textContent = 'エラー: ' + error.message;
      else out.textContent = 'ログイン成功';
      setUser(data.user);
    });

    // パスワードでサインアップ
    $('#signup-pw').addEventListener('click', async () => {
      if (!supabase) return alert('先に「Supーム゙ース 初期化」を押してください');
      const email = $('#email').value.trim();
      const password = $('#password').value;
      out.textContent = 'サインアップ中...';
      const { data, error } = await supabase.auth.signUp({ email, password,
        options: { emailRedirectTo: 'https://setagaya4856.github.io/csv/schedules/' }
      });
      if (error) out.textContent = 'エラー: ' + error.message;
      else out.textContent = 'サインアップ完了。メールの確認が必要な場合があります。';
      setUser(data.user);
    });

    // マジックリンク（OTP）
    $('#login-otp').addEventListener('click', async () => {
      if (!supabase) return alert('先に「Supabase 初期化」を押してください');
      const email = $('#email').value.trim();
      out.textContent = 'マジックリンク送信中...';
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: location.origin }
      });
      out.textContent = error ? ('エラー: ' + error.message) : 'メールを確認してリンクを開いてください';
    });

    // ログアウト
    $('#logout').addEventListener('click', async () => {
      if (!supabase) return alert('先に「Supabase 初期化」を押してください');
      await supabase.auth.signOut();
      setUser(null);
      out.textContent = 'ログアウトしました';
    });

    // ====== Schedules 呼び出し ======
    $('#run').addEventListener('click', async () => {
      if (!supabase) return alert('先に「Supabase 初期化」を押してください');
      out.textContent = '呼び出し中...';

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { out.textContent = '未ログインです'; return; }

      const token = session.access_token;
      const url = $('#url').value.trim();
      const month = $('#month').value.trim();

      try {
        const res = await fetch(`${url}/functions/v1/schedules-get?month=${encodeURIComponent(month)}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const json = await res.json();
        out.textContent = JSON.stringify(json, null, 2);
        renderSchedules(json, month);
        renderMatrixHot(normalizeSchedules(json), month); // ← Handsontable描画
      } catch (e) {
        out.textContent = 'Fetchエラー: ' + e.message;
      }
    });

    // ====== マトリクス（Handsontable） ======
    // 既存 buildMatrix を活かしつつ、2次元配列に詰め替え
    const CELL_MODE = 'titles';
    function extractEmployeeName(item) {
      const r = item.raw || {};
      return item.employee_name || r.employee_name || r.employee || r.user || r.name || r.assignee || '（未割当）';
    }

    function buildMatrix(items, ym) {
      const [y, m] = ym.split('-').map(Number);
      const last = new Date(y, m, 0);
      const days = Array.from({ length: last.getDate() }, (_, i) => i + 1);

      const byEmp = new Map();
      for (const it of items) {
        const emp = extractEmployeeName(it);
        if (!byEmp.has(emp)) byEmp.set(emp, {});
        const d = it.baseDate.getDate();
        if (!byEmp.get(emp)[d]) byEmp.get(emp)[d] = [];
        byEmp.get(emp)[d].push(it);
      }

      const rows = [];
      for (const [emp, perDay] of byEmp) {
        const row = { name: emp };
        for (const d of days) {
          const arr = perDay[d] || [];
          if (CELL_MODE === 'count') {
            row[d] = arr.length || '';
          } else if (CELL_MODE === 'first') {
            row[d] = arr.length ? arr[0].title : '';
          } else {
            row[d] = arr.map(a => a.title).join('\n');
          }
        }
        rows.push(row);
      }

      const colDefs = [
        { headerName: '名前', field: 'name' },
        ...days.map(d => ({ headerName: String(d), field: String(d) })),
      ];
      return { colDefs, rowData: rows, days };
    }

    let hot = null;

    function renderMatrixHot(items, ym) {
      const { colDefs, rowData, days } = buildMatrix(items, ym);

      // 2次元配列へ変換（[ [名前, 1,2,3,...], ... ]）
      const colHeaders = colDefs.map(c => c.headerName);
      const data = rowData.map(r => {
        const row = [r.name];
        for (const d of days) row.push(r[d] ?? '');
        return row;
      });

      const container = document.getElementById('matrixGrid');

      if (hot) {
        hot.updateSettings({ data, colHeaders });
        hot.render();
        return;
      }

      hot = new Handsontable(container, {
        data,
        colHeaders,
        rowHeaders: true,
        contextMenu: true,           // 右クリックメニュー
        manualRowResize: true,
        manualColumnResize: true,
        licenseKey: 'non-commercial-and-evaluation', // 評価/非商用

        // Excelっぽい操作
        fillHandle: true,            // オートフィル（ドラッグ複製）
        copyPaste: true,             // クリップボード
        selectionMode: 'multiple',   // 複数範囲選択OK

        // 見やすさ調整
        stretchH: 'all',
        height: 520,
        colWidths: (index) => index === 0 ? 160 : 110,
        cells: (row, col) => {
          // 1列目（名前）は編集不可
          if (col === 0) return { readOnly: true };
        }
      });
    }

    // ====== スケジュール：整形・表示（既存） ======
    function normalizeSchedules(json) {
      const arr0 = Array.isArray(json) ? json : (json?.items || json?.data || json?.schedules || null);
      if (arr0) {
        return arr0.map(x => {
          const pick = (obj, keys) => {
            for (const k of keys) {
              if (obj[k] != null) return obj[k];
              const lk = Object.keys(obj).find(t => t.toLowerCase() === k.toLowerCase());
              if (lk && obj[lk] != null) return obj[lk];
            }
            return undefined;
          };
          const title = pick(x, ['title','summary','name','subject']) ?? '';
          const date  = pick(x, ['date','day','dt']);
          const start = pick(x, ['start','start_at','startAt','start_time','startTime','from']) || date;
          const end   = pick(x, ['end','end_at','endAt','end_time','endTime','to']);
          const location = pick(x, ['location','place','where']) || '';
          const note = pick(x, ['note','notes','memo','description']) || '';

          const toDate = v => {
            if (!v) return null;
            if (/^\d{4}-\d{2}$/.test(v)) return new Date(v + '-01T00:00:00+09:00');
            if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return new Date(v + 'T00:00:00+09:00');
            const n = Number(v);
            if (!Number.isNaN(n) && String(v).length >= 10) return new Date(n);
            const d = new Date(v);
            return Number.isNaN(d.getTime()) ? null : d;
          };

          const dDate  = toDate(date);
          const dStart = toDate(start) || dDate;
          const dEnd   = toDate(end);

          return {
            raw: x,
            title: String(title || '(無題)'),
            start: dStart,
            end: dEnd,
            baseDate: dDate || dStart || null,
            location,
            note
          };
        }).filter(x => x.baseDate);
      }

      if (json && Array.isArray(json.rows)) {
        const normDay = (s) => (String(s || '').trim().slice(0, 10));
        const daysFromRows = (() => {
          const set = new Set();
          for (const row of json.rows) {
            const cells = row?.cells || {};
            for (const k of Object.keys(cells)) set.add(normDay(k));
          }
          return Array.from(set).sort();
        })();
        const days = Array.isArray(json.days) && json.days.length ? json.days.map(normDay) : daysFromRows;

        const items = [];
        for (const row of json.rows) {
          const emp = row.employee_name || row.name || '（未割当）';
          const cells = row.cells || {};
          for (const k of Object.keys(cells)) {
            const d = normDay(k);
            if (!d) continue;
            const cell = cells[k] || {};
            const toTitle = v => (v == null ? '' : String(v).trim());
            const titles = [toTitle(cell.am), toTitle(cell.pm)].filter(t => t !== '');
            if (titles.length === 0) continue;

            items.push({
              raw: { ...row, date: d, cell },
              employee_name: emp,
              title: titles.join('\n'),
              start: new Date(`${d}T00:00:00`),
              end: null,
              baseDate: new Date(`${d}T00:00:00`),
              location: '',
              note: ''
            });
          }
        }
        return items;
      }
      return [];
    }

    function fmtDate(d) {
      if (!d) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      const wd = '日月火水木金土'[d.getDay()];
      return `${y}-${m}-${da}（${wd}）`;
    }
    function fmtTime(d) {
      if (!d) return '';
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    function filterByMonth(items, ym) {
      const [y,m] = ym.split('-').map(Number);
      return items.filter(x => {
        const d = x.baseDate;
        return d && d.getFullYear() === y && (d.getMonth()+1) === m;
      });
    }

    function renderList(items, mount) {
      if (!items.length) { mount.innerHTML = '<p>該当なし</p>'; return; }
      const groups = new Map();
      for (const it of items) {
        const k = fmtDate(it.baseDate);
        if (!groups.has(k)) groups.set(k, []);
        groups.get(k).push(it);
      }
      for (const arr of groups.values()) {
        arr.sort((a,b) => (a.start?.getTime()||0) - (b.start?.getTime()||0)
          || a.title.localeCompare(b.title,'ja'));
      }
      let html = '';
      for (const [day, arr] of groups) {
        html += `<h3 style="margin:12px 0 6px">${day}</h3>`;
        html += `<ul style="margin:0 0 12px 16px;padding:0">`;
        for (const it of arr) {
          const timePart = it.start ? (it.end ? `${fmtTime(it.start)}–${fmtTime(it.end)}` : `${fmtTime(it.start)}`) : '';
          const loc = it.location ? ` <span style="color:#666">＠${escapeHtml(it.location)}</span>` : '';
          const note = it.note ? `<div style="color:#666;font-size:.9em;white-space:pre-wrap">${escapeHtml(it.note)}</div>` : '';
          html += `<li style="margin:4px 0">
            <strong>${escapeHtml(it.title)}</strong> ${timePart}${loc}
            ${note}
          </li>`;
        }
        html += `</ul>`;
      }
      mount.innerHTML = html;
    }

    function escapeHtml(s){ return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function renderCalendar(items, ym, mount) {
      const [year, month] = ym.split('-').map(Number);
      const first = new Date(year, month-1, 1);
      const last = new Date(year, month, 0);
      const startCell = (first.getDay()+6)%7;
      const totalDays = last.getDate();

      const counts = Array.from({length: totalDays+1}, () => 0);
      for (const it of items) {
        const d = it.baseDate.getDate();
        counts[d] += 1;
      }

      let html = `
        <style>
          .cal {border-collapse:collapse;width:100%;}
          .cal th,.cal td{border:1px solid #ddd;text-align:right;padding:6px;vertical-align:top;height:60px;}
          .cal th{background:#f3f4f6;text-align:center}
          .dot{display:inline-block;min-width:1.6em;padding:.1em .5em;border-radius:999px;background:#e5e7eb;margin-left:4px;font-size:.85em}
          .has .dot{background:#dbeafe}
          .today{outline:2px solid #60a5fa;outline-offset:-2px;border-radius:4px}
        </style>
        <table class="cal">
          <thead><tr>
            <th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th>
          </tr></thead><tbody>
      `;

      let day = 1;
      for (let r=0; r<6 && day<=totalDays; r++) {
        html += '<tr>';
        for (let c=0; c<7; c++) {
          const cellIndex = r*7 + c;
          if (cellIndex < startCell || day > totalDays) {
            html += '<td></td>';
          } else {
            const cnt = counts[day];
            const cls = cnt ? 'has' : '';
            const dstr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const isToday = (new Date().toISOString().slice(0,10) === dstr);
            html += `<td class="${cls} ${isToday?'today':''}">
              <div>${day}${cnt?`<span class="dot">${cnt}</span>`:''}</div>
            </td>`;
            day++;
          }
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      mount.innerHTML = html;
    }

    function renderSchedules(json, ym) {
      const itemsAll = normalizeSchedules(json);
      const items = filterByMonth(itemsAll, ym);
      const listEl = document.getElementById('sched-list');
      const calEl = document.getElementById('sched-calendar');
      const sumEl = document.getElementById('sched-summary');

      sumEl.textContent = `${ym} の予定: ${items.length}件（取得総数: ${itemsAll.length}件）`;
      renderList(items, listEl);
      renderCalendar(items, ym, calEl);
    }
  </script>
</body>
</html>
