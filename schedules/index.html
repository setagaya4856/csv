<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>行動予定表（モバイル）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- UI 基本 -->
  <style>
    :root { --pad:12px; }
    body{ font-family: system-ui, -apple-system, "ヒラギノ角ゴ ProN", Meiryo, sans-serif; margin:0; background:#f7f7f7; }
    header{ position:sticky; top:0; z-index:100; background:#fff; border-bottom:1px solid #e5e5e5; }
    .bar{ display:flex; gap:8px; align-items:center; padding:8px var(--pad); flex-wrap:wrap; }
    .grow{ flex:1 1 auto; }
    select, input, button, textarea{ font:inherit; padding:8px; border:1px solid #ccc; border-radius:8px; background:#fff; }
    button{ cursor:pointer; }
    .panel{ background:#fff; margin:12px; padding:12px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .muted{ color:#666; font-size:.9em; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    /* 予定テーブル：Jspreadsheet をモバイル向けに */
    .jexcel_content td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .jexcel .readonly{ background:#fafafa; }
    .jexcel .jexcel_frozen{ background:#fff; }
    .cell-date{ font-weight:600; }
    .ht-today{ background:#fff9db !important; }
    .ht-sat  { background:#e6ffed !important; }
    .ht-sun, .ht-holiday{ background:#ffe5e5 !important; }

    /* 行ラベル（左固定列）を少し太く */
    .jexcel td.cell-date{ font-weight:700; }

    /* フッタ余白（iOS スクロール安全域） */
    footer{ height:24px; }

    /* 片手操作向けにボタン大きめ */
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid #bbb; background:#fff; }
    .btn-primary{ background:#1a73e8; color:#fff; border-color:#1a73e8; }
  </style>

  <!-- ===== Jspreadsheet CE + jSuites ===== -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsuites@4.15.0/dist/jsuites.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4.11.4/dist/jspreadsheet.css" />
  <script src="https://cdn.jsdelivr.net/npm/jsuites@4.15.0/dist/jsuites.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4.11.4/dist/index.js"></script>

  <!-- ===== Supabase & 祝日 ===== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import * as holiday_jp from 'https://esm.sh/@holiday-jp/holiday_jp@2';

    /* =============================== 設定 =============================== */
    const SUPABASE_URL = 'https://rqrgsytkxbhbrnrhqlca.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxcmdzeXRreGJoYnJucmhxbGNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2ODIyODMsImV4cCI6MjA3MTI1ODI4M30.LWeiva7gpFf9lHGuOKqzyr-tZihHuX9KdlHUjuqYDU0';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const JP_CAL_OPTS = {
      format:'YYYY-MM-DD', firstDay:0,
      months:['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
      monthsShort:['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
      weekdays:['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'],
      weekdays_short:['日','月','火','水','木','金','土'],
      today:'今日', clear:'クリア', close:'閉じる'
    };

    /* =============================== 状態 =============================== */
    let employeesAll = [];
    let employeesVisible = [];
    let currentUser = { email:null, employee_id:null, department:null, is_active:false };
    let grid = null;

    const monthCache = new Map(); // ym -> normalized items
    const holidaySet = new Set(); // 'YYYY-MM-DD'
    const holidaysLoadedYm = new Set();

    const $ = (q)=>document.querySelector(q);
    const fmt = new Intl.DateTimeFormat('ja-JP',{ timeZone:'Asia/Tokyo', year:'numeric', month:'2-digit', day:'2-digit', weekday:'short' });
    const todayYmd = ()=> {
      const p = Object.fromEntries(fmt.formatToParts(new Date()).map(x=>[x.type,x.value]));
      return `${p.year}-${p.month}-${p.day}`;
    };
    const ymOf = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const monthsAround = (base=new Date(), back=3, fwd=3)=>{
      const list=[]; const d=new Date(base.getFullYear(), base.getMonth()-back, 1);
      const end=new Date(base.getFullYear(), base.getMonth()+fwd+1, 1);
      while(d<end){ list.push(ymOf(d)); d.setMonth(d.getMonth()+1,1); }
      return list;
    };

    /* =============================== 祝日 =============================== */
    const ymdJST = (date)=> {
      const p = Object.fromEntries(fmt.formatToParts(date).map(x=>[x.type,x.value]));
      return `${p.year}-${p.month}-${p.day}`;
    };
    async function preloadHolidaysForMonths(months){
      const need = months.filter(m=>!holidaysLoadedYm.has(m));
      if(!need.length) return;
      need.sort();
      const first = need[0], last = need[need.length-1];
      const start = new Date(`${first}-01T00:00:00+09:00`);
      const [ly,lm] = last.split('-').map(Number);
      const end = new Date(new Date(Date.UTC(ly, lm-1, 1)).setUTCMonth(lm)); // 翌月初
      const list = holiday_jp.between(start, end) || [];
      for(const h of list){ holidaySet.add(ymdJST(h.date)); }
      need.forEach(m=>holidaysLoadedYm.add(m));
    }
    const isHoliday = (ymd)=> holidaySet.has(ymd);

    /* =============================== 認証＆従業員 =============================== */
    async function loadCurrentUserAndEmployees(){
      const { data:{ session } } = await supabase.auth.getSession();
      const email = session?.user?.email ?? null;
      const { data: emps, error } = await supabase
        .from('employees')
        .select('id,name,email,department,note,row_index,is_admin,is_active')
        .order('row_index', { ascending:true })
        .order('name', { ascending:true });
      if(error) throw error;
      employeesAll = emps || [];
      employeesVisible = employeesAll.filter(e => e.is_active !== false);
      const me = employeesAll.find(e => (e.email||'').toLowerCase() === (email||'').toLowerCase());
      currentUser = { email, employee_id: me?.id ?? null, department: me?.department ?? null, is_active: !!me && me.is_active !== false };
      return currentUser;
    }

    /* =============================== 月データ取得（既存APIの1ヶ月単位） =============================== */
    function normalizeSchedules(json){
      // サーバが {days, rows} を返す前提（desktop版互換）
      if (json && Array.isArray(json.rows)) {
        const arr=[];
        for (const row of json.rows){
          const emp = row.employee_name || row.name || '（未割当）';
          const cells = row.cells || {};
          for(const k of Object.keys(cells)){
            const d = String(k).slice(0,10);
            const c = cells[k]||{};
            const push = (txt, slot, hour)=>{
              const t = (txt??'').toString().trim(); if(!t) return;
              arr.push({
                employee_name: emp,
                employee_id: row.employee_id,
                date: d,
                slot,
                title: t,
                startHour: hour
              });
            };
            push(c.am, 'am', 9);
            push(c.pm, 'pm', 13);
          }
        }
        return arr;
      }
      return [];
    }
    async function fetchMonthData(ym, token){
      if(monthCache.has(ym)) return monthCache.get(ym);
      const ids = employeesVisible.map(e=>e.id).filter(v=>v!=null);
      const qsEmp = ids.length ? `&emp_ids=${encodeURIComponent(ids.join(','))}` : '';
      const res = await fetch(`${SUPABASE_URL}/functions/v1/schedules-get?month=${encodeURIComponent(ym)}${qsEmp}&_=${Date.now()}`, {
        headers:{ Authorization:`Bearer ${token}` }, cache:'no-store'
      });
      const json = await res.json();
      const items = normalizeSchedules(json);
      monthCache.set(ym, items);
      return items;
    }

    /* =============================== 行列入替えマトリクス =============================== */
    function weekday(y,m,d){ const t=[0,3,2,5,0,3,5,1,4,6,2,4]; if(m<3) y-=1; return (y+Math.floor(y/4)-Math.floor(y/100)+Math.floor(y/400)+t[m-1]+d)%7; }
    function dayLabel(ymd, slot){
      const [y,m,d] = ymd.split('-').map(Number);
      const wd = '日月火水木金土'[weekday(y,m,d)];
      return `${m}/${d}${wd} ${slot==='am'?'A':'P'}`;
    }

    // 選択部署の社員だけカラムに並べ、行は日×(午前/午後)
    function buildSwappedMatrix(items, ym, dept){
      const emps = employeesVisible
        .filter(e => !dept || (String(e.department||'')===String(dept)))
        .sort((a,b)=>(a.row_index??0)-(b.row_index??0) || a.name.localeCompare(b.name,'ja'));

      const [y,m] = ym.split('-').map(Number);
      const last = new Date(y, m, 0).getDate();
      const days = Array.from({length:last}, (_,i)=>`${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`);

      // 2行/日（午前・午後）
      const rowKeys = [];
      const rowLabels = [];
      for(const d of days){
        rowKeys.push({date:d, slot:'am'}); rowLabels.push(dayLabel(d,'am'));
        rowKeys.push({date:d, slot:'pm'}); rowLabels.push(dayLabel(d,'pm'));
      }

      // items を (date, slot, empId) ごとに集計
      const byKey = new Map(); // `${date}|${slot}|${empId}` -> [texts]
      for(const it of items){
        const k = `${it.date}|${it.slot}|${it.employee_id}`;
        if(!byKey.has(k)) byKey.set(k, []);
        byKey.get(k).push(it.title);
      }

      const columns = [{ type:'text', title:'日付', width:160 }].concat(
        emps.map(e => ({ type:'text', title:e.name, width:140 }))
      );
      const data = rowKeys.map(({date,slot})=>{
        const row = [ dayLabel(date,slot) ];
        for(const e of emps){
          const k = `${date}|${slot}|${e.id}`;
          const txt = (byKey.get(k)||[]).join('\n');
          row.push(txt);
        }
        return row;
      });

      const colMeta = { emps, rowKeys, ym };
      return { columns, data, colMeta };
    }

    function classesForYmd(ymd){
      const [y,m,d] = ymd.split('-').map(Number);
      const wd = weekday(y,m,d);
      const cls = [];
      if (ymd===todayYmd()) cls.push('ht-today');
      if (wd===6) cls.push('ht-sat');
      if (wd===0) cls.push('ht-sun');
      if (isHoliday(ymd)) cls.push('ht-holiday');
      return cls;
    }

    async function renderGrid(ym, dept){
      const { data:{ session } } = await supabase.auth.getSession();
      if(!session) return;
      await preloadHolidaysForMonths([ym]);

      const items = await fetchMonthData(ym, session.access_token);
      const { columns, data, colMeta } = buildSwappedMatrix(items, ym, dept);

      const host = document.getElementById('grid');
      host.innerHTML = '';
      grid = jspreadsheet(host, {
        data, columns,
        freezeColumns:1,
        tableOverflow:true,
        tableHeight: '400px',
        tableWidth: '100%',     // ← 幅いっぱいに広げる
        allowInsertColumn:false, allowDeleteColumn:false,
        allowInsertRow:false, allowDeleteRow:false,
        editable:false, selectionCopy:true,
        updateTable:(el, cell, x, y, src, val)=>{

        // 行の全セルに日付ベースの色付け（x=0 だけでなく全部）
        const rk = colMeta.rowKeys[y];
        if (!rk) return;
        const classes = classesForYmd(rk.date); // ['ht-today','ht-sat','ht-sun','ht-holiday'] など

        // 既存クラスを一度除去してから付与
        for (const c of ['ht-today','ht-sat','ht-sun','ht-holiday']) cell.classList.remove(c);
        classes.forEach(c => cell.classList.add(c));
      
        // 日付セルだけ太字に
        if (x === 0) cell.classList.add('cell-date');
        }
      });
    }

    /* =============================== 部署・月のUI =============================== */
    function uniqueDepartments(){
      const set = new Map(); // 表示名の順を維持
      for(const e of employeesVisible){
        const dep = e.department || '';
        if(!set.has(dep)) set.set(dep, dep);
      }
      return Array.from(set.keys());
    }
    function fillDepartmentOptions(initDept){
      const sel = document.getElementById('deptSelect');
      sel.innerHTML = '';
      for(const dep of uniqueDepartments()){
        const op = document.createElement('option');
        op.value = dep; op.textContent = dep||'(未設定)';
        if (initDept && String(dep)===String(initDept)) op.selected = true;
        sel.appendChild(op);
      }
    }
    function fillMonthOptions(base=new Date()){
      const months = monthsAround(base, 3, 3);
      const sel = document.getElementById('monthSelect');
      sel.innerHTML = '';
      for(const ym of months){
        const op = document.createElement('option');
        op.value = ym; op.textContent = ym;
        if (ym===ymOf(base)) op.selected = true;
        sel.appendChild(op);
      }
    }

    /* =============================== クイック登録 =============================== */
    function toYMD(v){
      const pad = n => String(n).padStart(2,'0');
      if (!v) return null;
      if (v instanceof Date && !isNaN(v)) return `${v.getFullYear()}-${pad(v.getMonth()+1)}-${pad(v.getDate())}`;
      const s = String(v).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(s); if (!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      return null;
    }
    function normalizeHHMM(raw){
      const s=String(raw||'').trim(); if(!s) return null;
      if(/^[0-2]?\d:[0-5]\d$/.test(s)) return s.length===4? '0'+s : s;
      if(/^\d{4}$/.test(s)){ const hh=+s.slice(0,2), mm=+s.slice(2,4); if(hh>=0&&hh<=23&&mm>=0&&mm<=59) return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
      return null;
    }

    async function ensureMyEmployeeId(){
      if(currentUser.employee_id) return currentUser.employee_id;
      const { data:{ session } } = await supabase.auth.getSession();
      if(!session) throw new Error('未ログイン');
      const { data, error } = await supabase.from('employees').select('id,email').eq('email', session.user.email).maybeSingle();
      if(error) throw error;
      if(!data) throw new Error('自分の従業員IDが見つかりません');
      currentUser.employee_id = data.id;
      return data.id;
    }

    async function saveQuick(){
      const date = toYMD(document.getElementById('qDate').value);
      if(!date){ alert('日付は YYYY-MM-DD で入力してください'); return; }
      const am = String(document.getElementById('qAm').value||'').trim();
      const pm = String(document.getElementById('qPm').value||'').trim();

      const employee_id = await ensureMyEmployeeId();
      const upserts=[], deletes=[];
      if(am) upserts.push({ employee_id, date, slot:'am', place:am }); else deletes.push({ employee_id, date, slot:'am' });
      if(pm) upserts.push({ employee_id, date, slot:'pm', place:pm }); else deletes.push({ employee_id, date, slot:'pm' });

      const { data:{ session } } = await supabase.auth.getSession();
      const token = session?.access_token; if(!token){ alert('未ログイン'); return; }

      // 送信
      if(deletes.length){
        const r=await fetch(`${SUPABASE_URL}/functions/v1/schedules-delete`,{
          method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
          body:JSON.stringify(deletes)
        }); const j=await r.json().catch(()=>({})); if(!r.ok || !j?.ok) { alert('削除失敗'); return; }
      }
      if(upserts.length){
        const r=await fetch(`${SUPABASE_URL}/functions/v1/schedules-upsert`,{
          method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
          body:JSON.stringify(upserts)
        }); const j=await r.json().catch(()=>({})); if(!r.ok || !j?.ok) { alert('保存失敗'); return; }
      }

      // キャッシュ更新＆当月再描画
      const ym = date.slice(0,7);
      monthCache.delete(ym);
      const monthSel = document.getElementById('monthSelect');
      if (monthSel.value === ym) {
        await renderGrid(ym, document.getElementById('deptSelect').value);
      }
      alert('更新しました');
    }

    /* =============================== 起動 =============================== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      // UI 初期組み立て
      fillMonthOptions(new Date());
      $('#qDate').value = todayYmd();

      // 認証状態に応じた表示（モバイルは簡略：未ログインならSupabaseのメール/パスでログイン）
      const { data:{ session } } = await supabase.auth.getSession();
      $('#loginPanel').style.display = session ? 'none' : '';
      $('#appPanel').style.display   = session ? '' : 'none';

      if(session){
        await loadCurrentUserAndEmployees();
        fillDepartmentOptions(currentUser.department);
        const ym = $('#monthSelect').value;
        await preloadHolidaysForMonths([ym]);
        await renderGrid(ym, $('#deptSelect').value);
      }

      // ログイン
      $('#loginBtn').addEventListener('click', async ()=>{
        const email = $('#email').value.trim();
        const password = $('#password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if(error){ alert('ログイン失敗: '+error.message); return; }
        location.reload();
      });

      // クイック登録保存
      $('#quickSaveBtn').addEventListener('click', saveQuick);

      // 部署変更
      $('#deptSelect').addEventListener('change', async ()=>{
        await renderGrid($('#monthSelect').value, $('#deptSelect').value);
      });

      // 月変更
      $('#monthSelect').addEventListener('change', async ()=>{
        await renderGrid($('#monthSelect').value, $('#deptSelect').value);
      });
    });
  </script>
</head>
<body>
  <header>
    <div class="bar">
      <strong>行動予定表（モバイル）</strong>
      <span class="grow"></span>
      <button id="logoutBtn" class="btn" onclick="(async()=>{const { data:{ session } } = await supabase.auth.getSession(); if(session){ await supabase.auth.signOut(); location.reload(); }})()">ログアウト</button>
    </div>
    <div class="bar">
      <label class="muted">部署</label>
      <select id="deptSelect" class="grow"></select>
      <label class="muted">月</label>
      <select id="monthSelect"></select>
    </div>
  </header>

  <!-- 未ログイン時 -->
  <div id="loginPanel" class="panel" style="display:none;">
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com" inputmode="email" autocomplete="username" />
      <input id="password" type="password" placeholder="パスワード" autocomplete="current-password" />
      <button id="loginBtn" class="btn-primary">ログイン</button>
    </div>
    <p class="muted">※ 社内アカウントでログインしてください</p>
  </div>

  <!-- アプリ本体 -->
  <div id="appPanel" style="display:none;">
    <!-- クイック登録（自分のみ／会社予定登録は無し） -->
    <div class="panel">
      <div class="row">
        <label>日付</label>
        <input id="qDate" type="date" />
        <button id="quickSaveBtn" class="btn-primary">クイック登録</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="qAm"  type="text" placeholder="午前の予定（例：現場A）" style="flex:1 1 200px;" />
        <input id="qPm"  type="text" placeholder="午後の予定（例：現場B）" style="flex:1 1 200px;" />
      </div>
    </div>

    <!-- スケジュール（表示のみ、x/y入替） -->
    <div class="panel">
      <div id="grid"></div>
      <div class="muted" style="margin-top:8px;">※ 表示専用（タップ編集なし）。祝日・土日・今日を色付け。</div>
    </div>
  </div>

  <footer></footer>
</body>
</html>
