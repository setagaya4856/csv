<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" /><!-- iOS: ホーム画面追加で全画面表示 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="行動予定表">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- ノッチ端末の安全域 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>行動予定表（モバイル）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="https://www.tjs.jp/wp/wp-content/uploads/2023/12/favicon.png" type="image/png">
  <!-- UI 基本 -->
  <style>
    :root {
      /* 既存 --pad は残しつつ、安全域を考慮した余白を加算したい場合に使えます */
      --safe-top: env(safe-area-inset-top, 0px);
      --pad:12px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    /* 100vhのアドレスバー問題を避ける：svh/dvh対応 */
    html, body {
      height: 100%;
      overflow-x: hidden; 
    }
    body {
      font-family: system-ui, -apple-system, "ヒラギノ角ゴ ProN", Meiryo, sans-serif; margin:0; background:#f7f7f7; 
      min-height: 100svh;    /* iOS/最新ブラウザで安定 */
      min-height: 100dvh;    /* こちらが使える環境ではより正確 */
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }
    
    /* 最下部のフッタ安全域（既存footerを活用） */
    footer {
      height: calc(24px + var(--safe-bottom));
    }
    header{ position:sticky; top:0; z-index:100; background:#fff; border-bottom:1px solid #e5e5e5; padding-top: calc(8px + var(--safe-top));}
    .bar{ display:flex; gap:8px; align-items:center; padding:8px var(--pad); flex-wrap:wrap; }
    .grow{ flex:1 1 auto; }
    select, input, button, textarea{ font:inherit; padding:8px; border:1px solid #ccc; border-radius:8px; background:#fff; }
    button{ cursor:pointer; }
    .panel{ background:#fff; margin:12px; padding:12px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.04); 
      box-sizing: border-box;
      overflow: hidden;          /* はみ出しをカット */}
    .muted{ color:#666; font-size:.9em; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    /* グリッド：幅は親いっぱいに固定 */
    #grid { 
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    /* Jspreadsheet 本体とスクロール領域も親幅にフィットさせる */
    #grid .jexcel {
      width: 100% !important;
      max-width: 100% !important;
      position: relative;
    }
    #grid .jexcel_header {
      position: sticky;
      top: 0;
      z-index: 3;
      background: #fff;
    }
    #grid .jexcel_content {
      width: 100% !important;    /* ← ここ大事：親幅に合わせる */
      max-width: 100% !important;
      overflow: auto;            /* 横/縦スクロールはここで出す */
      -webkit-overflow-scrolling: touch; /* iOS 慣性 */
    }
    /* 予定テーブル：Jspreadsheet をモバイル向けに */
    .jexcel_content td{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; 
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none; /* iOSのコピー/ペースト呼び出しを抑止 */
      caret-color: transparent;    /* キャレット非表示 */
    }
    .jexcel .readonly{ background:#fafafa; }
    .jexcel .jexcel_frozen{ background:#fff; }
    .cell-date{ font-weight:600; }
    .ht-today{ background:#fff9db !important; }
    .ht-sat  { background:#e6ffed !important; }
    .ht-sun, .ht-holiday{ background:#ffe5e5 !important; }

    /* 行ラベル（左固定列）を少し太く */
    .jexcel td.cell-date{ font-weight:700; }

    /* フッタ余白（iOS スクロール安全域） */
    footer{ height:24px; }

    /* 片手操作向けにボタン大きめ */
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid #bbb; background:#fff; }
    .btn-primary{ background:#1a73e8; color:#fff; border-color:#1a73e8; }
    #toggleQuickBtn {
      font-size: 1.4em;
      line-height: 1;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      text-align: center;
      padding: 0;
    }
    /* メモ行（ヘッダー直下の1行目） */
    #grid .jexcel tbody tr:first-child td.memo-row {
      background: #f4f8ff;
      border-bottom: 1px solid #dce6ff;
      font-weight: 600;
      white-space: pre-wrap;
      word-break: break-word;
      padding: 8px 10px;
    }

    /* 読み取り専用セルの文字をやや濃いグレーに */
    .jexcel .readonly {
      color: #555 !important;      /* ← デフォルト #999 より濃く */
      background-color: #fafafa;   /* 背景は今まで通り薄灰 */
    }
    #refreshBtn {
      font-size: 1.2em;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 8px;
    }

    /* 自分の列を赤文字（セル＆ヘッダ両方） */
    #grid .jexcel td.myself,
    #grid .jexcel td.myself * {
      color: #d32f2f !important;
      font-weight: 700;
    }
    /* ==== Help modal (mobile) ==== */
    .help-modal{ position:fixed; inset:0; display:none; z-index:10000; }
    .help-modal[aria-hidden="false"]{ display:block; }
    .help-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.4); }
    .help-panel{
      position:relative; max-width:640px; margin:8vh auto; background:#fff;
      border-radius:12px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.18);
    }
    .help-close{
      position:absolute; right:10px; top:8px; font-size:22px; line-height:1;
      border:0; background:transparent; cursor:pointer;
    }
    .help-body{ margin:8px 0 4px; max-height:60vh; overflow:auto; }
    /* 行ヘッダ（左）を sticky に */
    #grid .jexcel .jexcel_row {
      font-weight: 600;
      min-width: 72px;  /* rowHeaderWidth と合わせる */
      position: sticky;
      left: 0;
      z-index: 2;        /* ヘッダとデータの間にくるように */
      box-shadow: 1px 0 0 #eee; /* 仕切り線（任意） */
    }

    /* 左上の角（行ヘッダ×列ヘッダの交点）も固定に */
    #grid .jexcel .jexcel_corner {
      position: sticky;
      top: 0;
      left: 0;
      z-index: 4;
      background: #fff;
      box-shadow: 1px 1px 0 #eee; /* 任意 */
    }
    #grid .jexcel .jexcel_corner,
    #grid .jexcel .jexcel_row {
      width: 120px !important;      /* ← 好きな幅に */
      min-width: 120px !important;
      max-width: 120px !important;
      box-sizing: border-box;
    }
    /* 親がスクロールを奪わないように（重要） */
    .panel { overflow: visible; }   /* ← ここが hidden だと sticky が効かないことがある */
  </style>

  <!-- ===== Jspreadsheet CE + jSuites ===== -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsuites@4.15.0/dist/jsuites.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4.11.4/dist/jspreadsheet.css" />
  <script src="https://cdn.jsdelivr.net/npm/jsuites@4.15.0/dist/jsuites.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4.11.4/dist/index.js"></script>

  <!-- ===== Supabase & 祝日 ===== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import * as holiday_jp from 'https://esm.sh/@holiday-jp/holiday_jp@2';

    /* =============================== 設定 =============================== */
    const SUPABASE_URL = 'https://rqrgsytkxbhbrnrhqlca.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxcmdzeXRreGJoYnJucmhxbGNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2ODIyODMsImV4cCI6MjA3MTI1ODI4M30.LWeiva7gpFf9lHGuOKqzyr-tZihHuX9KdlHUjuqYDU0';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,        // 端末ごとにセッション保持
        autoRefreshToken: false,     // ★自動リフレッシュを止める
        detectSessionInUrl: true,
      },
    });
    const JP_CAL_OPTS = {
      format:'YYYY-MM-DD', firstDay:0,
      months:['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
      monthsShort:['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
      weekdays:['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'],
      weekdays_short:['日','月','火','水','木','金','土'],
      today:'今日', clear:'クリア', close:'閉じる'
    };
    // 文字幅計測のための Canvas コンテキスト（使い回し）
    const __measure = (() => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      return { canvas, ctx };
    })();
    
    function shrinkToFit(cell, text, { base=14, min=10, maxLines=2 } = {}) {
      // 改行対応：行ごとに計測
      const lines = String(text).split('\n');
      // セル内のパディングを概算（Jspreadsheetのtdデフォルトに合わせて少し余裕）
      const padX = 12; // 左右合計
      const availW = Math.max(8, cell.clientWidth - padX);
    
      // 計測用フォント設定（cell の実フォントに寄せる）
      const style = getComputedStyle(cell);
      const family = style.fontFamily || 'system-ui, sans-serif';
      const weight = style.fontWeight || '400';
    
      let size = base;
      while (size > min) {
        __measure.ctx.font = `${weight} ${size}px ${family}`;
        // 各行が収まるか？（最長行の幅で判定）
        const widest = Math.max(...lines.map(l => __measure.ctx.measureText(l).width));
        const fitsWidth = widest <= availW;
        // 行数も制限（2行まで等）。収めたい場合は折り返しを許容。
        const willWrapLines = lines.reduce((cnt, l) => {
          const w = __measure.ctx.measureText(l).width;
          return cnt + Math.max(1, Math.ceil(w / Math.max(1, availW)));
        }, 0);
        const fitsLines = willWrapLines <= maxLines;
    
        if (fitsWidth && fitsLines) break;
        size -= 1;
      }
    
      // 反映
      cell.style.fontSize = `${size}px`;
      cell.style.lineHeight = '1.2';
      cell.style.whiteSpace = 'pre-wrap';     // 改行・折返し許可
      cell.style.wordBreak = 'break-word';    // 単語も折り返す
      cell.style.textOverflow = 'clip';       // 省略記号は不要
    }
    function showLoginModal() {
      document.getElementById('loginModal').style.display = '';
      document.getElementById('appRoot').style.display = 'none';
    }
    
    async function getActiveSessionOrLogout() {
      const { data: { session } } = await supabase.auth.getSession();
      const now = Math.floor(Date.now() / 1000);
      const exp = session?.expires_at ?? 0;
    
      // セッションなし or アクセストークン期限切れ → ログアウト＆ログイン要求
      if (!session || !session.access_token || exp <= now) {
        try { await supabase.auth.signOut({ scope: 'local' }); } catch {}
        showLoginModal();                // ← 既存のモーダル展開関数を呼ぶ
        throw new Error('session_expired');
      }
      return session;
    }
    // --- 失効・サインアウト監視（グローバル） ---
    supabase.auth.onAuthStateChange((evt) => {
      if (evt === 'SIGNED_OUT') {
        showLoginModal();  // すぐログイン画面へ
      }
    });
    
    // 定期チェック（5分ごと）& タブ復帰時チェック
    const SESSION_CHECK_MS = 5 * 60 * 1000;
    setInterval(async () => {
      try { await getActiveSessionOrLogout(); } catch {}
    }, SESSION_CHECK_MS);
    
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        try { await getActiveSessionOrLogout(); } catch {}
      }
    });
    /* =============================== 状態 =============================== */
    let employeesAll = [];
    let employeesVisible = [];
    let currentUser = { email:null, employee_id:null, department:null, is_active:false };
    let grid = null;

    const monthCache = new Map(); // ym -> normalized items
    const holidaySet = new Set(); // 'YYYY-MM-DD'
    const holidaysLoadedYm = new Set();

    const $ = (q)=>document.querySelector(q);
    const fmt = new Intl.DateTimeFormat('ja-JP',{ timeZone:'Asia/Tokyo', year:'numeric', month:'2-digit', day:'2-digit', weekday:'short' });
    const todayYmd = ()=> {
      const p = Object.fromEntries(fmt.formatToParts(new Date()).map(x=>[x.type,x.value]));
      return `${p.year}-${p.month}-${p.day}`;
    };
    const ymOf = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const monthsAround = (base=new Date(), back=3, fwd=3)=>{
      const list=[]; const d=new Date(base.getFullYear(), base.getMonth()-back, 1);
      const end=new Date(base.getFullYear(), base.getMonth()+fwd+1, 1);
      while(d<end){ list.push(ymOf(d)); d.setMonth(d.getMonth()+1,1); }
      return list;
    };

    /* =============================== 祝日 =============================== */
    const ymdJST = (date)=> {
      const p = Object.fromEntries(fmt.formatToParts(date).map(x=>[x.type,x.value]));
      return `${p.year}-${p.month}-${p.day}`;
    };
    async function preloadHolidaysForMonths(months){
      const need = months.filter(m=>!holidaysLoadedYm.has(m));
      if(!need.length) return;
      need.sort();
      const first = need[0], last = need[need.length-1];
      const start = new Date(`${first}-01T00:00:00+09:00`);
      const [ly,lm] = last.split('-').map(Number);
      const end = new Date(new Date(Date.UTC(ly, lm-1, 1)).setUTCMonth(lm)); // 翌月初
      const list = holiday_jp.between(start, end) || [];
      for(const h of list){ holidaySet.add(ymdJST(h.date)); }
      need.forEach(m=>holidaysLoadedYm.add(m));
    }
    const isHoliday = (ymd)=> holidaySet.has(ymd);

    /* =============================== 認証＆従業員 =============================== */
    async function loadCurrentUserAndEmployees(){
      const { data:{ session } } = await supabase.auth.getSession();
      const email = session?.user?.email ?? null;
      const { data: emps, error } = await supabase
        .from('employees')
        .select('id,name,email,department,note,row_index,is_admin,is_active')
        .order('row_index', { ascending:true })
        .order('name', { ascending:true });
      if(error) throw error;
      employeesAll = emps || [];
      employeesVisible = employeesAll.filter(e => e.is_active !== false);
      const me = employeesAll.find(e => (e.email||'').toLowerCase() === (email||'').toLowerCase());
      currentUser = { email, employee_id: me?.id ?? null, department: me?.department ?? null, is_active: !!me && me.is_active !== false };
      return currentUser;
    }

    /* =============================== 月データ取得（既存APIの1ヶ月単位） =============================== */
    function normalizeSchedules(json){
      // サーバが {days, rows} を返す前提（desktop版互換）
      if (json && Array.isArray(json.rows)) {
        const arr=[];
        for (const row of json.rows){
          const emp = row.employee_name || row.name || '（未割当）';
          const cells = row.cells || {};
          for(const k of Object.keys(cells)){
            const d = String(k).slice(0,10);
            const c = cells[k]||{};
            const push = (txt, slot, hour)=>{
              const t = (txt??'').toString().trim(); if(!t) return;
              arr.push({
                employee_name: emp,
                employee_id: row.employee_id,
                date: d,
                slot,
                title: t,
                startHour: hour
              });
            };
            push(c.am, 'am', 9);
            push(c.pm, 'pm', 13);
          }
        }
        return arr;
      }
      return [];
    }
    async function fetchMonthData(ym, token){
      if(monthCache.has(ym)) return monthCache.get(ym);
      const ids = employeesVisible.map(e=>e.id).filter(v=>v!=null);
      const qsEmp = ids.length ? `&emp_ids=${encodeURIComponent(ids.join(','))}` : '';
      const res = await fetch(`${SUPABASE_URL}/functions/v1/schedules-get?month=${encodeURIComponent(ym)}${qsEmp}&_=${Date.now()}`, {
        headers:{ Authorization:`Bearer ${token}` }, cache:'no-store'
      });
      const json = await res.json();
      const items = normalizeSchedules(json);
      monthCache.set(ym, items);
      return items;
    }

    /* =============================== 行列入替えマトリクス =============================== */
    function weekday(y,m,d){ const t=[0,3,2,5,0,3,5,1,4,6,2,4]; if(m<3) y-=1; return (y+Math.floor(y/4)-Math.floor(y/100)+Math.floor(y/400)+t[m-1]+d)%7; }
    function dayLabel(ymd, slot){
      const [y,m,d] = ymd.split('-').map(Number);
      const wd = '日月火水木金土'[weekday(y,m,d)];
      return `${d}${slot==='am'?'AM':'PM'}`;
    }

    // 選択部署の社員だけカラムに並べ、行は日×(午前/午後)
    function buildSwappedMatrix(items, ym, dept){
      const emps = employeesVisible
        .filter(e => !dept || (String(e.department||'')===String(dept)))
        .sort((a,b)=>(a.row_index??0)-(b.row_index??0) || a.name.localeCompare(b.name,'ja'));

      const [y,m] = ym.split('-').map(Number);
      const last = new Date(y, m, 0).getDate();
      const days = Array.from({length:last}, (_,i)=>`${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`);

      // 2行/日（午前・午後）
      const rowKeys = [];
      const rowLabels = [];
      for(const d of days){
        rowKeys.push({date:d, slot:'am'}); rowLabels.push(dayLabel(d,'am'));
        rowKeys.push({date:d, slot:'pm'}); rowLabels.push(dayLabel(d,'pm'));
      }

      // items を (date, slot, empId) ごとに集計
      const byKey = new Map(); // `${date}|${slot}|${empId}` -> [texts]
      for(const it of items){
        const k = `${it.date}|${it.slot}|${it.employee_id}`;
        if(!byKey.has(k)) byKey.set(k, []);
        byKey.get(k).push(it.title);
      }
      const columns = emps.map(e => ({ type:'text', title:e.name, width:80 }));
      const data = rowKeys.map(({date,slot})=>{
        const row = [];
        for (const e of emps) {
          const k = `${date}|${slot}|${e.id}`;
          const txt = (byKey.get(k)||[]).join('\n');
          row.push(txt);
        }
        return row;
      });

      const colMeta = { emps, rowKeys, rowLabels, ym };
      return { columns, data, colMeta };
    }

    function classesForYmd(ymd){
      const [y,m,d] = ymd.split('-').map(Number);
      const wd = weekday(y,m,d);
      const cls = [];
      if (ymd===todayYmd()) cls.push('ht-today');
      if (wd===6) cls.push('ht-sat');
      if (wd===0) cls.push('ht-sun');
      if (isHoliday(ymd)) cls.push('ht-holiday');
      return cls;
    }

    async function renderGrid(ym, dept){
      const { access_token: token } = await getActiveSessionOrLogout(); // ← ここで期限検査
      await preloadHolidaysForMonths([ym]);
      const items = await fetchMonthData(ym, token);
      const { columns, data, colMeta } = buildSwappedMatrix(items, ym, dept);

      // ★ メモ行を作成（A列は「メモ」固定、以降は各従業員の note）
      const memoRow = [...colMeta.emps.map(e => (e.note || ''))];
      const dataWithMemo = [memoRow, ...data];  // 先頭に差し込み
      const myId = currentUser?.employee_id ?? null;
      const myEmail = (currentUser?.email || '').toLowerCase();
      const myIdxInEmps = colMeta.emps.findIndex(e =>
        (myId && String(e.id) === String(myId)) ||
        ((e?.email || '').toLowerCase() === myEmail)
      );
      const myCol = (myIdxInEmps >= 0) ? myIdxInEmps : null; // ← 0は日付列なので+1
      const host = document.getElementById('grid');
      host.innerHTML = '';
      
      // ← 行ヘッダ用のラベルを rows メタに詰める（0行目はメモ）
      const rowHeaderLabels = ['メモ', ...colMeta.rowLabels];  // 例: ['メモ','1AM','1PM',...]
      const rowsMeta = {};
      rowHeaderLabels.forEach((txt, i) => { rowsMeta[i] = { title: String(txt) }; });

      grid = jspreadsheet(host, {
        data: dataWithMemo,
        columns: columns.map(c => ({ ...c, readOnly:true })),
        rowHeaders: true,                 // 有効化だけする
        rows: rowsMeta,             // ★ ここで各行ヘッダのタイトルを設定
        freezeRows: 1,         // ← メモ行（先頭1行）を固定
        tableOverflow:true,
        tableHeight: '400px',
        tableWidth: '100%',     // ← 幅いっぱいに広げる
        editable: false,            // 全体を編集不可
        selectionCopy: true,        // コピーはOK
        // 編集系の保険
        oneditionstart: (inst, cell) => { try{ inst.closeEditor(cell, true); }catch{} return false; },
        onbeforechange: () => false,
        onbeforepaste:  () => false,
        onbeforeinsertrow: () => false,
        onbeforeinsertcolumn: () => false,
        onbeforedeleterow: () => false,
        onbeforedeletecolumn: () => false,
        allowInsertColumn:false, allowDeleteColumn:false,
        allowInsertRow:false, allowDeleteRow:false,
        editable:false, selectionCopy:true,
        updateTable: (el, cell, x, y, src, val) => {
          cell.classList.remove('ht-today','ht-sat','ht-sun','ht-holiday','memo-row','myself');
          cell.style.color = '';
          const memoOffset = 1;                 // 先頭にメモ行がある
          const dataRow = y - memoOffset;       // 実データに対応する行index（rowKeys用）
        
          // --- メモ行（y===0）は装飾だけ ---
          if (dataRow < 0) {
            cell.classList.add('memo-row');
            const text = (val || '').toString();
            if (x > 0 && text) shrinkToFit(cell, text, { base: 14, min: 10, maxLines: 3 });
            return;
          }
          
          // --- ここから通常データ行（rowKeys は dataRow を使う） ---
          const rk = colMeta.rowKeys[dataRow];
          if (!rk) return;
        
          // まず既存の休日系クラスを除去
          for (const c of ['ht-today','ht-sat','ht-sun','ht-holiday']) cell.classList.remove(c);
        
          // 土日祝・今日の色付け
          const classes = classesForYmd(rk.date);
          classes.forEach(c => cell.classList.add(c));
        
          // 「休/有/代/振」を含むセルは休日色
          const text = (val || '').toString();
          if (/[休有代振]/.test(text)) cell.classList.add('ht-holiday');
          
          // 自分の列を赤く（セル側）
          if (myCol != null && x === myCol) {
            cell.classList.add('myself');        // 強いCSSで赤
            cell.style.color = '#d32f2f';        // 競合対策の保険
          }
          
          // 縮小表示（データ列のみ）
          if (x > 0 && text) shrinkToFit(cell, text, { base: 14, min: 10, maxLines: 2 });
        }
      });
    }

    /* =============================== 部署・月のUI =============================== */
    function uniqueDepartments(){
      const set = new Map(); // 表示名の順を維持
      for(const e of employeesVisible){
        const dep = e.department || '';
        if(!set.has(dep)) set.set(dep, dep);
      }
      return Array.from(set.keys());
    }
    function fillDepartmentOptions(initDept){
      const sel = document.getElementById('deptSelect');
      sel.innerHTML = '';
      for(const dep of uniqueDepartments()){
        const op = document.createElement('option');
        op.value = dep; op.textContent = dep||'(未設定)';
        if (initDept && String(dep)===String(initDept)) op.selected = true;
        sel.appendChild(op);
      }
    }
    function fillMonthOptions(base=new Date()){
      const months = monthsAround(base, 3, 3);
      const sel = document.getElementById('monthSelect');
      sel.innerHTML = '';
      for(const ym of months){
        const op = document.createElement('option');
        op.value = ym; op.textContent = ym;
        if (ym===ymOf(base)) op.selected = true;
        sel.appendChild(op);
      }
    }

    /* =============================== クイック登録 =============================== */
    function toYMD(v){
      const pad = n => String(n).padStart(2,'0');
      if (!v) return null;
      if (v instanceof Date && !isNaN(v)) return `${v.getFullYear()}-${pad(v.getMonth()+1)}-${pad(v.getDate())}`;
      const s = String(v).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(s); if (!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      return null;
    }
    function normalizeHHMM(raw){
      const s=String(raw||'').trim(); if(!s) return null;
      if(/^[0-2]?\d:[0-5]\d$/.test(s)) return s.length===4? '0'+s : s;
      if(/^\d{4}$/.test(s)){ const hh=+s.slice(0,2), mm=+s.slice(2,4); if(hh>=0&&hh<=23&&mm>=0&&mm<=59) return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }
      return null;
    }

    async function ensureMyEmployeeId(){
      if(currentUser.employee_id) return currentUser.employee_id;
      const { data:{ session } } = await supabase.auth.getSession();
      if(!session) throw new Error('未ログイン');
      const { data, error } = await supabase.from('employees').select('id,email').eq('email', session.user.email).maybeSingle();
      if(error) throw error;
      if(!data) throw new Error('自分の従業員IDが見つかりません');
      currentUser.employee_id = data.id;
      return data.id;
    }

    async function saveQuick(){
      const date = toYMD(document.getElementById('qDate').value);
      if(!date){ alert('日付は YYYY-MM-DD で入力してください'); return; }
      const am = String(document.getElementById('qAm').value||'').trim();
      const pm = String(document.getElementById('qPm').value||'').trim();

      const employee_id = await ensureMyEmployeeId();
      const upserts=[], deletes=[];
      if(am) upserts.push({ employee_id, date, slot:'am', place:am }); else deletes.push({ employee_id, date, slot:'am' });
      if(pm) upserts.push({ employee_id, date, slot:'pm', place:pm }); else deletes.push({ employee_id, date, slot:'pm' });

      const { access_token: token } = await getActiveSessionOrLogout();

      // 送信
      if(deletes.length){
        const r=await fetch(`${SUPABASE_URL}/functions/v1/schedules-delete`,{
          method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
          body:JSON.stringify(deletes)
        }); const j=await r.json().catch(()=>({})); if(!r.ok || !j?.ok) { alert('削除失敗'); return; }
      }
      if(upserts.length){
        const r=await fetch(`${SUPABASE_URL}/functions/v1/schedules-upsert`,{
          method:'POST', headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
          body:JSON.stringify(upserts)
        }); const j=await r.json().catch(()=>({})); if(!r.ok || !j?.ok) { alert('保存失敗'); return; }
      }

      // キャッシュ更新＆当月再描画
      const ym = date.slice(0,7);
      monthCache.delete(ym);
      const monthSel = document.getElementById('monthSelect');
      if (monthSel.value === ym) {
        await renderGrid(ym, document.getElementById('deptSelect').value);
      }
      alert('更新しました');
    }

    /* =============================== 起動 =============================== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      // UI 初期組み立て
      fillMonthOptions(new Date());
      $('#qDate').value = todayYmd();

      // 認証状態に応じた表示（モバイルは簡略：未ログインならSupabaseのメール/パスでログイン）
      const { data:{ session } } = await supabase.auth.getSession();
      $('#loginPanel').style.display = session ? 'none' : '';
      $('#appPanel').style.display   = session ? '' : 'none';

      let sessionObj = null;
      try {
        sessionObj = await getActiveSessionOrLogout();  // 失効ならここでモーダル表示&throw
      } catch {
        // 既に showLoginModal 済み。以降の初期描画は止める
      }
      $('#loginPanel').style.display = sessionObj ? 'none' : '';
      $('#appPanel').style.display   = sessionObj ? '' : 'none';

      if (sessionObj) {
        await loadCurrentUserAndEmployees();
        fillDepartmentOptions(currentUser.department);
        const ym = $('#monthSelect').value;
        await preloadHolidaysForMonths([ym]);
        await renderGrid(ym, $('#deptSelect').value);
      }

      // ログイン
      $('#loginBtn').addEventListener('click', async ()=>{
        const email = $('#email').value.trim();
        const password = $('#password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if(error){ alert('ログイン失敗: '+error.message); return; }
        location.reload();
      });
      // ログアウトボタン処理
      $('#logoutBtn').addEventListener('click', async () => {
        try { await supabase.auth.signOut({ scope: 'local' }); } catch {}
        location.reload();
      });
      // 更新ボタン（F5と同じ）
      $('#refreshBtn').addEventListener('click', () => {
        location.reload();   // ページ全体をリロード
      });
      // クイック登録保存
      $('#quickSaveBtn').addEventListener('click', saveQuick);

      // 部署変更
      $('#deptSelect').addEventListener('change', async ()=>{
        await renderGrid($('#monthSelect').value, $('#deptSelect').value);
      });

      // 月変更
      $('#monthSelect').addEventListener('change', async ()=>{
        await renderGrid($('#monthSelect').value, $('#deptSelect').value);
      });
      
      // クイック登録 開閉トグル
      $('#toggleQuickBtn').addEventListener('click', () => {
        const panel = $('#quickPanel');
        const btn = $('#toggleQuickBtn');
        const open = panel.style.display !== 'none';
        panel.style.display = open ? 'none' : '';
        btn.textContent = open ? '＋' : '－';
      });
    });
    /* ==== Help modal (mobile) ==== */
    function openHelpModal(){
      const m = document.getElementById('helpModal');
      m?.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
    function closeHelpModal(){
      const m = document.getElementById('helpModal');
      m?.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      if (t.id === 'helpBtn' || t.hasAttribute('data-help-close')) {
        e.preventDefault();
      }
      if (t.id === 'helpBtn') openHelpModal();
      if (t.hasAttribute('data-help-close')) closeHelpModal();
    });
  </script>
</head>
<body>
  <header>
    <div class="bar">
      <strong>行動予定表（モバイル）</strong>
      <span class="grow"></span>
      <button id="refreshBtn" class="btn">⟳</button>
      <button id="helpBtn" class="btn">？</button>
      <button id="logoutBtn" class="btn">✕</button>
    </div>
    <div class="bar">
      <label class="muted">部署</label>
      <select id="deptSelect" class="grow"></select>
      <label class="muted">月</label>
      <select id="monthSelect"></select>
    </div>
  </header>

  <!-- 未ログイン時 -->
  <div id="loginPanel" class="panel" style="display:none;">
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com" inputmode="email" autocomplete="username" />
      <input id="password" type="password" placeholder="パスワード" autocomplete="current-password" />
      <button id="loginBtn" class="btn-primary">ログイン</button>
    </div>
    <p class="muted">※ 社内アカウントでログインしてください</p>
  </div>

  <!-- アプリ本体 -->
  <div id="appPanel" style="display:none;">
    <!-- クイック登録（自分のみ／会社予定登録は無し） -->
    <div class="panel">
      <div class="row">
        <button id="toggleQuickBtn" class="btn">＋</button>
        <button id="quickSaveBtn" class="btn-primary">予定登録</button>
      </div>
      <!-- ↓ ここを最初は非表示 -->
      <div id="quickPanel" style="display:none; margin-top:8px;">
        <div class="row">
          <label>日付</label>
          <input id="qDate" type="date" />
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="qAm" type="text" placeholder="午前の予定（例：現場A）" style="flex:1 1 200px;" />
          <input id="qPm" type="text" placeholder="午後の予定（例：現場B）" style="flex:1 1 200px;" />
        </div>
      </div>
    </div>

    <!-- スケジュール（表示のみ、x/y入替） -->
    <div class="panel">
      <div id="grid"></div>
    </div>
  </div>
  <div id="helpModal" class="help-modal" aria-hidden="true">
    <div class="help-backdrop" data-help-close></div>
    <div class="help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <button class="help-close" type="button" title="閉じる" data-help-close>&times;</button>
      <h2 id="helpTitle">使い方（モバイル）</h2>
      <div id="helpBody" class="help-body">
        <p>※URLや仕様は変更になる可能性があります<br>
        ・PC版との違い<br>
        スケジュールの表示は閲覧のみで編集は不可。<br>
        表示は部署・月を選択してください。<br>
        PC版とは縦横が入れ替わっています。<br>
        スケジュールの編集登録は自分の分のみ可能<br>
        メモ欄は編集不可<br>
        上部クイック登録からのみ編集可能です<br>
        ブラウザ下部のボタンからホーム画面に追加することで<br>
        上下のノッチ・URL欄が無い状態での表示が可能です</p>
      </div>
    </div>
  <footer></footer>
</body>
</html>
